

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Caching &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Caching</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/working_with_aiida/caching.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="caching">
<span id="id1"></span><h1>Caching<a class="headerlink" href="#caching" title="Permalink to this headline">¶</a></h1>
<div class="section" id="enabling-caching">
<h2>Enabling caching<a class="headerlink" href="#enabling-caching" title="Permalink to this headline">¶</a></h2>
<p>There are numerous reasons why you may need to re-run calculations you’ve already done before.
Since AiiDA stores the full provenance of each calculation, it can detect whether a calculation has been run before and reuse its outputs without wasting computational resources.
This is what we mean by <strong>caching</strong> in AiiDA.</p>
<p>Caching is <strong>not enabled by default</strong>.
In order to enable caching for your AiiDA profile (here called <code class="docutils literal notranslate"><span class="pre">aiida2</span></code>), place the following <code class="docutils literal notranslate"><span class="pre">cache_config.yml</span></code> file in your <code class="docutils literal notranslate"><span class="pre">.aiida</span></code> configuration folder:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">aiida2</span><span class="p">:</span>
  <span class="nt">default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
</pre></div>
</div>
<p>From this point onwards, when you launch a new calculation, AiiDA will compare its hash (depending both on the type of calculation and its inputs, see <a class="reference internal" href="#caching-matches"><span class="std std-ref">How are nodes hashed?</span></a>) against other calculations already present in your database.
If another calculation with the same hash is found, AiiDA will reuse its results without repeating the actual calculation.</p>
<p>In order to ensure that the provenance graph with and without caching is the same, AiiDA creates both a new calculation node and a copy of the output data nodes as shown in <code class="xref std std-numref docutils literal notranslate"><span class="pre">fig_caching</span></code>.</p>
<div class="figure align-center" id="id2">
<span id="fig-caching"></span><a class="reference internal image-reference" href="../_images/caching.png"><img alt="../_images/caching.png" src="../_images/caching.png" style="height: 350px;" /></a>
<p class="caption"><span class="caption-text">When reusing the results of a calculation <strong>C</strong> for a new calculation <strong>C’</strong>, AiiDA simply makes a copy of the result nodes and links them up as usual.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>AiiDA uses the <em>hashes</em> of the input nodes <strong>D1</strong> and <strong>D2</strong> when searching the calculation cache.
I.e. if the input of <strong>C’</strong> were new nodes <strong>D1’</strong> and <strong>D2’</strong> with the same content (hash) as <strong>D1</strong>, <strong>D2</strong>, the cache would trigger as well.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Caching is <strong>not</strong> implemented at the WorkChain/workfunction level (see <a class="reference internal" href="#caching-limitations"><span class="std std-ref">Limitations</span></a> for details).</p>
</div>
</div>
<div class="section" id="how-are-nodes-hashed">
<span id="caching-matches"></span><h2>How are nodes hashed?<a class="headerlink" href="#how-are-nodes-hashed" title="Permalink to this headline">¶</a></h2>
<p><em>Hashing</em> is turned on by default, i.e. all nodes in AiiDA are hashed (see also <a class="reference internal" href="../developer_guide/core/caching.html#devel-controlling-hashing"><span class="std std-ref">Controlling hashing</span></a>).
The hash of a <code class="docutils literal notranslate"><span class="pre">Data</span></code> node is computed from:</p>
<ul class="simple">
<li><p>all attributes of the node, except the <code class="docutils literal notranslate"><span class="pre">_updatable_attributes</span></code> and <code class="docutils literal notranslate"><span class="pre">_hash_ignored_attributes</span></code></p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">__version__</span></code> of the package which defined the node class</p></li>
<li><p>the content of the repository folder of the node</p></li>
<li><p>the UUID of the computer, if the node is associated with one</p></li>
</ul>
<p>The hash of a <a class="reference internal" href="../apidoc/aiida.orm.html#aiida.orm.ProcessNode" title="aiida.orm.ProcessNode"><code class="xref py py-class docutils literal notranslate"><span class="pre">ProcessNode</span></code></a> includes, on top of this, the hashes of all of its input <code class="docutils literal notranslate"><span class="pre">Data</span></code> nodes.</p>
<p>Once a node is stored in the database, its hash is stored in the <code class="docutils literal notranslate"><span class="pre">_aiida_hash</span></code> extra, and this extra is used to find matching nodes.
If a node of the same class with the same hash already exists in the database, this is considered a cache match.</p>
<p>Use the <a class="reference internal" href="../apidoc/aiida.orm.nodes.html#aiida.orm.nodes.Node.get_hash" title="aiida.orm.nodes.Node.get_hash"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_hash()</span></code></a> method to check the hash of any node.</p>
<p>In order to figure out why a calculation is <em>not</em> being reused, the <a class="reference internal" href="../apidoc/aiida.orm.nodes.html#aiida.orm.nodes.Node._get_objects_to_hash" title="aiida.orm.nodes.Node._get_objects_to_hash"><code class="xref py py-meth docutils literal notranslate"><span class="pre">_get_objects_to_hash()</span></code></a> method may be useful:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="n">calc</span><span class="o">=</span><span class="n">load_node</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>

<span class="gp">In [2]: </span><span class="n">calc</span><span class="o">.</span><span class="n">get_hash</span><span class="p">()</span>
<span class="gh">Out[2]: </span><span class="go">&#39;62eca804967c9428bdbc11c692b7b27a59bde258d9971668e19ccf13a5685eb8&#39;</span>

<span class="gp">In [3]: </span><span class="n">calc</span><span class="o">.</span><span class="n">_get_objects_to_hash</span><span class="p">()</span>
<span class="gh">Out[3]: </span><span class="go"></span>
<span class="go">[&#39;1.0.0b4&#39;,</span>
<span class="go"> {&#39;resources&#39;: {&#39;num_machines&#39;: 2, &#39;default_mpiprocs_per_machine&#39;: 28},</span>
<span class="go">  &#39;parser_name&#39;: &#39;cp2k&#39;,</span>
<span class="go">  &#39;linkname_retrieved&#39;: &#39;retrieved&#39;},</span>
<span class="go"> &lt;aiida.common.folders.Folder at 0x1171b9a20&gt;,</span>
<span class="go"> &#39;6850dc88-0949-482e-bba6-8b11205aec11&#39;,</span>
<span class="go"> {&#39;code&#39;: &#39;f6bd65b9ca3a5f0cf7d299d9cfc3f403d32e361aa9bb8aaa5822472790eae432&#39;,</span>
<span class="go">  &#39;parameters&#39;: &#39;2c20fdc49672c3505cebabacfb9b1258e71e7baae5940a80d25837bee0032b59&#39;,</span>
<span class="go">  &#39;structure&#39;: &#39;c0f1c1d1bbcfc7746dcf7d0d675904c62a5b1759d37db77b564948fa5a788769&#39;,</span>
<span class="go">  &#39;parent_calc_folder&#39;: &#39;e375178ceeffcde086546d3ddbce513e0527b5fa99993091b2837201ad96569c&#39;}]</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="class-level">
<h3>Class level<a class="headerlink" href="#class-level" title="Permalink to this headline">¶</a></h3>
<p>Besides an on/off switch per profile, the <code class="docutils literal notranslate"><span class="pre">.aiida/cache_config.yml</span></code> provides control over caching at the level of specific calculations using their corresponding entry point strings (see the output of <code class="docutils literal notranslate"><span class="pre">verdi</span> <span class="pre">plugin</span> <span class="pre">list</span> <span class="pre">aiida.calculations</span></code>):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">profile-name</span><span class="p">:</span>
  <span class="nt">default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="nt">enabled</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">aiida.calculations:quantumespresso.pw</span>
  <span class="nt">disabled</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">aiida.calculations:templatereplacer</span>
</pre></div>
</div>
<p>In this example, caching is disabled by default, but explicitly enabled for calculaions of the <code class="docutils literal notranslate"><span class="pre">PwCalculation</span></code> class, identified by the <code class="docutils literal notranslate"><span class="pre">aiida.calculations:quantumespresso.pw</span></code> entry point string.
It also shows how to disable caching for particular calculations (which has no effect here due to the profile-wide default).</p>
<p>For calculations which do not have an entry point, you need to specify the fully qualified Python name instead. For example, the <code class="docutils literal notranslate"><span class="pre">seekpath_structure_analysis</span></code> calcfunction defined in <code class="docutils literal notranslate"><span class="pre">aiida_quantumespresso.workflows.functions.seekpath_structure_analysis</span></code> is labelled as <code class="docutils literal notranslate"><span class="pre">aiida_quantumespresso.workflows.functions.seekpath_structure_analysis.seekpath_structure_analysis</span></code>. From an existing <a class="reference internal" href="../apidoc/aiida.orm.nodes.process.calculation.html#aiida.orm.nodes.process.calculation.CalculationNode" title="aiida.orm.nodes.process.calculation.CalculationNode"><code class="xref py py-class docutils literal notranslate"><span class="pre">CalculationNode</span></code></a>, you can get the identifier string through the <code class="docutils literal notranslate"><span class="pre">process_type</span></code> attribute.</p>
<p>The caching configuration also accepts <code class="docutils literal notranslate"><span class="pre">*</span></code> wildcards. For example, the following configuration enables caching for all calculation entry points defined by <code class="docutils literal notranslate"><span class="pre">aiida-quantumespresso</span></code>, and the <code class="docutils literal notranslate"><span class="pre">seekpath_structure_analysis</span></code> calcfunction. Note that the <code class="docutils literal notranslate"><span class="pre">*.seekpath_structure_analysis</span></code> entry needs to be quoted, because it starts with <code class="docutils literal notranslate"><span class="pre">*</span></code> which is a special character in YAML.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">profile-name</span><span class="p">:</span>
  <span class="nt">default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="nt">enabled</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">aiida.calculations:quantumespresso.*</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;*.seekpath_structure_analysis&#39;</span>
</pre></div>
</div>
<p>You can even override a wildcard with a more specific entry. The following configuration enables caching for all <code class="docutils literal notranslate"><span class="pre">aiida.calculation</span></code> entry points, except those of <code class="docutils literal notranslate"><span class="pre">aiida-quantumespresso</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">profile-name</span><span class="p">:</span>
  <span class="nt">default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="nt">enabled</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">aiida.calculations:*</span>
  <span class="nt">disabled</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">aiida.calculations:quantumespresso.*</span>
</pre></div>
</div>
</div>
<div class="section" id="instance-level">
<h3>Instance level<a class="headerlink" href="#instance-level" title="Permalink to this headline">¶</a></h3>
<p>Even when caching is turned off for a given calculation type, you can enable it on a case-by-case basis by using the <a class="reference internal" href="../apidoc/aiida.manage.html#aiida.manage.caching.enable_caching" title="aiida.manage.caching.enable_caching"><code class="xref py py-class docutils literal notranslate"><span class="pre">enable_caching</span></code></a> context manager for testing purposes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">aiida.manage.caching</span> <span class="kn">import</span> <span class="n">enable_caching</span>
<span class="k">with</span> <span class="n">enable_caching</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="s1">&#39;aiida.calculations:templatereplacer&#39;</span><span class="p">):</span>
   <span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This affects only the current python interpreter and won’t change the behavior of the daemon workers.
This means that this technique is only useful when using <a class="reference internal" href="../apidoc/aiida.engine.html#aiida.engine.run" title="aiida.engine.run"><code class="xref py py-class docutils literal notranslate"><span class="pre">run</span></code></a>, and <strong>not</strong> with <a class="reference internal" href="../apidoc/aiida.engine.html#aiida.engine.submit" title="aiida.engine.submit"><code class="xref py py-class docutils literal notranslate"><span class="pre">submit</span></code></a>.</p>
</div>
<p>If you suspect a node is being reused in error (e.g. during development), you can also manually <em>prevent</em> a specific node from being reused:</p>
<ol class="arabic">
<li><p>Load one of the nodes you suspect to be a clone.
Check that <a class="reference internal" href="../apidoc/aiida.orm.nodes.html#aiida.orm.nodes.Node.get_cache_source" title="aiida.orm.nodes.Node.get_cache_source"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_cache_source()</span></code></a> returns a UUID.
If it returns <cite>None</cite>, the node was not cloned.</p></li>
<li><p>Clear the hashes of all nodes that are considered identical to this node:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get_all_same_nodes</span><span class="p">():</span>
    <span class="n">n</span><span class="o">.</span><span class="n">clear_hash</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Run your calculation again. The node in question should no longer be reused.</p></li>
</ol>
</div>
</div>
<div class="section" id="limitations">
<span id="caching-limitations"></span><h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Workflow nodes are not cached. In the current design this follows from the requirement that the provenance graph be independent of whether caching is enabled or not:</p>
<ul class="simple">
<li><p><strong>Calculation nodes:</strong> Calculation nodes can have data inputs and create new data nodes as outputs.
In order to make it look as if a cloned calculation produced its own outputs, the output nodes are copied and linked as well.</p></li>
<li><p><strong>Workflow nodes:</strong> Workflows differ from calculations in that they can <em>return</em> an input node or an output node created by a calculation.
Since caching does not care about the <em>identity</em> of input nodes but only their <em>content</em>, it is not straightforward to figure out which node to return in a cached workflow.</p></li>
</ul>
<p>For the moment, this limitation is acceptable since the runtime of AiiDA WorkChains is usually dominated by expensive calculations, which are covered by the current caching mechanism.</p>
</li>
<li><p>The caching mechanism for calculations <em>should</em> trigger only when the inputs and the calculation to be performed are exactly the same.
While AiiDA’s hashes include the version of the python package containing the calculation/data classes, it cannot detect cases where the underlying python code was changed without increasing the version number.
Another edge case would be if the parser lives in a different python package than the calculation (calculation nodes store the name of the parser used but not the version of the package containing the parser).</p></li>
</ol>
<p>Finally, while caching saves unnecessary computations, it does not save disk space: The output nodes of the cached calculation are full copies of the original outputs.
The plan is to add data deduplication as a global feature at the repository and database level (independent of caching).</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>