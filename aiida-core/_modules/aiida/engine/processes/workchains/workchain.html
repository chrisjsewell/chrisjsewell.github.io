

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.engine.processes.workchains.workchain &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
        <script src="../../../../../_static/togglebutton.js"></script>
        <script src="../../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.engine.processes.workchains.workchain</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.engine.processes.workchains.workchain</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Components for the WorkChain concept of the workflow engine.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">import</span> <span class="nn">plumpy</span>
<span class="kn">from</span> <span class="nn">plumpy</span> <span class="kn">import</span> <span class="n">auto_persist</span><span class="p">,</span> <span class="n">Wait</span><span class="p">,</span> <span class="n">Continue</span>
<span class="kn">from</span> <span class="nn">plumpy.workchains</span> <span class="kn">import</span> <span class="n">if_</span><span class="p">,</span> <span class="n">while_</span><span class="p">,</span> <span class="n">return_</span><span class="p">,</span> <span class="n">_PropagateReturn</span>

<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.common.extendeddicts</span> <span class="kn">import</span> <span class="n">AttributeDict</span>
<span class="kn">from</span> <span class="nn">aiida.common.lang</span> <span class="kn">import</span> <span class="n">override</span>
<span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">WorkChainNode</span>
<span class="kn">from</span> <span class="nn">aiida.orm.utils</span> <span class="kn">import</span> <span class="n">load_node</span>

<span class="kn">from</span> <span class="nn">..exit_code</span> <span class="kn">import</span> <span class="n">ExitCode</span>
<span class="kn">from</span> <span class="nn">..process_spec</span> <span class="kn">import</span> <span class="n">ProcessSpec</span>
<span class="kn">from</span> <span class="nn">..process</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">ProcessState</span>
<span class="kn">from</span> <span class="nn">.awaitable</span> <span class="kn">import</span> <span class="n">AwaitableTarget</span><span class="p">,</span> <span class="n">AwaitableAction</span><span class="p">,</span> <span class="n">construct_awaitable</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WorkChain&#39;</span><span class="p">,</span> <span class="s1">&#39;if_&#39;</span><span class="p">,</span> <span class="s1">&#39;while_&#39;</span><span class="p">,</span> <span class="s1">&#39;return_&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WorkChainSpec</span><span class="p">(</span><span class="n">ProcessSpec</span><span class="p">,</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">WorkChainSpec</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="WorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain">[docs]</a><span class="nd">@auto_persist</span><span class="p">(</span><span class="s1">&#39;_awaitables&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">WorkChain</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The `WorkChain` class is the principle component to implement workflows in AiiDA.&quot;&quot;&quot;</span>

    <span class="n">_node_class</span> <span class="o">=</span> <span class="n">WorkChainNode</span>
    <span class="n">_spec_class</span> <span class="o">=</span> <span class="n">WorkChainSpec</span>
    <span class="n">_STEPPER_STATE</span> <span class="o">=</span> <span class="s1">&#39;stepper_state&#39;</span>
    <span class="n">_CONTEXT</span> <span class="o">=</span> <span class="s1">&#39;CONTEXT&#39;</span>

<div class="viewcode-block" id="WorkChain.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enable_persistence</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a WorkChain instance.</span>

<span class="sd">        Construct the instance only if it is a sub class of `WorkChain`, otherwise raise `InvalidOperation`.</span>

<span class="sd">        :param inputs: work chain inputs</span>
<span class="sd">        :type inputs: dict</span>

<span class="sd">        :param logger: aiida logger</span>
<span class="sd">        :type logger: :class:`logging.Logger`</span>

<span class="sd">        :param runner: work chain runner</span>
<span class="sd">        :type: :class:`aiida.engine.runners.Runner`</span>

<span class="sd">        :param enable_persistence: whether to persist this work chain</span>
<span class="sd">        :type enable_persistence: bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">WorkChain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">(</span><span class="s1">&#39;cannot construct or launch a base `WorkChain` class.&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">runner</span><span class="p">,</span> <span class="n">enable_persistence</span><span class="o">=</span><span class="n">enable_persistence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stepper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">AttributeDict</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ctx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get context.</span>

<span class="sd">        :rtype: :class:`aiida.common.extendeddicts.AttributeDict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span>

<div class="viewcode-block" id="WorkChain.save_instance_state"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.save_instance_state">[docs]</a>    <span class="nd">@override</span>
    <span class="k">def</span> <span class="nf">save_instance_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_state</span><span class="p">,</span> <span class="n">save_context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save instance stace.</span>

<span class="sd">        :param out_state: state to save in</span>

<span class="sd">        :param save_context:</span>
<span class="sd">        :type save_context: :class:`!plumpy.persistence.LoadSaveContext`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_instance_state</span><span class="p">(</span><span class="n">out_state</span><span class="p">,</span> <span class="n">save_context</span><span class="p">)</span>
        <span class="c1"># Save the context</span>
        <span class="n">out_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span>

        <span class="c1"># Ask the stepper to save itself</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_STEPPER_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepper</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="WorkChain.load_instance_state"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.load_instance_state">[docs]</a>    <span class="nd">@override</span>
    <span class="k">def</span> <span class="nf">load_instance_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_state</span><span class="p">,</span> <span class="n">load_context</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_instance_state</span><span class="p">(</span><span class="n">saved_state</span><span class="p">,</span> <span class="n">load_context</span><span class="p">)</span>
        <span class="c1"># Load the context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">saved_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT</span><span class="p">]</span>

        <span class="c1"># Recreate the stepper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stepper_state</span> <span class="o">=</span> <span class="n">saved_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_STEPPER_STATE</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stepper_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stepper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span><span class="o">.</span><span class="n">get_outline</span><span class="p">()</span><span class="o">.</span><span class="n">recreate_stepper</span><span class="p">(</span><span class="n">stepper_state</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_awaitables</span><span class="p">()</span></div>

<div class="viewcode-block" id="WorkChain.on_run"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.on_run">[docs]</a>    <span class="k">def</span> <span class="nf">on_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_stepper_state_info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepper</span><span class="p">))</span></div>

<div class="viewcode-block" id="WorkChain.insert_awaitable"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.insert_awaitable">[docs]</a>    <span class="k">def</span> <span class="nf">insert_awaitable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">awaitable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert an awaitable that should be terminated before before continuing to the next step.</span>

<span class="sd">        :param awaitable: the thing to await</span>
<span class="sd">        :type awaitable: :class:`aiida.engine.processes.workchains.awaitable.Awaitable`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_process_status</span><span class="p">()</span></div>

<div class="viewcode-block" id="WorkChain.remove_awaitable"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.remove_awaitable">[docs]</a>    <span class="k">def</span> <span class="nf">remove_awaitable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">awaitable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove an awaitable.</span>

<span class="sd">        Precondition: must be an awaitable that was previously inserted.</span>

<span class="sd">        :param awaitable: the awaitable to remove</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_process_status</span><span class="p">()</span></div>

<div class="viewcode-block" id="WorkChain.to_context"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.to_context">[docs]</a>    <span class="k">def</span> <span class="nf">to_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a dictionary of awaitables to the context.</span>

<span class="sd">        This is a convenience method that provides syntactic sugar, for a user to add multiple intersteps that will</span>
<span class="sd">        assign a certain value to the corresponding key in the context of the work chain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">awaitable</span> <span class="o">=</span> <span class="n">construct_awaitable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">awaitable</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_awaitable</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkChain._update_process_status"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain._update_process_status">[docs]</a>    <span class="k">def</span> <span class="nf">_update_process_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the process status with a message accounting the current sub processes that we are waiting for.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Waiting for child processes: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_process_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_process_status</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkChain.run"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.run">[docs]</a>    <span class="nd">@override</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span><span class="o">.</span><span class="n">get_outline</span><span class="p">()</span><span class="o">.</span><span class="n">create_stepper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_step</span><span class="p">()</span></div>

<div class="viewcode-block" id="WorkChain._do_step"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain._do_step">[docs]</a>    <span class="k">def</span> <span class="nf">_do_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the next step in the outline and return the result.</span>

<span class="sd">        If the stepper returns a non-finished status and the return value is of type ToContext, the contents of the</span>
<span class="sd">        ToContext container will be turned into awaitables if necessary. If any awaitables were created, the process</span>
<span class="sd">        will enter in the Wait state, otherwise it will go to Continue. When the stepper returns that it is done, the</span>
<span class="sd">        stepper result will be converted to None and returned, unless it is an integer or instance of ExitCode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.context</span> <span class="kn">import</span> <span class="n">ToContext</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">finished</span><span class="p">,</span> <span class="n">stepper_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepper</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">_PropagateReturn</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">finished</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">exit_code</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set result to None unless stepper_result was non-zero positive integer or ExitCode with similar status</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stepper_result</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">stepper_result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">ExitCode</span><span class="p">(</span><span class="n">stepper_result</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stepper_result</span><span class="p">,</span> <span class="n">ExitCode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">stepper_result</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">stepper_result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If the stepper said we are finished or the result is an ExitCode, we exit by returning</span>
        <span class="k">if</span> <span class="n">finished</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ExitCode</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stepper_result</span><span class="p">,</span> <span class="n">ToContext</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_context</span><span class="p">(</span><span class="o">**</span><span class="n">stepper_result</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_step</span><span class="p">,</span> <span class="s1">&#39;Waiting before next step&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Continue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_step</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkChain._store_nodes"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain._store_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">_store_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recurse through a data structure and store any unstored nodes that are found along the way</span>

<span class="sd">        :param data: a data structure potentially containing unstored nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store_nodes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store_nodes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkChain.on_exiting"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.on_exiting">[docs]</a>    <span class="nd">@override</span>
    <span class="k">def</span> <span class="nf">on_exiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that any unstored nodes in the context are stored, before the state is exited</span>

<span class="sd">        After the state is exited the next state will be entered and if persistence is enabled, a checkpoint will</span>
<span class="sd">        be saved. If the context contains unstored nodes, the serialization necessary for checkpointing will fail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_exiting</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="c1"># An uncaught exception here will have bizarre and disastrous consequences</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;exception in _store_nodes called in on_exiting&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkChain.on_wait"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.on_wait">[docs]</a>    <span class="k">def</span> <span class="nf">on_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">awaitables</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_wait</span><span class="p">(</span><span class="n">awaitables</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_awaitables</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkChain.action_awaitables"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.action_awaitables">[docs]</a>    <span class="k">def</span> <span class="nf">action_awaitables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle the awaitables that are currently registered with the work chain</span>

<span class="sd">        Depending on the class type of the awaitable&#39;s target a different callback</span>
<span class="sd">        function will be bound with the awaitable and the runner will be asked to</span>
<span class="sd">        call it when the target is completed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">awaitable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">awaitable</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">AwaitableTarget</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">:</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_process_finished</span><span class="p">,</span> <span class="n">awaitable</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">call_on_calculation_finish</span><span class="p">(</span><span class="n">awaitable</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="s2">&quot;invalid awaitable target &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">awaitable</span><span class="o">.</span><span class="n">target</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkChain.on_process_finished"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.WorkChain.on_process_finished">[docs]</a>    <span class="k">def</span> <span class="nf">on_process_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">awaitable</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback function called by the runner when the process instance identified by pk is completed.</span>

<span class="sd">        The awaitable will be effectuated on the context of the work chain and removed from the internal list. If all</span>
<span class="sd">        awaitables have been dealt with, the work chain process is resumed.</span>

<span class="sd">        :param awaitable: an Awaitable instance</span>
<span class="sd">        :param pk: the pk of the awaitable&#39;s target</span>
<span class="sd">        :type pk: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">MultipleObjectsError</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotExistent</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;provided pk&lt;</span><span class="si">{}</span><span class="s1">&gt; could not be resolved to a valid Node instance&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">awaitable</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="n">entry</span><span class="o">.</span><span class="n">link_label</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">node</span>

        <span class="k">if</span> <span class="n">awaitable</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">AwaitableAction</span><span class="o">.</span><span class="n">ASSIGN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="n">awaitable</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">awaitable</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">AwaitableAction</span><span class="o">.</span><span class="n">APPEND</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">awaitable</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">&quot;invalid awaitable action &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">awaitable</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remove_awaitable</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">WAITING</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_awaitables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>