

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.restapi.run_api &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/togglebutton.js"></script>
        <script src="../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.restapi.run_api</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.restapi.run_api</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="c1"># pylint: disable=inconsistent-return-statements</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">It defines the method with all required parameters to run restapi locally.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">aiida.common.warnings</span> <span class="kn">import</span> <span class="n">AiidaDeprecationWarning</span>
<span class="kn">from</span> <span class="nn">.common.config</span> <span class="kn">import</span> <span class="n">CLI_DEFAULTS</span><span class="p">,</span> <span class="n">APP_CONFIG</span><span class="p">,</span> <span class="n">API_CONFIG</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">api_classes</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;run_api&#39;</span><span class="p">,</span> <span class="s1">&#39;configure_api&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="run_api"><a class="viewcode-back" href="../../../apidoc/aiida.restapi.html#aiida.restapi.run_api.run_api">[docs]</a><span class="k">def</span> <span class="nf">run_api</span><span class="p">(</span><span class="n">flask_app</span><span class="o">=</span><span class="n">api_classes</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">flask_api</span><span class="o">=</span><span class="n">api_classes</span><span class="o">.</span><span class="n">AiidaApi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a flask.Flask instance and runs it.</span>

<span class="sd">    :param flask_app: Class inheriting from flask app class</span>
<span class="sd">    :type flask_app: :py:class:`flask.Flask`</span>
<span class="sd">    :param flask_api: flask_restful API class to be used to wrap the app</span>
<span class="sd">    :type flask_api: :py:class:`flask_restful.Api`</span>
<span class="sd">    :param hostname: hostname to run app on (only when using built-in server)</span>
<span class="sd">    :param port: port to run app on (only when using built-in server)</span>
<span class="sd">    :param config: directory containing the config.py file used to configure the RESTapi</span>
<span class="sd">    :param catch_internal_server:  If true, catch and print all inter server errors</span>
<span class="sd">    :param debug: enable debugging</span>
<span class="sd">    :param wsgi_profile: use WSGI profiler middleware for finding bottlenecks in web application</span>
<span class="sd">    :param hookup: If true, hook up application to built-in server, else just return it. This parameter</span>
<span class="sd">        is deprecated as of AiiDA 1.2.1. If you don&#39;t intend to run the API (hookup=False) use `configure_api` instead.</span>

<span class="sd">    :returns: tuple (app, api) if hookup==False or runs app if hookup==True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hookup</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;hookup&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hookup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hookup</span> <span class="o">=</span> <span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;HOOKUP_APP&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>  <span class="c1"># pylint: disable=no-member</span>
            <span class="s1">&#39;Using the `hookup` parameter is deprecated since `v1.2.1` and will stop working in `v2.0.0`. &#39;</span>
            <span class="s1">&#39;To configure the app without running it, use `configure_api` instead.&#39;</span><span class="p">,</span> <span class="n">AiidaDeprecationWarning</span>
        <span class="p">)</span>

    <span class="n">hostname</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;HOST_NAME&#39;</span><span class="p">])</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;PORT&#39;</span><span class="p">])</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="n">APP_CONFIG</span><span class="p">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">])</span>

    <span class="n">app</span><span class="p">,</span> <span class="n">api</span> <span class="o">=</span> <span class="n">configure_api</span><span class="p">(</span><span class="n">flask_app</span><span class="p">,</span> <span class="n">flask_api</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hookup</span><span class="p">:</span>
        <span class="c1"># Run app through built-in werkzeug server</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * REST API running on http://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">API_CONFIG</span><span class="p">[</span><span class="s1">&#39;PREFIX&#39;</span><span class="p">]))</span>
        <span class="n">api</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">threaded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Return the app &amp; api without specifying port/host to be handled by an external server (e.g. apache).</span>
        <span class="c1"># Some of the user-defined configuration of the app is ineffective (only affects built-in server).</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">api</span><span class="p">)</span></div>


<div class="viewcode-block" id="configure_api"><a class="viewcode-back" href="../../../apidoc/aiida.restapi.html#aiida.restapi.run_api.configure_api">[docs]</a><span class="k">def</span> <span class="nf">configure_api</span><span class="p">(</span><span class="n">flask_app</span><span class="o">=</span><span class="n">api_classes</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">flask_api</span><span class="o">=</span><span class="n">api_classes</span><span class="o">.</span><span class="n">AiidaApi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configures a flask.Flask instance and returns it.</span>

<span class="sd">    :param flask_app: Class inheriting from flask app class</span>
<span class="sd">    :type flask_app: :py:class:`flask.Flask`</span>
<span class="sd">    :param flask_api: flask_restful API class to be used to wrap the app</span>
<span class="sd">    :type flask_api: :py:class:`flask_restful.Api`</span>
<span class="sd">    :param config: directory containing the config.py file used to configure the RESTapi</span>
<span class="sd">    :param catch_internal_server:  If true, catch and print all inter server errors</span>
<span class="sd">    :param wsgi_profile: use WSGI profiler middleware for finding bottlenecks in web application</span>

<span class="sd">    :returns: tuple (app, api)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Unpack parameters</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;CONFIG_DIR&#39;</span><span class="p">])</span>
    <span class="n">catch_internal_server</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;catch_internal_server&#39;</span><span class="p">,</span> <span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;CATCH_INTERNAL_SERVER&#39;</span><span class="p">])</span>
    <span class="n">wsgi_profile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;wsgi_profile&#39;</span><span class="p">,</span> <span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;WSGI_PROFILE&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown keyword arguments: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="c1"># Import the configuration file</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;config.py&#39;</span><span class="p">))</span>
    <span class="n">config_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">config_module</span><span class="p">)</span>

    <span class="c1"># Instantiate an app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">flask_app</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">catch_internal_server</span><span class="o">=</span><span class="n">catch_internal_server</span><span class="p">)</span>

    <span class="c1"># Apply default configuration</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">config_module</span><span class="o">.</span><span class="n">APP_CONFIG</span><span class="p">)</span>

    <span class="c1"># Allow cross-origin resource sharing</span>
    <span class="n">cors_prefix</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_module</span><span class="o">.</span><span class="n">API_CONFIG</span><span class="p">[</span><span class="s1">&#39;PREFIX&#39;</span><span class="p">])</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span><span class="n">cors_prefix</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;origins&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">}})</span>

    <span class="c1"># Configure the serializer</span>
    <span class="k">if</span> <span class="n">config_module</span><span class="o">.</span><span class="n">SERIALIZER_CONFIG</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">aiida.restapi.common.utils</span> <span class="kn">import</span> <span class="n">CustomJSONEncoder</span>
        <span class="n">app</span><span class="o">.</span><span class="n">json_encoder</span> <span class="o">=</span> <span class="n">CustomJSONEncoder</span>

    <span class="c1"># Set up WSGI profiler if requested</span>
    <span class="k">if</span> <span class="n">wsgi_profile</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">werkzeug.middleware.profiler</span> <span class="kn">import</span> <span class="n">ProfilerMiddleware</span>

        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">app</span><span class="o">.</span><span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">ProfilerMiddleware</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">,</span> <span class="n">restrictions</span><span class="o">=</span><span class="p">[</span><span class="mi">30</span><span class="p">])</span>

    <span class="c1"># Instantiate an Api by associating its app</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">flask_api</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">API_CONFIG</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">api</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>