

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.backends.manager &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/togglebutton.js"></script>
        <script src="../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../backends.html">aiida.backends</a> &raquo;</li>
        
      <li>aiida.backends.manager</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.backends.manager</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Module for settings and utilities to determine and set the database schema versions.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">exceptions</span>

<span class="n">SCHEMA_VERSION_KEY</span> <span class="o">=</span> <span class="s1">&#39;db|schemaversion&#39;</span>
<span class="n">SCHEMA_VERSION_DESCRIPTION</span> <span class="o">=</span> <span class="s1">&#39;Database schema version&#39;</span>

<span class="n">SCHEMA_GENERATION_KEY</span> <span class="o">=</span> <span class="s1">&#39;schema_generation&#39;</span>  <span class="c1"># The key to store the database schema generation in the settings table</span>
<span class="n">SCHEMA_GENERATION_DESCRIPTION</span> <span class="o">=</span> <span class="s1">&#39;Database schema generation&#39;</span>
<span class="n">SCHEMA_GENERATION_VALUE</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>  <span class="c1"># The current schema generation</span>

<span class="c1"># Mapping of schema generation onto a tuple of valid schema reset generation and `aiida-core` version number. Given the</span>
<span class="c1"># current code schema generation as the key, the first element of the tuple tells what schema generation the database</span>
<span class="c1"># should have to be able to reset the schema. If the generation of the database is correct, but the schema version of</span>
<span class="c1"># the database does not match the one required for the reset, it means the user first has to downgrade the `aiida-core`</span>
<span class="c1"># version and perform the latest migrations. The required version is provided by the tuples second element.</span>
<span class="n">SCHEMA_GENERATION_RESET</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;1.*&#39;</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">TEMPLATE_INVALID_SCHEMA_GENERATION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Database schema generation `</span><span class="si">{schema_generation_database}</span><span class="s2">` is incompatible with the required schema generation `</span><span class="si">{schema_generation_code}</span><span class="s2">`.</span>
<span class="s2">To migrate the database schema generation to the current one, run the following command:</span>

<span class="s2">    verdi -p </span><span class="si">{profile_name}</span><span class="s2"> database migrate</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TEMPLATE_INVALID_SCHEMA_VERSION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Database schema version `</span><span class="si">{schema_version_database}</span><span class="s2">` is incompatible with the required schema version `</span><span class="si">{schema_version_code}</span><span class="s2">`.</span>
<span class="s2">To migrate the database schema version to the current one, run the following command:</span>

<span class="s2">    verdi -p </span><span class="si">{profile_name}</span><span class="s2"> database migrate</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TEMPLATE_MIGRATE_SCHEMA_VERSION_INVALID_VERSION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Cannot migrate the database version from `</span><span class="si">{schema_version_database}</span><span class="s2">` to `</span><span class="si">{schema_version_code}</span><span class="s2">`.</span>
<span class="s2">The database version is ahead of the version of the code and downgrades of the database are not supported.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TEMPLATE_MIGRATE_SCHEMA_GENERATION_INVALID_GENERATION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Cannot migrate database schema generation from `</span><span class="si">{schema_generation_database}</span><span class="s2">` to `</span><span class="si">{schema_generation_code}</span><span class="s2">`.</span>
<span class="s2">This version of `aiida-core` can only migrate databases with schema generation `</span><span class="si">{schema_generation_reset}</span><span class="s2">`</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TEMPLATE_MIGRATE_SCHEMA_GENERATION_INVALID_VERSION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Cannot migrate database schema generation from `</span><span class="si">{schema_generation_database}</span><span class="s2">` to `</span><span class="si">{schema_generation_code}</span><span class="s2">`.</span>
<span class="s2">The current database version is `</span><span class="si">{schema_version_database}</span><span class="s2">` but `</span><span class="si">{schema_version_reset}</span><span class="s2">` is required for generation migration.</span>
<span class="s2">First install `aiida-core~=</span><span class="si">{aiida_core_version_reset}</span><span class="s2">` and migrate the database to the latest version.</span>
<span class="s2">After the database schema is migrated to version `</span><span class="si">{schema_version_reset}</span><span class="s2">` you can reinstall this version of `aiida-core` and migrate the schema generation.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">Setting</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Setting&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="SettingsManager"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.SettingsManager">[docs]</a><span class="k">class</span> <span class="nc">SettingsManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class to get, set and delete settings from the `DbSettings` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SettingsManager.get"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.SettingsManager.get">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the setting with the given key.</span>

<span class="sd">        :param key: the key identifying the setting</span>
<span class="sd">        :return: Setting</span>
<span class="sd">        :raises: `~aiida.common.exceptions.NotExistent` if the settings does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="SettingsManager.set"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.SettingsManager.set">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the settings with the given key.</span>

<span class="sd">        :param key: the key identifying the setting</span>
<span class="sd">        :param value: the value for the setting</span>
<span class="sd">        :param description: optional setting description</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="SettingsManager.delete"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.SettingsManager.delete">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the setting with the given key.</span>

<span class="sd">        :param key: the key identifying the setting</span>
<span class="sd">        :raises: `~aiida.common.exceptions.NotExistent` if the settings does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="BackendManager"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager">[docs]</a><span class="k">class</span> <span class="nc">BackendManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class to manage the database schema and environment.&quot;&quot;&quot;</span>

    <span class="n">_settings_manager</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BackendManager.get_settings_manager"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.get_settings_manager">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_settings_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an instance of the `SettingsManager`.</span>

<span class="sd">        :return: `SettingsManager`</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.load_backend_environment"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.load_backend_environment">[docs]</a>    <span class="k">def</span> <span class="nf">load_backend_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">validate_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the backend environment.</span>

<span class="sd">        :param profile: the profile whose backend environment to load</span>
<span class="sd">        :param validate_schema: boolean, if True, validate the schema first before loading the environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_backend_environment</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">validate_schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_schema</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span></div>

<div class="viewcode-block" id="BackendManager._load_backend_environment"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager._load_backend_environment">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_load_backend_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the backend environment.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.reset_backend_environment"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.reset_backend_environment">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">reset_backend_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the backend environment.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.migrate"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.migrate">[docs]</a>    <span class="k">def</span> <span class="nf">migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Migrate the database to the latest schema generation or version.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If the settings table does not exist, we are dealing with an empty database. We cannot perform the checks</span>
            <span class="c1"># because they rely on the settings table existing, so instead we do not validate but directly call method</span>
            <span class="c1"># `_migrate_database_version` which will perform the migration to create the initial schema.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_settings_manager</span><span class="p">()</span><span class="o">.</span><span class="n">validate_table_existence</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotExistent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_database_version</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">SCHEMA_GENERATION_VALUE</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_generation_database</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_schema_generation_for_migration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_database_generation</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_code</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_database</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_schema_version_for_migration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_database_version</span><span class="p">()</span></div>

<div class="viewcode-block" id="BackendManager._migrate_database_generation"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager._migrate_database_generation">[docs]</a>    <span class="k">def</span> <span class="nf">_migrate_database_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Migrate the database schema generation.</span>

<span class="sd">        .. warning:: this should NEVER be called directly because there is no validation performed on whether the</span>
<span class="sd">            current database schema generation and version can actually be migrated.</span>

<span class="sd">        This normally just consists out of setting the schema generation value, but depending on the backend more might</span>
<span class="sd">        be needed. In that case, this method should be overridden and call `super` first, followed by the additional</span>
<span class="sd">        logic that is required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_schema_generation_database</span><span class="p">(</span><span class="n">SCHEMA_GENERATION_VALUE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_schema_version_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_code</span><span class="p">())</span></div>

<div class="viewcode-block" id="BackendManager._migrate_database_version"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager._migrate_database_version">[docs]</a>    <span class="k">def</span> <span class="nf">_migrate_database_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Migrate the database to the current schema version.</span>

<span class="sd">        .. warning:: this should NEVER be called directly because there is no validation performed on whether the</span>
<span class="sd">            current database schema generation and version can actually be migrated.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.is_database_schema_ahead"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.is_database_schema_ahead">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">is_database_schema_ahead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether the database schema version is ahead of the code schema version.</span>

<span class="sd">        .. warning:: this will not check whether the schema generations are equal</span>

<span class="sd">        :return: boolean, True if the database schema version is ahead of the code schema version.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.get_schema_version_code"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.get_schema_version_code">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_schema_version_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the code schema version.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.get_schema_version_reset"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.get_schema_version_reset">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_schema_version_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_generation_code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return schema version the database should have to be able to automatically reset to code schema generation.</span>

<span class="sd">        :param schema_generation_code: the schema generation of the code.</span>
<span class="sd">        :return: schema version</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.get_schema_version_database"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.get_schema_version_database">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_schema_version_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the database schema version.</span>

<span class="sd">        :return: `distutils.version.LooseVersion` with schema version of the database</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.set_schema_version_database"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.set_schema_version_database">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_schema_version_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the database schema version.</span>

<span class="sd">        :param version: string with schema version to set</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BackendManager.get_schema_generation_database"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.get_schema_generation_database">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_generation_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the database schema generation.</span>

<span class="sd">        :return: `distutils.version.LooseVersion` with schema generation of the database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_settings_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SCHEMA_GENERATION_KEY</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">setting</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotExistent</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;1&#39;</span></div>

<div class="viewcode-block" id="BackendManager.set_schema_generation_database"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.set_schema_generation_database">[docs]</a>    <span class="k">def</span> <span class="nf">set_schema_generation_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the database schema generation.</span>

<span class="sd">        :param generation: string with schema generation to set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_settings_manager</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SCHEMA_GENERATION_KEY</span><span class="p">,</span> <span class="n">generation</span><span class="p">)</span></div>

<div class="viewcode-block" id="BackendManager.validate_schema"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.validate_schema">[docs]</a>    <span class="k">def</span> <span class="nf">validate_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate that the current database generation and schema are up-to-date with that of the code.</span>

<span class="sd">        :param profile: the profile for which to validate the database schema</span>
<span class="sd">        :raises `aiida.common.exceptions.ConfigurationError`: if database schema version or generation is not up-to-date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_schema_generation</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_schema_version</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span></div>

<div class="viewcode-block" id="BackendManager.validate_schema_generation_for_migration"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.validate_schema_generation_for_migration">[docs]</a>    <span class="k">def</span> <span class="nf">validate_schema_generation_for_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate whether the current database schema generation can be migrated.</span>

<span class="sd">        :raises `aiida.common.exceptions.IncompatibleDatabaseSchema`: if database schema generation cannot be migrated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema_generation_code</span> <span class="o">=</span> <span class="n">SCHEMA_GENERATION_VALUE</span>
        <span class="n">schema_generation_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_generation_database</span><span class="p">()</span>
        <span class="n">schema_version_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_database</span><span class="p">()</span>
        <span class="n">schema_version_reset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_reset</span><span class="p">(</span><span class="n">schema_generation_code</span><span class="p">)</span>
        <span class="n">schema_generation_reset</span><span class="p">,</span> <span class="n">aiida_core_version_reset</span> <span class="o">=</span> <span class="n">SCHEMA_GENERATION_RESET</span><span class="p">[</span><span class="n">schema_generation_code</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">schema_generation_database</span> <span class="o">!=</span> <span class="n">schema_generation_reset</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">IncompatibleDatabaseSchema</span><span class="p">(</span>
                <span class="n">TEMPLATE_MIGRATE_SCHEMA_GENERATION_INVALID_GENERATION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schema_generation_database</span><span class="o">=</span><span class="n">schema_generation_database</span><span class="p">,</span>
                    <span class="n">schema_generation_code</span><span class="o">=</span><span class="n">schema_generation_code</span><span class="p">,</span>
                    <span class="n">schema_generation_reset</span><span class="o">=</span><span class="n">schema_generation_reset</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">schema_version_database</span> <span class="o">!=</span> <span class="n">schema_version_reset</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">IncompatibleDatabaseSchema</span><span class="p">(</span>
                <span class="n">TEMPLATE_MIGRATE_SCHEMA_GENERATION_INVALID_VERSION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schema_generation_database</span><span class="o">=</span><span class="n">schema_generation_database</span><span class="p">,</span>
                    <span class="n">schema_generation_code</span><span class="o">=</span><span class="n">schema_generation_code</span><span class="p">,</span>
                    <span class="n">schema_version_database</span><span class="o">=</span><span class="n">schema_version_database</span><span class="p">,</span>
                    <span class="n">schema_version_reset</span><span class="o">=</span><span class="n">schema_version_reset</span><span class="p">,</span>
                    <span class="n">aiida_core_version_reset</span><span class="o">=</span><span class="n">aiida_core_version_reset</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BackendManager.validate_schema_version_for_migration"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.validate_schema_version_for_migration">[docs]</a>    <span class="k">def</span> <span class="nf">validate_schema_version_for_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate whether the current database schema version can be migrated.</span>

<span class="sd">        .. warning:: this will not validate that the schema generation is correct.</span>

<span class="sd">        :raises `aiida.common.exceptions.IncompatibleDatabaseSchema`: if database schema version cannot be migrated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema_version_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_code</span><span class="p">()</span>
        <span class="n">schema_version_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_database</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_database_schema_ahead</span><span class="p">():</span>
            <span class="c1"># Database is newer than the code so a downgrade would be necessary but this is not supported.</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">IncompatibleDatabaseSchema</span><span class="p">(</span>
                <span class="n">TEMPLATE_MIGRATE_SCHEMA_VERSION_INVALID_VERSION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schema_version_database</span><span class="o">=</span><span class="n">schema_version_database</span><span class="p">,</span>
                    <span class="n">schema_version_code</span><span class="o">=</span><span class="n">schema_version_code</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BackendManager.validate_schema_generation"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.validate_schema_generation">[docs]</a>    <span class="k">def</span> <span class="nf">validate_schema_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate that the current database schema generation is up-to-date with that of the code.</span>

<span class="sd">        :raises `aiida.common.exceptions.IncompatibleDatabaseSchema`: if database schema generation is not up-to-date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema_generation_code</span> <span class="o">=</span> <span class="n">SCHEMA_GENERATION_VALUE</span>
        <span class="n">schema_generation_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_generation_database</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">schema_generation_database</span> <span class="o">!=</span> <span class="n">schema_generation_code</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">IncompatibleDatabaseSchema</span><span class="p">(</span>
                <span class="n">TEMPLATE_INVALID_SCHEMA_GENERATION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schema_generation_database</span><span class="o">=</span><span class="n">schema_generation_database</span><span class="p">,</span>
                    <span class="n">schema_generation_code</span><span class="o">=</span><span class="n">schema_generation_code</span><span class="p">,</span>
                    <span class="n">profile_name</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BackendManager.validate_schema_version"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.manager.BackendManager.validate_schema_version">[docs]</a>    <span class="k">def</span> <span class="nf">validate_schema_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate that the current database schema version is up-to-date with that of the code.</span>

<span class="sd">        :param profile: the profile for which to validate the database schema</span>
<span class="sd">        :raises `aiida.common.exceptions.IncompatibleDatabaseSchema`: if database schema version is not up-to-date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema_version_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_code</span><span class="p">()</span>
        <span class="n">schema_version_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_version_database</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">schema_version_database</span> <span class="o">!=</span> <span class="n">schema_version_code</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">IncompatibleDatabaseSchema</span><span class="p">(</span>
                <span class="n">TEMPLATE_INVALID_SCHEMA_VERSION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schema_version_database</span><span class="o">=</span><span class="n">schema_version_database</span><span class="p">,</span>
                    <span class="n">schema_version_code</span><span class="o">=</span><span class="n">schema_version_code</span><span class="p">,</span>
                    <span class="n">profile_name</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>