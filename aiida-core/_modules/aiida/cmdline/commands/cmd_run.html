

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.cmdline.commands.cmd_run &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/togglebutton.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.cmdline.commands.cmd_run</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.cmdline.commands.cmd_run</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;`verdi run` command.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">click</span>

<span class="kn">from</span> <span class="nn">aiida.cmdline.commands.cmd_verdi</span> <span class="kn">import</span> <span class="n">verdi</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.params.options.multivalue</span> <span class="kn">import</span> <span class="n">MultipleValueOption</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="kn">import</span> <span class="n">decorators</span><span class="p">,</span> <span class="n">echo</span>
<span class="kn">from</span> <span class="nn">aiida.common.warnings</span> <span class="kn">import</span> <span class="n">AiidaDeprecationWarning</span>


<div class="viewcode-block" id="update_environment"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_run.update_environment">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">update_environment</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager that temporarily replaces `sys.argv` with `argv` and adds current working dir to the path.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Store a copy of the current path and argv as a backup variable so it can be restored later</span>
        <span class="n">_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span>
        <span class="n">_argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[:]</span>

        <span class="c1"># Add the current working directory to the path, such that local modules can be imported</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[:]</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Restore old parameters when exiting from the context manager</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">_argv</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">_path</span></div>


<div class="viewcode-block" id="validate_entrypoint_string"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_run.validate_entrypoint_string">[docs]</a><span class="k">def</span> <span class="nf">validate_entrypoint_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument,invalid-name</span>
    <span class="sd">&quot;&quot;&quot;Validate that `value` is a valid entrypoint string.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">autogroup</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">autogroup</span><span class="o">.</span><span class="n">Autogroup</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">value</span></div>


<span class="nd">@verdi</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">context_settings</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ignore_unknown_options</span><span class="o">=</span><span class="kc">True</span><span class="p">,))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;scriptname&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;varargs&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">UNPROCESSED</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--auto-group&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enables the autogrouping&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-l&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--auto-group-label-prefix&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify the prefix of the label of the auto group (numbers might be automatically &#39;</span>
    <span class="s1">&#39;appended to generate unique names per run).&#39;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-n&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--group-name&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify the name of the auto group [DEPRECATED, USE --auto-group-label-prefix instead]. &#39;</span>
    <span class="s1">&#39;This also enables auto-grouping.&#39;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-e&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--exclude&#39;</span><span class="p">,</span>
    <span class="bp">cls</span><span class="o">=</span><span class="n">MultipleValueOption</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Exclude these classes from auto grouping (use full entrypoint strings).&#39;</span><span class="p">,</span>
    <span class="n">callback</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">validate_entrypoint_string</span><span class="p">)</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-i&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--include&#39;</span><span class="p">,</span>
    <span class="bp">cls</span><span class="o">=</span><span class="n">MultipleValueOption</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Include these classes from auto grouping  (use full entrypoint strings or &quot;all&quot;).&#39;</span><span class="p">,</span>
    <span class="n">callback</span><span class="o">=</span><span class="n">validate_entrypoint_string</span>
<span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">scriptname</span><span class="p">,</span> <span class="n">varargs</span><span class="p">,</span> <span class="n">auto_group</span><span class="p">,</span> <span class="n">auto_group_label_prefix</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">include</span><span class="p">):</span>
    <span class="c1"># pylint: disable=too-many-arguments,exec-used</span>
    <span class="sd">&quot;&quot;&quot;Execute scripts with preloaded AiiDA environment.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.shell</span> <span class="kn">import</span> <span class="n">DEFAULT_MODULES_LIST</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">autogroup</span>

    <span class="c1"># Prepare the environment for the script to be run</span>
    <span class="n">globals_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;__builtins__&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">],</span>
        <span class="s1">&#39;__name__&#39;</span><span class="p">:</span> <span class="s1">&#39;__main__&#39;</span><span class="p">,</span>
        <span class="s1">&#39;__file__&#39;</span><span class="p">:</span> <span class="n">scriptname</span><span class="p">,</span>
        <span class="s1">&#39;__doc__&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;__package__&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>

    <span class="c1"># Dynamically load modules (the same of verdi shell) - but in globals_dict, not in the current environment</span>
    <span class="k">for</span> <span class="n">app_mod</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">DEFAULT_MODULES_LIST</span><span class="p">:</span>
        <span class="n">globals_dict</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="n">app_mod</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group_name</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;--group-name is deprecated, use `--auto-group-label-prefix` instead&#39;</span><span class="p">,</span> <span class="n">AiidaDeprecationWarning</span><span class="p">)</span>  <span class="c1"># pylint: disable=no-member</span>
        <span class="k">if</span> <span class="n">auto_group_label_prefix</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span>
                <span class="s1">&#39;You cannot specify both --group-name and --auto-group-label-prefix; &#39;</span>
                <span class="s1">&#39;use --auto-group-label-prefix only&#39;</span>
            <span class="p">)</span>
        <span class="n">auto_group_label_prefix</span> <span class="o">=</span> <span class="n">group_name</span>
        <span class="c1"># To have the old behavior, with auto-group enabled.</span>
        <span class="n">auto_group</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">auto_group</span><span class="p">:</span>
        <span class="n">aiida_verdilib_autogroup</span> <span class="o">=</span> <span class="n">autogroup</span><span class="o">.</span><span class="n">Autogroup</span><span class="p">()</span>
        <span class="c1"># Set the ``group_label_prefix`` if defined, otherwise a default prefix will be used</span>
        <span class="k">if</span> <span class="n">auto_group_label_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aiida_verdilib_autogroup</span><span class="o">.</span><span class="n">set_group_label_prefix</span><span class="p">(</span><span class="n">auto_group_label_prefix</span><span class="p">)</span>
        <span class="n">aiida_verdilib_autogroup</span><span class="o">.</span><span class="n">set_exclude</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
        <span class="n">aiida_verdilib_autogroup</span><span class="o">.</span><span class="n">set_include</span><span class="p">(</span><span class="n">include</span><span class="p">)</span>

        <span class="c1"># Note: this is also set in the exec environment! This is the intended behavior</span>
        <span class="n">autogroup</span><span class="o">.</span><span class="n">CURRENT_AUTOGROUP</span> <span class="o">=</span> <span class="n">aiida_verdilib_autogroup</span>

    <span class="c1"># Initialize the variable here, otherwise we get UnboundLocalError in the finally clause if it fails to open</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Here we use a standard open and not open, as exec will later fail if passed a unicode type string.</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">scriptname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s2">&quot;Unable to load file &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptname</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Must add also argv[0]</span>
            <span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="n">scriptname</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">varargs</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">update_environment</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">argv</span><span class="p">):</span>
                <span class="c1"># Compile the script for execution and pass it to exec with the globals_dict</span>
                <span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">scriptname</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="n">dont_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">globals_dict</span><span class="p">)</span>  <span class="c1"># yapf: disable # pylint: disable=exec-used</span>
        <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>  <span class="c1"># pylint: disable=try-except-raise</span>
            <span class="c1"># Script called sys.exit()</span>
            <span class="c1"># Re-raise the exception to have the error code properly returned at the end</span>
            <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">autogroup</span><span class="o">.</span><span class="n">current_autogroup</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>