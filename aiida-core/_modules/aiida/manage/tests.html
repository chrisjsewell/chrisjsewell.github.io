

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.manage.tests &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/togglebutton.js"></script>
        <script src="../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.manage.tests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.manage.tests</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Testing infrastructure for easy testing of AiiDA plugins.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">from</span> <span class="nn">aiida.backends</span> <span class="kn">import</span> <span class="n">BACKEND_DJANGO</span><span class="p">,</span> <span class="n">BACKEND_SQLA</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.manage</span> <span class="kn">import</span> <span class="n">configuration</span>
<span class="kn">from</span> <span class="nn">aiida.manage.configuration.settings</span> <span class="kn">import</span> <span class="n">create_instance_directories</span>
<span class="kn">from</span> <span class="nn">aiida.manage</span> <span class="kn">import</span> <span class="n">manager</span>
<span class="kn">from</span> <span class="nn">aiida.manage.external.postgres</span> <span class="kn">import</span> <span class="n">Postgres</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TestManager&#39;</span><span class="p">,</span> <span class="s1">&#39;TestManagerError&#39;</span><span class="p">,</span> <span class="s1">&#39;ProfileManager&#39;</span><span class="p">,</span> <span class="s1">&#39;TemporaryProfileManager&#39;</span><span class="p">,</span> <span class="s1">&#39;_GLOBAL_TEST_MANAGER&#39;</span><span class="p">)</span>

<span class="n">_DEFAULT_PROFILE_INFO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_profile&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;tests@aiida.mail&#39;</span><span class="p">,</span>
    <span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;AiiDA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;last_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Plugintest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;institution&#39;</span><span class="p">:</span> <span class="s1">&#39;aiidateam&#39;</span><span class="p">,</span>
    <span class="s1">&#39;database_engine&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql_psycopg2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;database_backend&#39;</span><span class="p">:</span> <span class="s1">&#39;django&#39;</span><span class="p">,</span>
    <span class="s1">&#39;database_username&#39;</span><span class="p">:</span> <span class="s1">&#39;aiida&#39;</span><span class="p">,</span>
    <span class="s1">&#39;database_password&#39;</span><span class="p">:</span> <span class="s1">&#39;aiida_pw&#39;</span><span class="p">,</span>
    <span class="s1">&#39;database_name&#39;</span><span class="p">:</span> <span class="s1">&#39;aiida_db&#39;</span><span class="p">,</span>
    <span class="s1">&#39;repo_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;test_repo&#39;</span><span class="p">,</span>
    <span class="s1">&#39;config_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;.aiida&#39;</span><span class="p">,</span>
    <span class="s1">&#39;root_path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="TestManagerError"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManagerError">[docs]</a><span class="k">class</span> <span class="nc">TestManagerError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised by TestManager in situations that may lead to inconsistent behaviour.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestManagerError.__init__"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManagerError.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="TestManagerError.__str__"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManagerError.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestManager"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManager">[docs]</a><span class="k">class</span> <span class="nc">TestManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test manager for plugin tests.</span>

<span class="sd">    Uses either ProfileManager for wrapping an existing profile or TemporaryProfileManager for setting up a complete</span>
<span class="sd">    temporary AiiDA environment.</span>

<span class="sd">    For usage with pytest, see :py:class:`~aiida.manage.tests.pytest_fixtures`.</span>
<span class="sd">    For usage with unittest, see :py:class:`~aiida.manage.tests.unittest_classes`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestManager.__init__"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManager.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TestManager.use_temporary_profile"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManager.use_temporary_profile">[docs]</a>    <span class="k">def</span> <span class="nf">use_temporary_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pgtest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up Test manager to use temporary AiiDA profile.</span>

<span class="sd">         Uses :py:class:`aiida.manage.tests.TemporaryProfileManager` internally.</span>

<span class="sd">        :param backend: Backend to use.</span>
<span class="sd">        :param pgtest: a dictionary of arguments to be passed to PGTest() for starting the postgresql cluster,</span>
<span class="sd">           e.g. {&#39;pg_ctl&#39;: &#39;/somepath/pg_ctl&#39;}. Should usually not be necessary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestManagerError</span><span class="p">(</span><span class="s1">&#39;AiiDA dbenv must not be loaded before setting up a test profile.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestManagerError</span><span class="p">(</span><span class="s1">&#39;Profile manager already loaded.&#39;</span><span class="p">)</span>

        <span class="n">mngr</span> <span class="o">=</span> <span class="n">TemporaryProfileManager</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">pgtest</span><span class="o">=</span><span class="n">pgtest</span><span class="p">)</span>
        <span class="n">mngr</span><span class="o">.</span><span class="n">create_profile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="n">mngr</span>  <span class="c1"># don&#39;t assign before profile has actually been created!</span></div>

<div class="viewcode-block" id="TestManager.use_profile"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManager.use_profile">[docs]</a>    <span class="k">def</span> <span class="nf">use_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up Test manager to use existing profile.</span>

<span class="sd">         Uses :py:class:`aiida.manage.tests.ProfileManager` internally.</span>

<span class="sd">        :param profile_name: Name of existing test profile to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestManagerError</span><span class="p">(</span><span class="s1">&#39;AiiDA dbenv must not be loaded before setting up a test profile.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestManagerError</span><span class="p">(</span><span class="s1">&#39;Profile manager already loaded.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="n">ProfileManager</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestManager.has_profile_open"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManager.has_profile_open">[docs]</a>    <span class="k">def</span> <span class="nf">has_profile_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">has_profile_open</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestManager.reset_db"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManager.reset_db">[docs]</a>    <span class="k">def</span> <span class="nf">reset_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">reset_db</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestManager.destroy_all"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TestManager.destroy_all">[docs]</a>    <span class="k">def</span> <span class="nf">destroy_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">destroy_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="ProfileManager"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.ProfileManager">[docs]</a><span class="k">class</span> <span class="nc">ProfileManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps existing AiiDA profile.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ProfileManager.__init__"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.ProfileManager.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use an existing profile.</span>

<span class="sd">        :param profile_name: Name of the profile to be loaded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida</span> <span class="kn">import</span> <span class="n">load_profile</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.testbase</span> <span class="kn">import</span> <span class="n">check_if_tests_can_run</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="n">load_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">_load_backend</span><span class="p">(</span><span class="n">schema_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestManagerError</span><span class="p">(</span><span class="s1">&#39;Unable to load test profile </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile_name</span><span class="p">))</span>
        <span class="n">check_if_tests_can_run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_select_db_test_case</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile</span><span class="o">.</span><span class="n">database_backend</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfileManager._select_db_test_case"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.ProfileManager._select_db_test_case">[docs]</a>    <span class="k">def</span> <span class="nf">_select_db_test_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selects tests case for the correct database backend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="n">BACKEND_DJANGO</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">aiida.backends.djsite.db.testbase</span> <span class="kn">import</span> <span class="n">DjangoTests</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_case</span> <span class="o">=</span> <span class="n">DjangoTests</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="n">BACKEND_SQLA</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.testbase</span> <span class="kn">import</span> <span class="n">SqlAlchemyTests</span>
            <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy</span> <span class="kn">import</span> <span class="n">get_scoped_session</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_test_case</span> <span class="o">=</span> <span class="n">SqlAlchemyTests</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_case</span><span class="o">.</span><span class="n">test_session</span> <span class="o">=</span> <span class="n">get_scoped_session</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProfileManager.reset_db"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.ProfileManager.reset_db">[docs]</a>    <span class="k">def</span> <span class="nf">reset_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_case</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>  <span class="c1"># will drop all users</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProfileManager.init_db"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.ProfileManager.init_db">[docs]</a>    <span class="k">def</span> <span class="nf">init_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise the database state for running of tests.</span>

<span class="sd">        Adds default user if necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">User</span>
        <span class="kn">from</span> <span class="nn">aiida.cmdline.commands.cmd_user</span> <span class="kn">import</span> <span class="n">set_default_user</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">():</span>
            <span class="n">user_dict</span> <span class="o">=</span> <span class="n">get_user_dict</span><span class="p">(</span><span class="n">_DEFAULT_PROFILE_INFO</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
                <span class="n">user</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
                <span class="c1"># The user already exists, no problem</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>

            <span class="n">set_default_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># necessary to pick up new default user</span></div>

<div class="viewcode-block" id="ProfileManager.has_profile_open"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.ProfileManager.has_profile_open">[docs]</a>    <span class="k">def</span> <span class="nf">has_profile_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ProfileManager.destroy_all"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.ProfileManager.destroy_all">[docs]</a>    <span class="k">def</span> <span class="nf">destroy_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="TemporaryProfileManager"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager">[docs]</a><span class="k">class</span> <span class="nc">TemporaryProfileManager</span><span class="p">(</span><span class="n">ProfileManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage the life cycle of a completely separated and temporary AiiDA environment.</span>

<span class="sd">     * No profile / database setup required</span>
<span class="sd">     * Tests run via the TemporaryProfileManager never pollute the user&#39;s working environment</span>

<span class="sd">    Filesystem:</span>

<span class="sd">        * temporary ``.aiida`` configuration folder</span>
<span class="sd">        * temporary repository folder</span>

<span class="sd">    Database:</span>

<span class="sd">        * temporary database cluster (via the ``pgtest`` package)</span>
<span class="sd">        * with ``aiida`` database user</span>
<span class="sd">        * with ``aiida_db`` database</span>

<span class="sd">    AiiDA:</span>

<span class="sd">        * configured to use the temporary configuration</span>
<span class="sd">        * sets up a temporary profile for tests</span>

<span class="sd">    All of this happens automatically when using the corresponding tests classes &amp; tests runners (unittest)</span>
<span class="sd">    or fixtures (pytest).</span>

<span class="sd">    Example::</span>

<span class="sd">        tests = TemporaryProfileManager(backend=backend)</span>
<span class="sd">        tests.create_aiida_db()  # set up only the database</span>
<span class="sd">        tests.create_profile()  # set up a profile (creates the db too if necessary)</span>

<span class="sd">        # ready for tests</span>

<span class="sd">        # run tests 1</span>

<span class="sd">        tests.reset_db()</span>
<span class="sd">        # database ready for independent tests 2</span>

<span class="sd">        # run tests 2</span>

<span class="sd">        tests.destroy_all()</span>
<span class="sd">        # everything cleaned up</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_test_case</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TemporaryProfileManager.__init__"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">BACKEND_DJANGO</span><span class="p">,</span> <span class="n">pgtest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># pylint: disable=super-init-not-called</span>
        <span class="sd">&quot;&quot;&quot;Construct a TemporaryProfileManager</span>

<span class="sd">        :param backend: a database backend</span>
<span class="sd">        :param pgtest: a dictionary of arguments to be passed to PGTest() for starting the postgresql cluster,</span>
<span class="sd">           e.g. {&#39;pg_ctl&#39;: &#39;/somepath/pg_ctl&#39;}. Should usually not be necessary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="kn">import</span> <span class="n">settings</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbinfo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span> <span class="o">=</span> <span class="n">_DEFAULT_PROFILE_INFO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;database_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pgtest</span> <span class="o">=</span> <span class="n">pgtest</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_test_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">configuration</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">,</span>
            <span class="s1">&#39;config_dir&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">AIIDA_CONFIG_FOLDER</span><span class="p">,</span>
            <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span><span class="p">,</span>
        <span class="p">}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Profile parameters.</span>

<span class="sd">        Used to set up AiiDA profile from self.profile_info dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;database_engine&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database_engine&#39;</span><span class="p">),</span>
            <span class="s1">&#39;database_backend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database_backend&#39;</span><span class="p">),</span>
            <span class="s1">&#39;database_port&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database_port&#39;</span><span class="p">),</span>
            <span class="s1">&#39;database_hostname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database_hostname&#39;</span><span class="p">),</span>
            <span class="s1">&#39;database_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database_name&#39;</span><span class="p">),</span>
            <span class="s1">&#39;database_username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database_username&#39;</span><span class="p">),</span>
            <span class="s1">&#39;database_password&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database_password&#39;</span><span class="p">),</span>
            <span class="s1">&#39;repository_uri&#39;</span><span class="p">:</span> <span class="s1">&#39;file://&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">dictionary</span>

<div class="viewcode-block" id="TemporaryProfileManager.create_db_cluster"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager.create_db_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">create_db_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the database cluster using PGTest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pgtest.pgtest</span> <span class="kn">import</span> <span class="n">PGTest</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestManagerError</span><span class="p">(</span>
                <span class="s1">&#39;Running temporary postgresql cluster detected.&#39;</span> <span class="o">+</span> <span class="s1">&#39;Use destroy_all() before creating a new cluster.&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span> <span class="o">=</span> <span class="n">PGTest</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_pgtest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span><span class="o">.</span><span class="n">dsn</span><span class="p">)</span></div>

<div class="viewcode-block" id="TemporaryProfileManager.create_aiida_db"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager.create_aiida_db">[docs]</a>    <span class="k">def</span> <span class="nf">create_aiida_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the necessary database on the temporary postgres instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TestManagerError</span><span class="p">(</span><span class="s1">&#39;AiiDA dbenv can not be loaded while creating a tests db environment&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_db_cluster</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span> <span class="o">=</span> <span class="n">Postgres</span><span class="p">(</span><span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dbinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbinfo</span><span class="p">)</span>
        <span class="c1"># note: not using postgres.create_dbuser_db_safe here since we don&#39;t want prompts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">create_dbuser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;database_username&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;database_password&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">create_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;database_username&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;database_name&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">dbinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;database_hostname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">host_for_psycopg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;database_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">port_for_psycopg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_test_db</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TemporaryProfileManager.create_profile"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager.create_profile">[docs]</a>    <span class="k">def</span> <span class="nf">create_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set AiiDA to use the tests config dir and create a default profile there</span>

<span class="sd">        Warning: the AiiDA dbenv must not be loaded when this is called!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="kn">import</span> <span class="n">settings</span><span class="p">,</span> <span class="n">load_profile</span><span class="p">,</span> <span class="n">Profile</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_test_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_aiida_db</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">CONFIG</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AIIDA_CONFIG_FOLDER</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">create_instance_directories</span><span class="p">()</span>
        <span class="n">profile_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_dictionary</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_default_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="n">profile</span>

        <span class="n">load_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">_load_backend</span><span class="p">(</span><span class="n">schema_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">migrate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_select_db_test_case</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile</span><span class="o">.</span><span class="n">database_backend</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span></div>

<div class="viewcode-block" id="TemporaryProfileManager.repo_ok"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager.repo_ok">[docs]</a>    <span class="k">def</span> <span class="nf">repo_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">)))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;repo_dir&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="TemporaryProfileManager._return_dir"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager._return_dir">[docs]</a>    <span class="k">def</span> <span class="nf">_return_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a path to a directory from the fs environment&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dir_path</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">]</span>

    <span class="nd">@backend</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_profile_open</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">TestManagerError</span><span class="p">(</span><span class="s1">&#39;backend cannot be changed after setting up the environment&#39;</span><span class="p">)</span>

        <span class="n">valid_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">BACKEND_DJANGO</span><span class="p">,</span> <span class="n">BACKEND_SQLA</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_backends</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid backend </span><span class="si">{}</span><span class="s1">, must be one of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">valid_backends</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config_dir_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;config_dir&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;root_path&#39;</span><span class="p">]</span>

    <span class="nd">@root_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">root_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;root_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_dir_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">))</span>

<div class="viewcode-block" id="TemporaryProfileManager.destroy_all"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager.destroy_all">[docs]</a>    <span class="k">def</span> <span class="nf">destroy_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all traces of the tests run&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="kn">import</span> <span class="n">settings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_test_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;config&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">:</span>
            <span class="n">configuration</span><span class="o">.</span><span class="n">CONFIG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;config_dir&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">AIIDA_CONFIG_FOLDER</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;config_dir&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;profile&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">:</span>
            <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="TemporaryProfileManager.has_profile_open"><a class="viewcode-back" href="../../../apidoc/aiida.manage.tests.html#aiida.manage.fixtures.TemporaryProfileManager.has_profile_open">[docs]</a>    <span class="k">def</span> <span class="nf">has_profile_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div></div>


<span class="n">_GLOBAL_TEST_MANAGER</span> <span class="o">=</span> <span class="n">TestManager</span><span class="p">()</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">test_manager</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">BACKEND_DJANGO</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pgtest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Context manager for TestManager objects.</span>

<span class="sd">    Sets up temporary AiiDA environment for testing or reuses existing environment,</span>
<span class="sd">    if `AIIDA_TEST_PROFILE` environment variable is set.</span>

<span class="sd">    Example pytest fixture::</span>

<span class="sd">        def aiida_profile():</span>
<span class="sd">            with test_manager(backend) as test_mgr:</span>
<span class="sd">                yield fixture_mgr</span>

<span class="sd">    Example unittest test runner::</span>

<span class="sd">        with test_manager(backend) as test_mgr:</span>
<span class="sd">            # ready for tests</span>
<span class="sd">        # everything cleaned up</span>


<span class="sd">    :param backend: database backend, either BACKEND_SQLA or BACKEND_DJANGO</span>
<span class="sd">    :param profile_name: name of test profile to be used or None (to use temporary profile)</span>
<span class="sd">    :param pgtest: a dictionary of arguments to be passed to PGTest() for starting the postgresql cluster,</span>
<span class="sd">       e.g. {&#39;pg_ctl&#39;: &#39;/somepath/pg_ctl&#39;}. Should usually not be necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="kn">import</span> <span class="n">Capturing</span>
    <span class="kn">from</span> <span class="nn">aiida.common.log</span> <span class="kn">import</span> <span class="n">configure_logging</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_GLOBAL_TEST_MANAGER</span><span class="o">.</span><span class="n">has_profile_open</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">profile_name</span><span class="p">:</span>
                <span class="n">_GLOBAL_TEST_MANAGER</span><span class="o">.</span><span class="n">use_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>  <span class="c1"># capture output of AiiDA DB setup</span>
                    <span class="n">_GLOBAL_TEST_MANAGER</span><span class="o">.</span><span class="n">use_temporary_profile</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">pgtest</span><span class="o">=</span><span class="n">pgtest</span><span class="p">)</span>
        <span class="n">configure_logging</span><span class="p">(</span><span class="n">with_orm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">_GLOBAL_TEST_MANAGER</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_GLOBAL_TEST_MANAGER</span><span class="o">.</span><span class="n">destroy_all</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_test_backend_name</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Read name of database backend from environment variable or the specified test profile.</span>

<span class="sd">    Reads database backend (&#39;django&#39; or &#39;sqlalchemy&#39;) from &#39;AIIDA_TEST_BACKEND&#39; environment variable,</span>
<span class="sd">    or the backend configured for the &#39;AIIDA_TEST_PROFILE&#39;.</span>
<span class="sd">    Defaults to django backend.</span>

<span class="sd">    :returns: content of environment variable or `BACKEND_DJANGO`</span>
<span class="sd">    :raises: ValueError if unknown backend name detected.</span>
<span class="sd">    :raises: ValueError if both &#39;AIIDA_TEST_BACKEND&#39; and &#39;AIIDA_TEST_PROFILE&#39; are set, and the two</span>
<span class="sd">        backends do not match.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_profile_name</span> <span class="o">=</span> <span class="n">get_test_profile_name</span><span class="p">()</span>
    <span class="n">backend_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AIIDA_TEST_BACKEND&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test_profile_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">backend_profile</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">test_profile_name</span><span class="p">)</span><span class="o">.</span><span class="n">database_backend</span>
        <span class="k">if</span> <span class="n">backend_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">backend_env</span> <span class="o">!=</span> <span class="n">backend_profile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The backend &#39;</span><span class="si">{}</span><span class="s2">&#39; read from AIIDA_TEST_BACKEND does not match the backend &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;of AIIDA_TEST_PROFILE &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backend_env</span><span class="p">,</span> <span class="n">backend_profile</span><span class="p">,</span> <span class="n">test_profile_name</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">backend_res</span> <span class="o">=</span> <span class="n">backend_profile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">backend_res</span> <span class="o">=</span> <span class="n">backend_env</span> <span class="ow">or</span> <span class="n">BACKEND_DJANGO</span>

    <span class="k">if</span> <span class="n">backend_res</span> <span class="ow">in</span> <span class="p">(</span><span class="n">BACKEND_DJANGO</span><span class="p">,</span> <span class="n">BACKEND_SQLA</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">backend_res</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown backend &#39;</span><span class="si">{}</span><span class="s2">&#39; read from AIIDA_TEST_BACKEND environment variable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backend_res</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_test_profile_name</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Read name of test profile from environment variable.</span>

<span class="sd">    Reads name of existing test profile &#39;AIIDA_TEST_PROFILE&#39; environment variable.</span>
<span class="sd">    If specified, this profile is used for running the tests (instead of setting up a temporary profile).</span>

<span class="sd">    :returns: content of environment variable or `None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AIIDA_TEST_PROFILE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_user_dict</span><span class="p">(</span><span class="n">profile_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Collect parameters required for creating users.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">profile_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;institution&#39;</span><span class="p">)}</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>