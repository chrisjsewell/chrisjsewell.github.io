

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.manage.database.delete.nodes &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
        <script src="../../../../../_static/togglebutton.js"></script>
        <script src="../../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.manage.database.delete.nodes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.manage.database.delete.nodes</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Function to delete nodes from the database.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="kn">import</span> <span class="n">echo</span>


<div class="viewcode-block" id="delete_nodes"><a class="viewcode-back" href="../../../../../apidoc/aiida.manage.database.delete.html#aiida.manage.database.delete.nodes.delete_nodes">[docs]</a><span class="k">def</span> <span class="nf">delete_nodes</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete nodes by a list of pks.</span>

<span class="sd">    This command will delete not only the specified nodes, but also the ones that are</span>
<span class="sd">    linked to these and should be also deleted in order to keep a consistent provenance</span>
<span class="sd">    according to the rules explained in the concepts section of the documentation.</span>
<span class="sd">    In summary:</span>

<span class="sd">    1. If a DATA node is deleted, any process nodes linked to it will also be deleted.</span>

<span class="sd">    2. If a CALC node is deleted, any incoming WORK node (callers) will be deleted as</span>
<span class="sd">    well whereas any incoming DATA node (inputs) will be kept. Outgoing DATA nodes</span>
<span class="sd">    (outputs) will be deleted by default but this can be disabled.</span>

<span class="sd">    3. If a WORK node is deleted, any incoming WORK node (callers) will be deleted as</span>
<span class="sd">    well, but all DATA nodes will be kept. Outgoing WORK or CALC nodes will be kept by</span>
<span class="sd">    default, but deletion of either of both kind of connected nodes can be enabled.</span>

<span class="sd">    These rules are &#39;recursive&#39;, so if a CALC node is deleted, then its output DATA</span>
<span class="sd">    nodes will be deleted as well, and then any CALC node that may have those as</span>
<span class="sd">    inputs, and so on.</span>

<span class="sd">    :param pks: a list of the PKs of the nodes to delete</span>
<span class="sd">    :param bool force: do not ask for confirmation to delete nodes.</span>
<span class="sd">    :param int verbosity: 0 prints nothing,</span>
<span class="sd">                          1 prints just sums and total,</span>
<span class="sd">                          2 prints individual nodes.</span>

<span class="sd">    :param kwargs: graph traversal rules. See :const:`aiida.common.links.GraphTraversalRules` what rule names</span>
<span class="sd">        are toggleable and what the defaults are.</span>
<span class="sd">    :param bool dry_run:</span>
<span class="sd">        Just perform a dry run and do not delete anything. Print statistics according</span>
<span class="sd">        to the verbosity level set.</span>
<span class="sd">    :param bool force:</span>
<span class="sd">        Do not ask for confirmation to delete nodes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-arguments,too-many-branches,too-many-locals,too-many-statements</span>
    <span class="kn">from</span> <span class="nn">aiida.backends.utils</span> <span class="kn">import</span> <span class="n">delete_nodes_and_connections</span>
    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">exceptions</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">QueryBuilder</span><span class="p">,</span> <span class="n">load_node</span>
    <span class="kn">from</span> <span class="nn">aiida.tools.graph.graph_traversers</span> <span class="kn">import</span> <span class="n">get_nodes_delete</span>

    <span class="n">starting_pks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotExistent</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;warning: node with pk&lt;</span><span class="si">{}</span><span class="s1">&gt; does not exist, skipping&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">starting_pks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

    <span class="c1"># An empty set might be problematic for the queries done below.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">starting_pks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbosity</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Nothing to delete&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">pks_set_to_delete</span> <span class="o">=</span> <span class="n">get_nodes_delete</span><span class="p">(</span><span class="n">starting_pks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
            <span class="s1">&#39;I </span><span class="si">{}</span><span class="s1"> delete </span><span class="si">{}</span><span class="s1"> node</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;would&#39;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s1">&#39;will&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">),</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">pks_set_to_delete</span>
                <span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;node_type&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;The nodes I </span><span class="si">{}</span><span class="s1"> delete:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;would&#39;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s1">&#39;will&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">type_string</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">iterall</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">short_type_string</span> <span class="o">=</span> <span class="n">type_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">short_type_string</span> <span class="o">=</span> <span class="n">type_string</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">short_type_string</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">This was a dry run, exiting without deleting anything&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Asking for user confirmation here</span>
    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;YOU ARE ABOUT TO DELETE </span><span class="si">{}</span><span class="s1"> NODES! THIS CANNOT BE UNDONE!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="s1">&#39;Shall I continue?&#39;</span><span class="p">):</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Exiting without deleting&#39;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="c1"># Recover the list of folders to delete before actually deleting the nodes. I will delete the folders only later,</span>
    <span class="c1"># so that if there is a problem during the deletion of the nodes in the DB, I don&#39;t delete the folders</span>
    <span class="n">repositories</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">_repository</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pks_set_to_delete</span><span class="p">]</span>  <span class="c1"># pylint: disable=protected-access</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Starting node deletion...&#39;</span><span class="p">)</span>
    <span class="n">delete_nodes_and_connections</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Nodes deleted from database, deleting files from the repository now...&#39;</span><span class="p">)</span>

    <span class="c1"># If we are here, we managed to delete the entries from the DB.</span>
    <span class="c1"># I can now delete the folders</span>
    <span class="k">for</span> <span class="n">repository</span> <span class="ow">in</span> <span class="n">repositories</span><span class="p">:</span>
        <span class="n">repository</span><span class="o">.</span><span class="n">erase</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Deletion completed.&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>