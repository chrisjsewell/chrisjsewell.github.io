

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.manage.configuration.config &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/togglebutton.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../configuration.html">aiida.manage.configuration</a> &raquo;</li>
        
      <li>aiida.manage.configuration.config</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.manage.configuration.config</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Module that defines the configuration file of an AiiDA instance and functions to create and load it.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">json</span>

<span class="kn">from</span> <span class="nn">.options</span> <span class="kn">import</span> <span class="n">get_option</span><span class="p">,</span> <span class="n">parse_option</span><span class="p">,</span> <span class="n">NO_DEFAULT</span>
<span class="kn">from</span> <span class="nn">.profile</span> <span class="kn">import</span> <span class="n">Profile</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Config&#39;</span><span class="p">,)</span>


<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config">[docs]</a><span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-many-public-methods</span>
    <span class="sd">&quot;&quot;&quot;Object that represents the configuration file of an AiiDA instance.&quot;&quot;&quot;</span>

    <span class="n">KEY_VERSION</span> <span class="o">=</span> <span class="s1">&#39;CONFIG_VERSION&#39;</span>
    <span class="n">KEY_VERSION_CURRENT</span> <span class="o">=</span> <span class="s1">&#39;CURRENT&#39;</span>
    <span class="n">KEY_VERSION_OLDEST_COMPATIBLE</span> <span class="o">=</span> <span class="s1">&#39;OLDEST_COMPATIBLE&#39;</span>
    <span class="n">KEY_DEFAULT_PROFILE</span> <span class="o">=</span> <span class="s1">&#39;default_profile&#39;</span>
    <span class="n">KEY_PROFILES</span> <span class="o">=</span> <span class="s1">&#39;profiles&#39;</span>
    <span class="n">KEY_OPTIONS</span> <span class="o">=</span> <span class="s1">&#39;options&#39;</span>

<div class="viewcode-block" id="Config.from_file"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a configuration object from the contents of a given file.</span>

<span class="sd">        .. note:: if the filepath does not exist an empty file will be created with the current default configuration</span>
<span class="sd">            and will be written to disk. If the filepath does already exist but contains a configuration with an</span>
<span class="sd">            outdated schema, the content will be migrated and then written to disk.</span>

<span class="sd">        :param filepath: the absolute path to the configuration file</span>
<span class="sd">        :return: `Config` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="kn">import</span> <span class="n">echo</span>
        <span class="kn">from</span> <span class="nn">.migrations</span> <span class="kn">import</span> <span class="n">check_and_migrate_config</span><span class="p">,</span> <span class="n">config_needs_migrating</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">check_and_migrate_config</span><span class="p">({}))</span>
            <span class="n">config</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the configuration file needs to be migrated first create a specific backup so it can easily be reverted</span>
            <span class="k">if</span> <span class="n">config_needs_migrating</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;current configuration file `</span><span class="si">{}</span><span class="s1">` is outdated and will be migrated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
                <span class="n">filepath_backup</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backup</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;original backed up to `</span><span class="si">{}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath_backup</span><span class="p">))</span>

            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">check_and_migrate_config</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
            <span class="n">config</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">config</span></div>

<div class="viewcode-block" id="Config._backup"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config._backup">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_backup</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a backup of the configuration file with the given filepath.</span>

<span class="sd">        :param filepath: absolute path to the configuration file to backup</span>
<span class="sd">        :return: the absolute path of the created backup</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">timezone</span>

        <span class="n">filepath_backup</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Keep generating a new backup filename based on the current time until it does not exist</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">filepath_backup</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath_backup</span><span class="p">):</span>
            <span class="n">filepath_backup</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">filepath_backup</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filepath_backup</span></div>

<div class="viewcode-block" id="Config.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a configuration object from a configuration dictionary and its filepath.</span>

<span class="sd">        If an empty dictionary is passed, the constructor will create the skeleton configuration dictionary.</span>

<span class="sd">        :param filepath: the absolute filepath of the configuration file</span>
<span class="sd">        :param config: the content of the configuration file in dictionary form</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.migrations</span> <span class="kn">import</span> <span class="n">CURRENT_CONFIG_VERSION</span><span class="p">,</span> <span class="n">OLDEST_COMPATIBLE_CONFIG_VERSION</span>

        <span class="n">version</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_VERSION</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">current_version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_VERSION_CURRENT</span><span class="p">,</span> <span class="n">CURRENT_CONFIG_VERSION</span><span class="p">)</span>
        <span class="n">compatible_version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_VERSION_OLDEST_COMPATIBLE</span><span class="p">,</span> <span class="n">OLDEST_COMPATIBLE_CONFIG_VERSION</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_version</span> <span class="o">=</span> <span class="n">current_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_compatible_version</span> <span class="o">=</span> <span class="n">compatible_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">known_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_VERSION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROFILES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_DEFAULT_PROFILE</span><span class="p">]</span>
        <span class="n">unknown_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">known_keys</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unknown_keys</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_invalid</span><span class="p">(</span><span class="s1">&#39;encountered unknown keys [</span><span class="si">{}</span><span class="s1">] in `</span><span class="si">{}</span><span class="s1">` which have been removed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">filepath</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_profile</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DEFAULT_PROFILE</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_profile</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config_profile</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROFILES</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">Profile</span><span class="o">.</span><span class="n">contains_unknown_keys</span><span class="p">(</span><span class="n">config_profile</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_invalid</span><span class="p">(</span><span class="s1">&#39;encountered unknown keys in profile `</span><span class="si">{}</span><span class="s1">` which have been removed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">config_profile</span><span class="p">,</span> <span class="n">from_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.__eq__"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.__eq__">[docs]</a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Two configurations are considered equal, when their dictionaries are equal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dictionary</span></div>

<div class="viewcode-block" id="Config.__ne__"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.__ne__">[docs]</a>    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Two configurations are considered unequal, when their dictionaries are unequal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">dictionary</span></div>

<div class="viewcode-block" id="Config.handle_invalid"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.handle_invalid">[docs]</a>    <span class="k">def</span> <span class="nf">handle_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle an incoming invalid configuration dictionary.</span>

<span class="sd">        The current content of the configuration file will be written to a backup file.</span>

<span class="sd">        :param message: a string message to echo with describing the infraction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="kn">import</span> <span class="n">echo</span>
        <span class="n">filepath_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;backup of the original config file written to: `</span><span class="si">{}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath_backup</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the dictionary representation of the config as it would be written to file.</span>

<span class="sd">        :return: dictionary representation of config as it should be written to file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KEY_VERSION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_settings</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROFILES</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">profile</span><span class="o">.</span><span class="n">dictionary</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">profile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_profile</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DEFAULT_PROFILE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_profile</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_version</span>

    <span class="nd">@version</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_version</span> <span class="o">=</span> <span class="n">version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version_oldest_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_compatible_version</span>

    <span class="nd">@version_oldest_compatible</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">version_oldest_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_oldest_compatible</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_compatible_version</span> <span class="o">=</span> <span class="n">version_oldest_compatible</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KEY_VERSION_CURRENT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KEY_VERSION_OLDEST_COMPATIBLE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_oldest_compatible</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_profile_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default profile name.</span>

<span class="sd">        :return: the default profile name or None if not defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_profile</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the currently loaded profile.</span>

<span class="sd">        :return: the current profile or None if not defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">get_profile</span>
        <span class="k">return</span> <span class="n">get_profile</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of profile names.</span>

<span class="sd">        :return: list of profile names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of profiles.</span>

<span class="sd">        :return: the profiles</span>
<span class="sd">        :rtype: list of `Profile` instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<div class="viewcode-block" id="Config.validate_profile"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.validate_profile">[docs]</a>    <span class="k">def</span> <span class="nf">validate_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate that a profile exists.</span>

<span class="sd">        :param name: name of the profile:</span>
<span class="sd">        :raises aiida.common.ProfileConfigurationError: if the name is not found in the configuration file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">exceptions</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProfileConfigurationError</span><span class="p">(</span><span class="s1">&#39;profile `</span><span class="si">{}</span><span class="s1">` does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Config.get_profile"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.get_profile">[docs]</a>    <span class="k">def</span> <span class="nf">get_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the profile for the given name or the default one if not specified.</span>

<span class="sd">        :return: the profile instance or None if it does not exist</span>
<span class="sd">        :raises aiida.common.ProfileConfigurationError: if the name is not found in the configuration file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">exceptions</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_profile_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProfileConfigurationError</span><span class="p">(</span>
                <span class="s1">&#39;no default profile defined: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_profile_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_profile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="Config.add_profile"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.add_profile">[docs]</a>    <span class="k">def</span> <span class="nf">add_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a profile to the configuration.</span>

<span class="sd">        :param profile: the profile configuration dictionary</span>
<span class="sd">        :return: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="p">[</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Config.update_profile"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.update_profile">[docs]</a>    <span class="k">def</span> <span class="nf">update_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update a profile in the configuration.</span>

<span class="sd">        :param profile: the profile instance to update</span>
<span class="sd">        :return: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="p">[</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Config.remove_profile"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.remove_profile">[docs]</a>    <span class="k">def</span> <span class="nf">remove_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a profile from the configuration.</span>

<span class="sd">        :param name: the name of the profile to remove</span>
<span class="sd">        :raises aiida.common.ProfileConfigurationError: if the given profile does not exist</span>
<span class="sd">        :return: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_profile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Config.set_default_profile"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.set_default_profile">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the given profile as the new default.</span>

<span class="sd">        :param name: name of the profile to set as new default</span>
<span class="sd">        :param overwrite: when True, set the profile as the new default even if a default profile is already defined</span>
<span class="sd">        :raises aiida.common.ProfileConfigurationError: if the given profile does not exist</span>
<span class="sd">        :return: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_profile_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_profile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_profile</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span>

    <span class="nd">@options</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Config.set_option"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.set_option">[docs]</a>    <span class="k">def</span> <span class="nf">set_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">option_value</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a configuration option for a certain scope.</span>

<span class="sd">        :param option_name: the name of the configuration option</span>
<span class="sd">        :param option_value: the option value</span>
<span class="sd">        :param scope: set the option for this profile or globally if not specified</span>
<span class="sd">        :param override: boolean, if False, will not override the option if it already exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">option</span><span class="p">,</span> <span class="n">parsed_value</span> <span class="o">=</span> <span class="n">parse_option</span><span class="p">(</span><span class="n">option_name</span><span class="p">,</span> <span class="n">option_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parsed_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">parsed_value</span>
        <span class="k">elif</span> <span class="n">option</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_DEFAULT</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">option</span><span class="o">.</span><span class="n">global_only</span> <span class="ow">and</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="n">override</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">or</span> <span class="n">override</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Config.unset_option"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.unset_option">[docs]</a>    <span class="k">def</span> <span class="nf">unset_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unset a configuration option for a certain scope.</span>

<span class="sd">        :param option_name: the name of the configuration option</span>
<span class="sd">        :param scope: unset the option for this profile or globally if not specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">get_option</span><span class="p">(</span><span class="n">option_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span><span class="o">.</span><span class="n">unset_option</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.get_option"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.get_option">[docs]</a>    <span class="k">def</span> <span class="nf">get_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a configuration option for a certain scope.</span>

<span class="sd">        :param option_name: the name of the configuration option</span>
<span class="sd">        :param scope: get the option for this profile or globally if not specified</span>
<span class="sd">        :param default: boolean, If True will return the option default, even if not defined within the given scope</span>
<span class="sd">        :return: the option value or None if not set for the given scope</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">get_option</span><span class="p">(</span><span class="n">option_name</span><span class="p">)</span>

        <span class="c1"># Default value is `None` unless `default=True` and the `option.default` is not `NO_DEFAULT`</span>
        <span class="n">default_value</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">default</span> <span class="k">if</span> <span class="n">default</span> <span class="ow">and</span> <span class="n">option</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_DEFAULT</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Config.store"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the current config to file.</span>

<span class="sd">        .. note:: if the configuration file already exists on disk and its contents differ from those in memory, a</span>
<span class="sd">            backup of the original file on disk will be created before overwriting it.</span>

<span class="sd">        :return: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">from</span> <span class="nn">aiida.common.files</span> <span class="kn">import</span> <span class="n">md5_from_filelike</span><span class="p">,</span> <span class="n">md5_file</span>

        <span class="c1"># If the filepath of this configuration does not yet exist, simply write it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Otherwise, we write the content to a temporary file and compare its md5 checksum with the current config on</span>
        <span class="c1"># disk. When the checksums differ, we first create a backup and only then overwrite the existing file.</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">md5_from_filelike</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="o">!=</span> <span class="n">md5_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Config._write"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.configuration.html#aiida.manage.configuration.Config._write">[docs]</a>    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelike</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the contents of `self.dictionary` to the given file handle.</span>

<span class="sd">        :param filelike: the filelike object to write the current configuration to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">DEFAULT_UMASK</span><span class="p">,</span> <span class="n">DEFAULT_CONFIG_INDENT_SIZE</span>

        <span class="n">umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">DEFAULT_UMASK</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">filelike</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">DEFAULT_CONFIG_INDENT_SIZE</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">umask</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>