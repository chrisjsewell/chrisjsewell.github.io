

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.graph.age_rules &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/togglebutton.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.tools.graph.age_rules</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.graph.age_rules</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Rules for the AiiDA Graph Explorer utility&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="kn">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">InputValidationError</span>
<span class="kn">from</span> <span class="nn">aiida.tools.graph.age_entities</span> <span class="kn">import</span> <span class="n">Basket</span>
<span class="kn">from</span> <span class="nn">aiida.common.lang</span> <span class="kn">import</span> <span class="n">type_check</span>


<div class="viewcode-block" id="Operation"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.Operation">[docs]</a><span class="k">class</span> <span class="nc">Operation</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all AGE explorer classes&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Operation.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.Operation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="n">track_edges</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization method</span>

<span class="sd">        :param max_iterations: maximum number of iterations to perform.</span>
<span class="sd">        :param bool track_edges: if True, will also track and return the edges traversed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_max_iterations</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_edges</span> <span class="o">=</span> <span class="n">track_edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Operation.set_max_iterations"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.Operation.set_max_iterations">[docs]</a>    <span class="k">def</span> <span class="nf">set_max_iterations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the max iterations&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">max_iterations</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;max_iterations has to be an integer or np.inf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iterations_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of iterations performed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span>

<div class="viewcode-block" id="Operation.run"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.Operation.run">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the operational_set and overwrites it with the set of nodes that results</span>
<span class="sd">        from applying the rule (this might or not include the initial set of nodes as</span>
<span class="sd">        well depending on the rule).</span>

<span class="sd">        :type operational_set: :py:class:`aiida.tools.graph.age_entities.Basket`</span>
<span class="sd">        :param operational_set: initital set of nodes to be overwritten by the rule.</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="QueryRule"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.QueryRule">[docs]</a><span class="k">class</span> <span class="nc">QueryRule</span><span class="p">(</span><span class="n">Operation</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parent class for every rule that implements a query.</span>

<span class="sd">    QueryRules take a generic QueryBuilder instance and a set of starting nodes and then</span>
<span class="sd">    perform successive iterations of that query, each one from the set of nodes that the</span>
<span class="sd">    previous one found. Depending on the class of rule used the final result will be</span>
<span class="sd">    either the whole set of nodes traversed (UpdateRule), or only the final set of nodes</span>
<span class="sd">    found in the last iteration of the query (ReplaceRule).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="QueryRule.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.QueryRule.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">querybuilder</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">track_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization method</span>

<span class="sd">        :param querybuilder: an instance of the QueryBuilder class from which to take the</span>
<span class="sd">            procedure for traversal</span>
<span class="sd">        :param int max_iterations: the number of iterations to run this query on (must be</span>
<span class="sd">            a finite number for ReplaceRules)</span>
<span class="sd">        :param bool track_edges: whether to track which edges are traversed and store them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">,</span> <span class="n">track_edges</span><span class="o">=</span><span class="n">track_edges</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_spec_from_path</span><span class="p">(</span><span class="n">queryhelp</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">aiida.orm.querybuilder</span> <span class="kn">import</span> <span class="n">GROUP_ENTITY_TYPE_PREFIX</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;entity_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;entity_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;entity_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;process&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;entity_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
            <span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;nodes&#39;</span>
            <span class="k">elif</span> <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;entity_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">GROUP_ENTITY_TYPE_PREFIX</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;groups&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;not understood entity from ( </span><span class="si">{}</span><span class="s1"> )&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;entity_type&#39;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">queryhelp</span> <span class="o">=</span> <span class="n">querybuilder</span><span class="o">.</span><span class="n">queryhelp</span>

        <span class="c1"># Check if there is any projection:</span>
        <span class="n">query_projections</span> <span class="o">=</span> <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">projection_key</span> <span class="ow">in</span> <span class="n">query_projections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">query_projections</span><span class="p">[</span><span class="n">projection_key</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;The input querybuilder must not have any projections.</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;Instead, it has the following:</span><span class="se">\n</span><span class="s1"> - Key: </span><span class="si">{}</span><span class="se">\n</span><span class="s1"> - Val: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">projection_key</span><span class="p">,</span> <span class="n">query_projections</span><span class="p">[</span><span class="n">projection_key</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">pathspec</span> <span class="ow">in</span> <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pathspec</span><span class="p">[</span><span class="s1">&#39;entity_type&#39;</span><span class="p">]:</span>
                <span class="n">pathspec</span><span class="p">[</span><span class="s1">&#39;entity_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;node.Node.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qbtemplate</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">(</span><span class="o">**</span><span class="n">queryhelp</span><span class="p">)</span>
        <span class="n">queryhelp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qbtemplate</span><span class="o">.</span><span class="n">queryhelp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_tag</span> <span class="o">=</span> <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_tag</span> <span class="o">=</span> <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_querybuilder</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># All of these are set in _init_run:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edge_label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edge_keys</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entity_to_identifier</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_entity_from</span> <span class="o">=</span> <span class="n">get_spec_from_path</span><span class="p">(</span><span class="n">queryhelp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entity_to</span> <span class="o">=</span> <span class="n">get_spec_from_path</span><span class="p">(</span><span class="n">queryhelp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="QueryRule.set_edge_keys"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.QueryRule.set_edge_keys">[docs]</a>    <span class="k">def</span> <span class="nf">set_edge_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the edge keys that are use to classify the edges during the run of this query.</span>

<span class="sd">        :param edge_keys:</span>
<span class="sd">            a list of projections on the edge itself, or a tuple that specifies</span>
<span class="sd">            (tag, project) if the projection is not on the edge</span>

<span class="sd">        Example: For node-to-node graph traversals, it is often convenient to save</span>
<span class="sd">        the information on the links::</span>

<span class="sd">            qb  = QueryBuilder().append(Node, tag=&#39;n1&#39;).append(Node, tag=&#39;n2&#39;)</span>
<span class="sd">            rule = RuleSequence(qb, track_edges=True)</span>
<span class="sd">            rule.set_edge_keys([&#39;input_id&#39;, &#39;output_id&#39;, &#39;label&#39;, &#39;type&#39;])</span>

<span class="sd">            # Now for UUIDS:</span>
<span class="sd">            qb  = QueryBuilder().append(Node, tag=&#39;n1&#39;).append(Node, tag=&#39;n2&#39;)</span>
<span class="sd">            rule = RuleSequence(qb, track_edges=True)</span>
<span class="sd">            rule.set_edge_keys([(&#39;n1&#39;,&#39;uuid&#39;), (&#39;n2&#39;,&#39;uuid&#39;), &#39;label&#39;, &#39;type&#39;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edge_keys</span> <span class="o">=</span> <span class="n">edge_keys</span><span class="p">[:]</span></div>

<div class="viewcode-block" id="QueryRule._init_run"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.QueryRule._init_run">[docs]</a>    <span class="k">def</span> <span class="nf">_init_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization Utility method</span>

<span class="sd">        This method initializes a run. It initializes the accumulator_set in order</span>
<span class="sd">        for it to only contain the operational_set, and to be of the same kind.</span>
<span class="sd">        This function modifies the its QueryBuilder instance to give the right results.</span>

<span class="sd">        :param operational_set: input with which to initialize the accumulator_set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">type_check</span><span class="p">(</span><span class="n">operational_set</span><span class="p">,</span> <span class="n">Basket</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span><span class="p">,</span> <span class="n">Basket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">+=</span> <span class="n">operational_set</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">=</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Copying qbtemplate so there&#39;s no problem if it is used again in a later run:</span>
        <span class="n">queryhelp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qbtemplate</span><span class="o">.</span><span class="n">queryhelp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_querybuilder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">(</span><span class="o">**</span><span class="n">queryhelp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_entity_to_identifier</span> <span class="o">=</span> <span class="n">operational_set</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_to</span><span class="p">]</span><span class="o">.</span><span class="n">identifier</span>

        <span class="c1"># Now I add the necessary projections, which is the identifier of the</span>
        <span class="c1"># last entity of the QueryBuilder path:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_querybuilder</span><span class="o">.</span><span class="n">add_projection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_to_identifier</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_edges</span><span class="p">:</span>
            <span class="c1"># This requires additional projections and the edge_keys, which is a list of tuples (of length 2)</span>
            <span class="c1"># that stores the information what I need to project as well, as in (tag, projection)</span>
            <span class="n">projections</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edge_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edge_label</span> <span class="o">=</span> <span class="n">queryhelp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;edge_tag&#39;</span><span class="p">]</span>

            <span class="c1"># Need to get the edge_set: This is given by entity1_entity2. Here, the results needs to</span>
            <span class="c1"># be sorted somehow in order to ensure that the same key is used when entity_from and</span>
            <span class="c1"># entity_to are exchanged.</span>
            <span class="n">edge_set</span> <span class="o">=</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_from</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_to</span><span class="p">)))]</span>

            <span class="c1"># Looping over the edge identifiers to figure out what I need to project and in which</span>
            <span class="c1"># order. The order is important! The rules:</span>
            <span class="c1"># r1 = Rule(QueryBuilder().append(Group).append(Node, with_group=Group) and</span>
            <span class="c1"># r2 = Rule(QueryBuilder().append(Node).append(Group, with_node=Node)</span>
            <span class="c1"># need still to save their results in the same order (i.e. group_id, node_id).</span>
            <span class="c1"># Therefore, I am sorting the edge_keys according to edge_identifiers specified in the edge_set</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">projection</span> <span class="ow">in</span> <span class="n">edge_set</span><span class="o">.</span><span class="n">edge_identifiers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">:</span>
                    <span class="n">actual_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_label</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_from</span><span class="p">:</span>
                    <span class="n">actual_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_tag</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_to</span><span class="p">:</span>
                    <span class="n">actual_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_tag</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For now I can only specify edge_identifiers as &#39;edge&#39;, ie. project on the edge</span>
                    <span class="c1"># itself, or by the entity_from, entity_to keyword, ie. groups or nodes.</span>
                    <span class="c1"># One could think of other keywords...</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;This tag (</span><span class="si">{}</span><span class="s1">) is not known&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_edge_keys</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">actual_tag</span><span class="p">,</span> <span class="n">projection</span><span class="p">))</span>
                <span class="n">projections</span><span class="p">[</span><span class="n">actual_tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

            <span class="c1"># Telling the QB about the additional projections:</span>
            <span class="k">for</span> <span class="n">proj_tag</span><span class="p">,</span> <span class="n">projectionlist</span> <span class="ow">in</span> <span class="n">projections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_querybuilder</span><span class="o">.</span><span class="n">add_projection</span><span class="p">(</span><span class="n">proj_tag</span><span class="p">,</span> <span class="n">projectionlist</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InputValidationError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;The projection for the edge-identifier is invalid.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueryRule._load_results"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.QueryRule._load_results">[docs]</a>    <span class="k">def</span> <span class="nf">_load_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_set</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Single application of the rules to the operational set</span>

<span class="sd">        :param target_set:</span>
<span class="sd">            where the new results will be loaded (it will be first emptied of all previous content).</span>
<span class="sd">            There is no returned value for this method.</span>
<span class="sd">        :param operational_set: where the results originate from (walkers)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">primkeys</span> <span class="o">=</span> <span class="n">operational_set</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_from</span><span class="p">]</span><span class="o">.</span><span class="n">keyset</span>
        <span class="n">target_set</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">primkeys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_querybuilder</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_first_tag</span><span class="p">,</span> <span class="p">{</span><span class="n">operational_set</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_from</span><span class="p">]</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span> <span class="p">{</span>
                                      <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">primkeys</span>
                                  <span class="p">}}</span>
            <span class="p">)</span>
            <span class="n">qres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_querybuilder</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

            <span class="c1"># These are the new results returned by the query</span>
            <span class="n">target_set</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_to</span><span class="p">]</span><span class="o">.</span><span class="n">add_entities</span><span class="p">([</span>
                <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_tag</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_to_identifier</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">qres</span>
            <span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_edges</span><span class="p">:</span>
                <span class="c1"># As in _init_run, I need the key for the edge_set</span>
                <span class="n">edge_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_from</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_to</span><span class="p">)))</span>
                <span class="n">edge_set</span> <span class="o">=</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]</span>
                <span class="n">namedtuple_</span> <span class="o">=</span> <span class="n">edge_set</span><span class="o">.</span><span class="n">edge_namedtuple</span>

                <span class="n">target_set</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]</span><span class="o">.</span><span class="n">add_entities</span><span class="p">([</span>
                    <span class="n">namedtuple_</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key1</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_keys</span><span class="p">))</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">qres</span>
                <span class="p">])</span></div>

<div class="viewcode-block" id="QueryRule.set_accumulator"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.QueryRule.set_accumulator">[docs]</a>    <span class="k">def</span> <span class="nf">set_accumulator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accumulator_set</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">=</span> <span class="n">accumulator_set</span></div>

<div class="viewcode-block" id="QueryRule.empty_accumulator"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.QueryRule.empty_accumulator">[docs]</a>    <span class="k">def</span> <span class="nf">empty_accumulator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span></div>

    <span class="c1"># Pylint complains if this is not here, but should be removed asap</span>
<div class="viewcode-block" id="QueryRule.run"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.QueryRule.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="UpdateRule"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.UpdateRule">[docs]</a><span class="k">class</span> <span class="nc">UpdateRule</span><span class="p">(</span><span class="n">QueryRule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The UpdateRule will accumulate every node visited and return it as a set of nodes</span>
<span class="sd">    (and thus, without duplication). It can be used requesting both a finite number</span>
<span class="sd">    of iterations or an infinite number of iterations (in which case it will stop once</span>
<span class="sd">    no new nodes are added to the accumulation set).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="UpdateRule.run"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.UpdateRule.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_run</span><span class="p">(</span><span class="n">operational_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_results</span> <span class="o">=</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>

        <span class="c1"># The operational_set will be updated with the new_nodes that were not</span>
        <span class="c1"># already in the _acumulator_set, so that we are not querying from the</span>
        <span class="c1"># same nodes again and the cycle can end when no new nodes are found</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">operational_set</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_results</span><span class="p">(</span><span class="n">new_results</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">)</span>
            <span class="n">operational_set</span> <span class="o">=</span> <span class="n">new_results</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">+=</span> <span class="n">new_results</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ReplaceRule"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.ReplaceRule">[docs]</a><span class="k">class</span> <span class="nc">ReplaceRule</span><span class="p">(</span><span class="n">QueryRule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ReplaceRule does not accumulate results, but just sets the operational_set to</span>
<span class="sd">    new results. Therefore it can only function using a finite number of iterations,</span>
<span class="sd">    since it does not keep track of which nodes where visited already (otherwise, if</span>
<span class="sd">    it was following a cycle, it would run indefinitely).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReplaceRule.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.ReplaceRule.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">querybuilder</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">track_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">max_iterations</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You cannot have max_iterations to be infinitely large for replace rules&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">querybuilder</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">,</span> <span class="n">track_edges</span><span class="o">=</span><span class="n">track_edges</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReplaceRule.run"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.ReplaceRule.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_run</span><span class="p">(</span><span class="n">operational_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_results</span> <span class="o">=</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>

        <span class="c1"># The operational_set will be replaced by the new_nodes, even if these</span>
        <span class="c1"># were already visited previously.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">operational_set</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_results</span><span class="p">(</span><span class="n">new_results</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">)</span>
            <span class="n">operational_set</span> <span class="o">=</span> <span class="n">new_results</span>

        <span class="k">return</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="RuleSaveWalkers"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSaveWalkers">[docs]</a><span class="k">class</span> <span class="nc">RuleSaveWalkers</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save the Walkers:</span>

<span class="sd">    When initialized, this rule will save a pointer to an external stash variable.</span>
<span class="sd">    When run, this stash will be emptied and a given operational_set will be saved</span>
<span class="sd">    there instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RuleSaveWalkers.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSaveWalkers.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stash</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization method</span>

<span class="sd">        :param stash: external variable in which to save the operational_set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stash</span> <span class="o">=</span> <span class="n">stash</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">track_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="RuleSaveWalkers.run"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSaveWalkers.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stash</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stash</span> <span class="o">+=</span> <span class="n">operational_set</span>
        <span class="k">return</span> <span class="n">operational_set</span></div></div>


<div class="viewcode-block" id="RuleSetWalkers"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSetWalkers">[docs]</a><span class="k">class</span> <span class="nc">RuleSetWalkers</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the Walkers:</span>

<span class="sd">    When initialized, this rule will save a pointer to an external stash variable.</span>
<span class="sd">    When run, the given operational_set will be emptied and the stash will be</span>
<span class="sd">    loaded in it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RuleSetWalkers.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSetWalkers.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stash</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization method</span>

<span class="sd">        :param stash: external variable from which to load into the operational_set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stash</span> <span class="o">=</span> <span class="n">stash</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">track_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="RuleSetWalkers.run"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSetWalkers.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="n">operational_set</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="n">operational_set</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stash</span>
        <span class="k">return</span> <span class="n">operational_set</span></div></div>


<div class="viewcode-block" id="RuleSequence"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSequence">[docs]</a><span class="k">class</span> <span class="nc">RuleSequence</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rule for concatenation</span>

<span class="sd">    Rule Sequence is used to concatenate a series of rules together.</span>
<span class="sd">    Concatenating querybuilders in a single rule its not enough because</span>
<span class="sd">    one might want to stash results to perform two independent operations</span>
<span class="sd">    in the starting set instead of a second operation from the results of</span>
<span class="sd">    the first (see RuleSetWalkers and RuleSaveWalkers).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RuleSequence.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSequence.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;rule has to be an instance of Operation-subclass&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span> <span class="o">=</span> <span class="n">rules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">,</span> <span class="n">track_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="RuleSequence.run"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSequence.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operational_set</span><span class="p">):</span>
        <span class="n">type_check</span><span class="p">(</span><span class="n">operational_set</span><span class="p">,</span> <span class="n">Basket</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span><span class="p">,</span> <span class="n">Basket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">+=</span> <span class="n">operational_set</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">=</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span><span class="p">,</span> <span class="n">Basket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span> <span class="o">+=</span> <span class="n">operational_set</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span> <span class="o">=</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">new_results</span> <span class="o">=</span> <span class="n">operational_set</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">operational_set</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterations_done</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">new_results</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>

            <span class="c1"># I iterate the operational_set through all the rules:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">):</span>
                <span class="n">operational_set</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">operational_set</span><span class="p">)</span>
                <span class="n">new_results</span> <span class="o">+=</span> <span class="n">operational_set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span> <span class="o">+=</span> <span class="n">operational_set</span>

            <span class="c1"># I set the operational set to all results that have not been visited yet.</span>
            <span class="n">operational_set</span> <span class="o">=</span> <span class="n">new_results</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">+=</span> <span class="n">new_results</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="RuleSequence.set_accumulator"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSequence.set_accumulator">[docs]</a>    <span class="k">def</span> <span class="nf">set_accumulator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accumulator_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the accumulator set&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="o">=</span> <span class="n">accumulator_set</span></div>

<div class="viewcode-block" id="RuleSequence.empty_accumulator"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSequence.empty_accumulator">[docs]</a>    <span class="k">def</span> <span class="nf">empty_accumulator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Empties the accumulator set&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulator_set</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span></div>

<div class="viewcode-block" id="RuleSequence.set_visits"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSequence.set_visits">[docs]</a>    <span class="k">def</span> <span class="nf">set_visits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visits_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the visits set&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span> <span class="o">=</span> <span class="n">visits_set</span></div>

<div class="viewcode-block" id="RuleSequence.empty_visits"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.graph.html#aiida.tools.graph.age_rules.RuleSequence.empty_visits">[docs]</a>    <span class="k">def</span> <span class="nf">empty_visits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Empties the visits set&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visits_set</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>