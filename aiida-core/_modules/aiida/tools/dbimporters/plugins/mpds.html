

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.dbimporters.plugins.mpds &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
        <script src="../../../../../_static/togglebutton.js"></script>
        <script src="../../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.tools.dbimporters.plugins.mpds</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.dbimporters.plugins.mpds</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">aiida.tools.dbimporters.baseclasses</span> <span class="kn">import</span> <span class="n">CifEntry</span><span class="p">,</span> <span class="n">DbEntry</span><span class="p">,</span> <span class="n">DbImporter</span><span class="p">,</span> <span class="n">DbSearchResults</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">json</span>


<div class="viewcode-block" id="ApiFormat"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.ApiFormat">[docs]</a><span class="k">class</span> <span class="nc">ApiFormat</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">JSON</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>
    <span class="n">CIF</span> <span class="o">=</span> <span class="s1">&#39;cif&#39;</span></div>


<span class="n">DEFAULT_API_FORMAT</span> <span class="o">=</span> <span class="n">ApiFormat</span><span class="o">.</span><span class="n">JSON</span>
<span class="n">CIF_ENTRY_ID_TAG</span> <span class="o">=</span> <span class="s1">&#39;_pauling_file_entry&#39;</span>


<div class="viewcode-block" id="MpdsDbImporter"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsDbImporter">[docs]</a><span class="k">class</span> <span class="nc">MpdsDbImporter</span><span class="p">(</span><span class="n">DbImporter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Database importer for the Materials Platform for Data Science (MPDS)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_url</span> <span class="o">=</span> <span class="s1">&#39;https://api.mpds.io/v0/download/facet&#39;</span>
    <span class="n">_api_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_collection</span> <span class="o">=</span> <span class="s1">&#39;structures&#39;</span>
    <span class="n">_pagesize</span> <span class="o">=</span> <span class="mi">1000</span>

    <span class="n">_supported_keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;props&#39;</span><span class="p">,</span>
        <span class="s1">&#39;elements&#39;</span><span class="p">,</span>
        <span class="s1">&#39;classes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lattices&#39;</span><span class="p">,</span>
        <span class="s1">&#39;formulae&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sgs&#39;</span><span class="p">,</span>
        <span class="s1">&#39;protos&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aeatoms&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aetype&#39;</span><span class="p">,</span>
        <span class="s1">&#39;authors&#39;</span><span class="p">,</span>
        <span class="s1">&#39;codens&#39;</span><span class="p">,</span>
        <span class="s1">&#39;years&#39;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="MpdsDbImporter.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsDbImporter.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate the MpdsDbImporter by setting up the API connection details</span>

<span class="sd">        :param url: the full base url of the REST API endpoint</span>
<span class="sd">        :param api_key: the API key to be used for HTTP requests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_db</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span> <span class="o">=</span> <span class="n">StructuresCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="MpdsDbImporter.setup_db"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsDbImporter.setup_db">[docs]</a>    <span class="k">def</span> <span class="nf">setup_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the required parameters for HTTP requests to the REST API</span>

<span class="sd">        :param url: the full base url of the REST API endpoint</span>
<span class="sd">        :param api_key: the API key to be used for HTTP requests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>

        <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span> <span class="o">=</span> <span class="n">collection</span>

        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MPDS_KEY&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;API key not supplied and MPDS_KEY environment variable not set&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the API key configured for the importer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_key</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the collection that will be queried</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pagesize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the pagesize set for the importer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pagesize</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the structures collection in the MPDS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_supported_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of all supported query keywords</span>

<span class="sd">        :return: list of strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supported_keywords</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the base url configured for the importer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>

<div class="viewcode-block" id="MpdsDbImporter.query"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsDbImporter.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the database with a given dictionary of query parameters for a given collection</span>

<span class="sd">        :param query: a dictionary with the query parameters</span>
<span class="sd">        :param collection: the collection to query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span>

        <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s1">&#39;structures&#39;</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">results_cif</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">results_json</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ApiFormat</span><span class="o">.</span><span class="n">JSON</span><span class="p">):</span>
                <span class="n">results_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ApiFormat</span><span class="o">.</span><span class="n">CIF</span><span class="p">):</span>
                <span class="n">entry_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_id_from_cif</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="n">results_cif</span><span class="p">[</span><span class="n">entry_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">results_json</span><span class="p">:</span>

                <span class="n">entry_id</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cif</span> <span class="o">=</span> <span class="n">results_cif</span><span class="p">[</span><span class="n">entry_id</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># Corresponding cif file was not retrieved, skipping</span>
                    <span class="k">continue</span>

                <span class="n">result_entry</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="n">result_entry</span><span class="p">[</span><span class="s1">&#39;cif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cif</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_entry</span><span class="p">)</span>

            <span class="n">search_results</span> <span class="o">=</span> <span class="n">MpdsSearchResults</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">return_class</span><span class="o">=</span><span class="n">MpdsCifEntry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported collection: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">collection</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">search_results</span></div>

<div class="viewcode-block" id="MpdsDbImporter.find"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsDbImporter.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">DEFAULT_API_FORMAT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the database with a given dictionary of query parameters</span>

<span class="sd">        :param query: a dictionary with the query parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The query argument should be a dictionary&#39;</span><span class="p">)</span>

        <span class="n">pagesize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pagesize</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">query</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ApiFormat</span><span class="o">.</span><span class="n">JSON</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="n">pagesize</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response_content</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ApiFormat</span><span class="o">.</span><span class="n">JSON</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="n">npages</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;npages&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npages</span><span class="p">):</span>

            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">query</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="n">pagesize</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response_content</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">ApiFormat</span><span class="o">.</span><span class="n">JSON</span><span class="p">:</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pagesize</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="p">(</span><span class="n">page</span> <span class="o">*</span> <span class="n">pagesize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">pagesize</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;disclaimer&#39;</span><span class="p">]</span>

                    <span class="k">yield</span> <span class="n">result</span>

            <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">ApiFormat</span><span class="o">.</span><span class="n">CIF</span><span class="p">:</span>

                <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="n">cif</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cif</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data_&#39;</span><span class="p">):</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cif</span><span class="p">)</span>
                            <span class="n">cif</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
                            <span class="k">yield</span> <span class="n">text</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data_&#39;</span><span class="p">):</span>
                            <span class="n">cif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cif</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cif</span><span class="p">)</span></div>

<div class="viewcode-block" id="MpdsDbImporter.get"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsDbImporter.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">DEFAULT_API_FORMAT</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a GET request to the REST API using the kwargs as request parameters</span>
<span class="sd">        The url and API key will be used that were set upon construction</span>

<span class="sd">        :param fmt: the format of the response, &#39;cif&#39; or json&#39; (default)</span>
<span class="sd">        :param kwargs: parameters for the GET request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fmt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">})</span></div>

<div class="viewcode-block" id="MpdsDbImporter.get_response_content"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsDbImporter.get_response_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_response_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">DEFAULT_API_FORMAT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the response of an HTTP GET request, verify that the response code is OK</span>
<span class="sd">        and return the json loaded response text</span>

<span class="sd">        :param response: HTTP response</span>
<span class="sd">        :raises RuntimeError: HTTP response is not 200</span>
<span class="sd">        :raises ValueError: HTTP response 200 contained non zero error message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;HTTP[</span><span class="si">{}</span><span class="s1">] request failed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">ApiFormat</span><span class="o">.</span><span class="n">JSON</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Got error response: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span></div>

<div class="viewcode-block" id="MpdsDbImporter.get_id_from_cif"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsDbImporter.get_id_from_cif">[docs]</a>    <span class="k">def</span> <span class="nf">get_id_from_cif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cif</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the entry id from the string formatted cif response of the MPDS API</span>

<span class="sd">        :param cif: string representation of the cif file</span>
<span class="sd">        :returns: entry id of the cif file or None if could not be found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entry_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cif</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">CIF_ENTRY_ID_TAG</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">entry_id</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">entry_id</span></div></div>


<div class="viewcode-block" id="StructuresCollection"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.StructuresCollection">[docs]</a><span class="k">class</span> <span class="nc">StructuresCollection</span><span class="p">:</span>

<div class="viewcode-block" id="StructuresCollection.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.StructuresCollection.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">engine</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the query engine</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span>

<div class="viewcode-block" id="StructuresCollection.find"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.StructuresCollection.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">DEFAULT_API_FORMAT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the structures collection with a given dictionary of query parameters</span>

<span class="sd">        :param query: a dictionary with the query parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">fmt</span> <span class="o">!=</span> <span class="n">ApiFormat</span><span class="o">.</span><span class="n">CIF</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;object_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;object_type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;S&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="MpdsEntry"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsEntry">[docs]</a><span class="k">class</span> <span class="nc">MpdsEntry</span><span class="p">(</span><span class="n">DbEntry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an MPDS database entry</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MpdsEntry.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsEntry.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the class license from the source dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">license</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;license&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">license</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_license</span> <span class="o">=</span> <span class="n">license</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MpdsCifEntry"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsCifEntry">[docs]</a><span class="k">class</span> <span class="nc">MpdsCifEntry</span><span class="p">(</span><span class="n">CifEntry</span><span class="p">,</span> <span class="n">MpdsEntry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An extension of the MpdsEntry class with the CifEntry class, which will treat</span>
<span class="sd">    the contents property through the URI as a cif file</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MpdsCifEntry.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsCifEntry.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The DbSearchResults base class instantiates a new DbEntry by explicitly passing the url</span>
<span class="sd">        of the entry as an argument. In this case it is the same as the &#39;uri&#39; value that is</span>
<span class="sd">        already contained in the source dictionary so we just copy it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cif</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cif&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cif</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cif</span> <span class="o">=</span> <span class="n">cif</span></div></div>


<div class="viewcode-block" id="MpdsSearchResults"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsSearchResults">[docs]</a><span class="k">class</span> <span class="nc">MpdsSearchResults</span><span class="p">(</span><span class="n">DbSearchResults</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A collection of MpdsEntry query result entries</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_db_name</span> <span class="o">=</span> <span class="s1">&#39;Materials Platform for Data Science&#39;</span>
    <span class="n">_db_uri</span> <span class="o">=</span> <span class="s1">&#39;https://mpds.io/&#39;</span>
    <span class="n">_return_class</span> <span class="o">=</span> <span class="n">MpdsEntry</span>

<div class="viewcode-block" id="MpdsSearchResults.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsSearchResults.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">return_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">return_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_return_class</span> <span class="o">=</span> <span class="n">return_class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="MpdsSearchResults._get_source_dict"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsSearchResults._get_source_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_get_source_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the source information dictionary of an MPDS query result entry</span>

<span class="sd">        :param result_dict: query result entry dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;db_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_name</span><span class="p">,</span>
            <span class="s1">&#39;db_uri&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_uri</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">],</span>
            <span class="s1">&#39;license&#39;</span><span class="p">:</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">],</span>
            <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">],</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s1">&#39;cif&#39;</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="p">:</span>
            <span class="n">source_dict</span><span class="p">[</span><span class="s1">&#39;cif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;cif&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">source_dict</span></div>

<div class="viewcode-block" id="MpdsSearchResults._get_url"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.mpds.MpdsSearchResults._get_url">[docs]</a>    <span class="k">def</span> <span class="nf">_get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the permanent URI of the result entry</span>

<span class="sd">        :param result_dict: query result entry dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>