

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.importexport.migration.v03_to_v04 &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
        <script src="../../../../../_static/togglebutton.js"></script>
        <script src="../../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../migration.html">aiida.tools.importexport.migration</a> &raquo;</li>
        
      <li>aiida.tools.importexport.migration.v03_to_v04</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.importexport.migration.v03_to_v04</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Migration from v0.3 to v0.4, used by `verdi export migrate` command.</span>

<span class="sd">The migration steps are named similarly to the database migrations for Django and SQLAlchemy.</span>
<span class="sd">In the description of each migration, a revision number is given, which refers to the Django migrations.</span>
<span class="sd">The individual Django database migrations may be found at:</span>

<span class="sd">    `aiida.backends.djsite.db.migrations.00XX_&lt;migration-name&gt;.py`</span>

<span class="sd">Where XX are the numbers in the migrations&#39; documentation: REV. 1.0.XX</span>
<span class="sd">And migration-name is the name of the particular migration.</span>
<span class="sd">The individual SQLAlchemy database migrations may be found at:</span>

<span class="sd">    `aiida.backends.sqlalchemy.migrations.versions.&lt;id&gt;_&lt;migration-name&gt;.py`</span>

<span class="sd">Where id is a SQLA id and migration-name is the name of the particular migration.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=invalid-name</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="kn">import</span> <span class="n">echo</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.migration.utils</span> <span class="kn">import</span> <span class="n">verify_metadata_version</span><span class="p">,</span> <span class="n">update_metadata</span><span class="p">,</span> <span class="n">remove_fields</span>


<div class="viewcode-block" id="migration_base_data_plugin_type_string"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_base_data_plugin_type_string">[docs]</a><span class="k">def</span> <span class="nf">migration_base_data_plugin_type_string</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migration: 0009 - REV. 1.0.9</span>
<span class="sd">    `DbNode.type` content changes:</span>
<span class="sd">    &#39;data.base.Bool.&#39;  -&gt; &#39;data.bool.Bool.&#39;</span>
<span class="sd">    &#39;data.base.Float.&#39; -&gt; &#39;data.float.Float.&#39;</span>
<span class="sd">    &#39;data.base.Int.&#39;   -&gt; &#39;data.int.Int.&#39;</span>
<span class="sd">    &#39;data.base.Str.&#39;   -&gt; &#39;data.str.Str.&#39;</span>
<span class="sd">    &#39;data.base.List.&#39;  -&gt; &#39;data.list.List.&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data.base.&#39;</span><span class="p">):</span>
            <span class="n">type_str</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;data.base.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">type_str</span> <span class="o">=</span> <span class="s1">&#39;data.&#39;</span> <span class="o">+</span> <span class="n">type_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="n">type_str</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_str</span></div>


<div class="viewcode-block" id="migration_process_type"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_process_type">[docs]</a><span class="k">def</span> <span class="nf">migration_process_type</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0010 - REV. 1.0.10</span>
<span class="sd">    Add `DbNode.process_type` column</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># For data.json</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;process_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;process_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># For metadata.json</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">][</span><span class="s1">&#39;Node&#39;</span><span class="p">][</span><span class="s1">&#39;process_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="migration_code_sub_class_of_data"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_code_sub_class_of_data">[docs]</a><span class="k">def</span> <span class="nf">migration_code_sub_class_of_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0016 - REV. 1.0.16</span>
<span class="sd">    The Code class used to be just a sub class of Node, but was changed to act like a Data node.</span>
<span class="sd">    code.Code. -&gt; data.code.Code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;code.Code.&#39;</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;data.code.Code.&#39;</span></div>


<div class="viewcode-block" id="migration_add_node_uuid_unique_constraint"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_add_node_uuid_unique_constraint">[docs]</a><span class="k">def</span> <span class="nf">migration_add_node_uuid_unique_constraint</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migration: 0014 - REV. 1.0.14, 0018 - REV. 1.0.18</span>
<span class="sd">    Check that no entries with the same uuid are present in the export file</span>
<span class="sd">    if yes - stop the import process</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">entry_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="s1">&#39;Computer&#39;</span><span class="p">,</span> <span class="s1">&#39;Node&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">entry_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]:</span>  <span class="c1"># if a particular entry type is not present - skip</span>
            <span class="k">continue</span>
        <span class="n">all_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">content</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">][</span><span class="n">entry_type</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">unique_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_uuids</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_uuids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_uuids</span><span class="p">):</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;{}s with exactly the same UUID found, cannot proceed further. Please contact AiiDA</span>
<span class="sd">            developers: http://www.aiida.net/mailing-list/ to help you resolve this issue.&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_type</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="migration_migrate_builtin_calculations"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_migrate_builtin_calculations">[docs]</a><span class="k">def</span> <span class="nf">migration_migrate_builtin_calculations</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0019 - REV. 1.0.19</span>
<span class="sd">    Remove &#39;simpleplugin&#39; from ArithmeticAddCalculation and TemplatereplacerCalculation type</span>

<span class="sd">    ATTENTION:</span>

<span class="sd">    The &#39;process_type&#39; column did not exist before migration 0010, consequently, it could not be present in any</span>
<span class="sd">    export archive of the currently existing stable releases (0.12.*). Here, however, the migration acts</span>
<span class="sd">    on the content of the &#39;process_type&#39; column, which could only be introduced in alpha releases of AiiDA 1.0.</span>
<span class="sd">    Assuming that &#39;add&#39; and &#39;templateplacer&#39; calculations are expected to have both &#39;type&#39; and &#39;process_type&#39; columns,</span>
<span class="sd">    they will be added based solely on the &#39;type&#39; column content (unlike the way it is done in the DB migration,</span>
<span class="sd">    where the &#39;type_string&#39; content was also checked).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;calculation.job.simpleplugins.arithmetic.add.ArithmeticAddCalculation.&#39;</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;calculation.job.arithmetic.add.ArithmeticAddCalculation.&#39;</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;process_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aiida.calculations:arithmetic.add&#39;</span>
        <span class="k">elif</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;calculation.job.simpleplugins.templatereplacer.TemplatereplacerCalculation.&#39;</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;calculation.job.templatereplacer.TemplatereplacerCalculation.&#39;</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;process_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aiida.calculations:templatereplacer&#39;</span>
        <span class="k">elif</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;data.code.Code.&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;input_plugin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;simpleplugins.arithmetic.add&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;input_plugin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;arithmetic.add&#39;</span>

            <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;input_plugin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;simpleplugins.templatereplacer&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;input_plugin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;templatereplacer&#39;</span></div>


<div class="viewcode-block" id="migration_provenance_redesign"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_provenance_redesign">[docs]</a><span class="k">def</span> <span class="nf">migration_provenance_redesign</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-locals,too-many-branches,too-many-statements</span>
    <span class="sd">&quot;&quot;&quot;Apply migration: 0020 - REV. 1.0.20</span>
<span class="sd">    Provenance redesign</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.manage.database.integrity.plugins</span> <span class="kn">import</span> <span class="n">infer_calculation_entry_point</span>
    <span class="kn">from</span> <span class="nn">aiida.manage.database.integrity</span> <span class="kn">import</span> <span class="n">write_database_integrity_violation</span>
    <span class="kn">from</span> <span class="nn">aiida.plugins.entry_point</span> <span class="kn">import</span> <span class="n">ENTRY_POINT_STRING_SEPARATOR</span>

    <span class="n">fallback_cases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">calcjobs_to_migrate</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.job.&#39;</span><span class="p">):</span>
            <span class="n">calcjobs_to_migrate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">calcjobs_to_migrate</span><span class="p">:</span>
        <span class="c1"># step1: rename the type column of process nodes</span>
        <span class="n">mapping_node_entry</span> <span class="o">=</span> <span class="n">infer_calculation_entry_point</span><span class="p">(</span>
            <span class="n">type_strings</span><span class="o">=</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">calcjobs_to_migrate</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">calcjobs_to_migrate</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">type_string</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">entry_point_string</span> <span class="o">=</span> <span class="n">mapping_node_entry</span><span class="p">[</span><span class="n">type_string</span><span class="p">]</span>

            <span class="c1"># If the entry point string does not contain the entry point string separator,</span>
            <span class="c1"># the mapping function was not able to map the type string onto a known entry point string.</span>
            <span class="c1"># As a fallback it uses the modified type string itself.</span>
            <span class="c1"># All affected entries should be logged to file that the user can consult.</span>
            <span class="k">if</span> <span class="n">ENTRY_POINT_STRING_SEPARATOR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry_point_string</span><span class="p">:</span>
                <span class="n">fallback_cases</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">uuid</span><span class="p">,</span> <span class="n">type_string</span><span class="p">,</span> <span class="n">entry_point_string</span><span class="p">])</span>

            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;process_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry_point_string</span>

        <span class="k">if</span> <span class="n">fallback_cases</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;UUID&#39;</span><span class="p">,</span> <span class="s1">&#39;type (old)&#39;</span><span class="p">,</span> <span class="s1">&#39;process_type (fallback)&#39;</span><span class="p">]</span>
            <span class="n">warning_message</span> <span class="o">=</span> <span class="s1">&#39;found calculation nodes with a type string &#39;</span> \
                              <span class="s1">&#39;that could not be mapped onto a known entry point&#39;</span>
            <span class="n">action_message</span> <span class="o">=</span> <span class="s1">&#39;inferred `process_type` for all calculation nodes, &#39;</span> \
                             <span class="s1">&#39;using fallback for unknown entry points&#39;</span>
            <span class="n">write_database_integrity_violation</span><span class="p">(</span><span class="n">fallback_cases</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">,</span> <span class="n">action_message</span><span class="p">)</span>

    <span class="c1"># step2: detect and delete unexpected links</span>
    <span class="n">action_message</span> <span class="o">=</span> <span class="s1">&#39;the link was deleted&#39;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;UUID source&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID target&#39;</span><span class="p">,</span> <span class="s1">&#39;link type&#39;</span><span class="p">,</span> <span class="s1">&#39;link label&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">delete_wrong_links</span><span class="p">(</span><span class="n">node_uuids</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">,</span> <span class="n">action_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete links that are matching link_type and are going from nodes listed in node_uuids&quot;&quot;&quot;</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_links_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;links_uuid&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">node_uuids</span> <span class="ow">and</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">link_type</span><span class="p">:</span>
                <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_links_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;links_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_links_list</span>
        <span class="k">if</span> <span class="n">violations</span><span class="p">:</span>
            <span class="n">write_database_integrity_violation</span><span class="p">(</span><span class="n">violations</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">,</span> <span class="n">action_message</span><span class="p">)</span>

    <span class="c1"># calculations with outgoing CALL links</span>
    <span class="n">calculation_uuids</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span>
            <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.job.&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.inline.&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="n">warning_message</span> <span class="o">=</span> <span class="s1">&#39;detected calculation nodes with outgoing `call` links.&#39;</span>
    <span class="n">delete_wrong_links</span><span class="p">(</span><span class="n">calculation_uuids</span><span class="p">,</span> <span class="s1">&#39;calllink&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">,</span> <span class="n">action_message</span><span class="p">)</span>

    <span class="c1"># calculations with outgoing RETURN links</span>
    <span class="n">warning_message</span> <span class="o">=</span> <span class="s1">&#39;detected calculation nodes with outgoing `return` links.&#39;</span>
    <span class="n">delete_wrong_links</span><span class="p">(</span><span class="n">calculation_uuids</span><span class="p">,</span> <span class="s1">&#39;returnlink&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">,</span> <span class="n">action_message</span><span class="p">)</span>

    <span class="c1"># outgoing CREATE links from FunctionCalculation and WorkCalculation nodes</span>
    <span class="n">warning_message</span> <span class="o">=</span> <span class="s1">&#39;detected outgoing `create` links from FunctionCalculation and/or WorkCalculation nodes.&#39;</span>
    <span class="n">work_uuids</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span>
            <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.function&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.work&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="n">delete_wrong_links</span><span class="p">(</span><span class="n">work_uuids</span><span class="p">,</span> <span class="s1">&#39;createlink&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">,</span> <span class="n">action_message</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># migrate very old `ProcessCalculation` to `WorkCalculation`</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;calculation.process.ProcessCalculation.&#39;</span><span class="p">:</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;calculation.work.WorkCalculation.&#39;</span>

        <span class="c1">#  WorkCalculations that have a `function_name` attribute are FunctionCalculations</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;calculation.work.WorkCalculation.&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s1">&#39;function_name&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="ow">and</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="n">node_id</span><span class="p">][</span><span class="s1">&#39;function_name&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="c1"># for some reason for the workchains the &#39;function_name&#39; attribute is present but has None value</span>
                <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;node.process.workflow.workfunction.WorkFunctionNode.&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;node.process.workflow.workchain.WorkChainNode.&#39;</span>

        <span class="c1"># update type for JobCalculation nodes</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.job.&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;node.process.calculation.calcjob.CalcJobNode.&#39;</span>

        <span class="c1"># update type for InlineCalculation nodes</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;calculation.inline.InlineCalculation.&#39;</span><span class="p">:</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;node.process.calculation.calcfunction.CalcFunctionNode.&#39;</span>

        <span class="c1"># update type for FunctionCalculation nodes</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;calculation.function.FunctionCalculation.&#39;</span><span class="p">:</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;node.process.workflow.workfunction.WorkFunctionNode.&#39;</span>

    <span class="n">uuid_node_type_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]:</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">node</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;links_uuid&#39;</span><span class="p">]:</span>
        <span class="n">inp_uuid</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="c1"># rename `createlink` to `create`</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;createlink&#39;</span><span class="p">:</span>
            <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;create&#39;</span>
        <span class="c1"># rename `returnlink` to `return`</span>
        <span class="k">elif</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;returnlink&#39;</span><span class="p">:</span>
            <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;return&#39;</span>

        <span class="k">elif</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inputlink&#39;</span><span class="p">:</span>
            <span class="c1"># rename `inputlink` to `input_calc` if the target node is a calculation type node</span>
            <span class="k">if</span> <span class="n">uuid_node_type_mapping</span><span class="p">[</span><span class="n">inp_uuid</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;node.process.calculation&#39;</span><span class="p">):</span>
                <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;input_calc&#39;</span>
            <span class="c1"># rename `inputlink` to `input_work` if the target node is a workflow type node</span>
            <span class="k">elif</span> <span class="n">uuid_node_type_mapping</span><span class="p">[</span><span class="n">inp_uuid</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;node.process.workflow&#39;</span><span class="p">):</span>
                <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;input_work&#39;</span>

        <span class="k">elif</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;calllink&#39;</span><span class="p">:</span>
            <span class="c1"># rename `calllink` to `call_calc` if the target node is a calculation type node</span>
            <span class="k">if</span> <span class="n">uuid_node_type_mapping</span><span class="p">[</span><span class="n">inp_uuid</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;node.process.calculation&#39;</span><span class="p">):</span>
                <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;call_calc&#39;</span>
            <span class="c1"># rename `calllink` to `call_work` if the target node is a workflow type node</span>
            <span class="k">elif</span> <span class="n">uuid_node_type_mapping</span><span class="p">[</span><span class="n">inp_uuid</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;node.process.workflow&#39;</span><span class="p">):</span>
                <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;call_work&#39;</span></div>


<div class="viewcode-block" id="migration_dbgroup_name_to_label_type_to_type_string"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_dbgroup_name_to_label_type_to_type_string">[docs]</a><span class="k">def</span> <span class="nf">migration_dbgroup_name_to_label_type_to_type_string</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0021 - REV. 1.0.21</span>
<span class="sd">    Rename dbgroup fields:</span>
<span class="sd">    name -&gt; label</span>
<span class="sd">    type -&gt; type_string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># For data.json</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="c1"># For metadata.json</span>
    <span class="n">metadata_group</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">][</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">metadata_group</span><span class="p">:</span>
        <span class="n">metadata_group</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_group</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">metadata_group</span><span class="p">:</span>
        <span class="n">metadata_group</span><span class="p">[</span><span class="s1">&#39;type_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_group</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="migration_dbgroup_type_string_change_content"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_dbgroup_type_string_change_content">[docs]</a><span class="k">def</span> <span class="nf">migration_dbgroup_type_string_change_content</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0022 - REV. 1.0.22</span>
<span class="sd">    Change type_string according to the following rule:</span>
<span class="sd">    &#39;&#39; -&gt; &#39;user&#39;</span>
<span class="sd">    &#39;data.upf.family&#39; -&gt; &#39;data.upf&#39;</span>
<span class="sd">    &#39;aiida.import&#39; -&gt; &#39;auto.import&#39;</span>
<span class="sd">    &#39;autogroup.run&#39; -&gt; &#39;auto.run&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">key_mapper</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data.upf.family&#39;</span><span class="p">:</span> <span class="s1">&#39;data.upf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;aiida.import&#39;</span><span class="p">:</span> <span class="s1">&#39;auto.import&#39;</span><span class="p">,</span>
            <span class="s1">&#39;autogroup.run&#39;</span><span class="p">:</span> <span class="s1">&#39;auto.run&#39;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type_string&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">key_mapper</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;type_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_mapper</span><span class="p">[</span><span class="n">content</span><span class="p">[</span><span class="s1">&#39;type_string&#39;</span><span class="p">]]</span></div>


<div class="viewcode-block" id="migration_calc_job_option_attribute_keys"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_calc_job_option_attribute_keys">[docs]</a><span class="k">def</span> <span class="nf">migration_calc_job_option_attribute_keys</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0023 - REV. 1.0.23</span>
<span class="sd">    `custom_environment_variables` -&gt; `environment_variables`</span>
<span class="sd">    `jobresource_params` -&gt; `resources`</span>
<span class="sd">    `_process_label` -&gt; `process_label`</span>
<span class="sd">    `parser` -&gt; `parser_name`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Helper function</span>
    <span class="k">def</span> <span class="nf">_migration_calc_job_option_attribute_keys</span><span class="p">(</span><span class="n">attr_id</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply migration 0023 - REV. 1.0.23 for both `node_attributes*` dicts in `data.json`&quot;&quot;&quot;</span>
        <span class="c1"># For CalcJobNodes only</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">][</span><span class="s1">&#39;Node&#39;</span><span class="p">][</span><span class="n">attr_id</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;node.process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">:</span>
            <span class="n">key_mapper</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;custom_environment_variables&#39;</span><span class="p">:</span> <span class="s1">&#39;environment_variables&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jobresource_params&#39;</span><span class="p">:</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span>
                <span class="s1">&#39;parser&#39;</span><span class="p">:</span> <span class="s1">&#39;parser_name&#39;</span>
            <span class="p">}</span>
            <span class="c1"># Need to loop over a clone because the `content` needs to be modified in place</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_mapper</span><span class="p">:</span>
                    <span class="n">content</span><span class="p">[</span><span class="n">key_mapper</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># For all processes</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">][</span><span class="s1">&#39;Node&#39;</span><span class="p">][</span><span class="n">attr_id</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;node.process.&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;_process_label&#39;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">content</span><span class="p">[</span><span class="s1">&#39;process_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_process_label&#39;</span><span class="p">)</span>

    <span class="c1"># Update node_attributes and node_attributes_conversion</span>
    <span class="n">attribute_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">,</span> <span class="s1">&#39;node_attributes_conversion&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">attribute_dict</span> <span class="ow">in</span> <span class="n">attribute_dicts</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr_id</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">attribute_dict</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_id</span><span class="p">,</span> <span class="p">{}):</span>
                <span class="n">_migration_calc_job_option_attribute_keys</span><span class="p">(</span><span class="n">attr_id</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span></div>


<div class="viewcode-block" id="migration_move_data_within_node_module"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_move_data_within_node_module">[docs]</a><span class="k">def</span> <span class="nf">migration_move_data_within_node_module</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0025 - REV. 1.0.25</span>
<span class="sd">    The type string for `Data` nodes changed from `data.*` to `node.data.*`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data.&#39;</span><span class="p">):</span>
            <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;data.&#39;</span><span class="p">,</span> <span class="s1">&#39;node.data.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="migration_trajectory_symbols_to_attribute"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_trajectory_symbols_to_attribute">[docs]</a><span class="k">def</span> <span class="nf">migration_trajectory_symbols_to_attribute</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0026 - REV. 1.0.26 and 0027 - REV. 1.0.27</span>
<span class="sd">    Create the symbols attribute from the repository array for all `TrajectoryData` nodes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.config</span> <span class="kn">import</span> <span class="n">NODES_EXPORT_SUBFOLDER</span>

    <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;node.data.array.trajectory.TrajectoryData.&#39;</span><span class="p">:</span>
            <span class="n">uuid</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span>
            <span class="n">symbols_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">folder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">NODES_EXPORT_SUBFOLDER</span><span class="p">),</span> <span class="n">uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">uuid</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">uuid</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;symbols.npy&#39;</span>
            <span class="p">)</span>
            <span class="n">symbols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">symbols_path</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symbols_path</span><span class="p">)</span>
            <span class="c1"># Update &#39;node_attributes&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;array|symbols&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="n">node_id</span><span class="p">][</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbols</span>
            <span class="c1"># Update &#39;node_attributes_conversion&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes_conversion&#39;</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;array|symbols&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes_conversion&#39;</span><span class="p">][</span><span class="n">node_id</span><span class="p">][</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span></div>


<div class="viewcode-block" id="migration_remove_node_prefix"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_remove_node_prefix">[docs]</a><span class="k">def</span> <span class="nf">migration_remove_node_prefix</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migrations: 0028 - REV. 1.0.28</span>
<span class="sd">    Change node type strings:</span>
<span class="sd">    &#39;node.data.&#39; -&gt; &#39;data.&#39;</span>
<span class="sd">    &#39;node.process.&#39; -&gt; &#39;process.&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;node.data.&#39;</span><span class="p">):</span>
            <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;node.data.&#39;</span><span class="p">,</span> <span class="s1">&#39;data.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;node.process.&#39;</span><span class="p">):</span>
            <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;node.process.&#39;</span><span class="p">,</span> <span class="s1">&#39;process.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="migration_rename_parameter_data_to_dict"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_rename_parameter_data_to_dict">[docs]</a><span class="k">def</span> <span class="nf">migration_rename_parameter_data_to_dict</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migration: 0029 - REV. 1.0.29</span>
<span class="sd">    Update ParameterData to Dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;data.parameter.ParameterData.&#39;</span><span class="p">:</span>
            <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;data.dict.Dict.&#39;</span></div>


<div class="viewcode-block" id="migration_dbnode_type_to_dbnode_node_type"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_dbnode_type_to_dbnode_node_type">[docs]</a><span class="k">def</span> <span class="nf">migration_dbnode_type_to_dbnode_node_type</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migration: 0030 - REV. 1.0.30</span>
<span class="sd">    Renaming DbNode.type to DbNode.node_type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># For data.json</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;node_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="c1"># For metadata.json</span>
    <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">][</span><span class="s1">&#39;Node&#39;</span><span class="p">]:</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">][</span><span class="s1">&#39;Node&#39;</span><span class="p">][</span><span class="s1">&#39;node_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">][</span><span class="s1">&#39;Node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="migration_remove_dbcomputer_enabled"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_remove_dbcomputer_enabled">[docs]</a><span class="k">def</span> <span class="nf">migration_remove_dbcomputer_enabled</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migration: 0031 - REV. 1.0.31</span>
<span class="sd">    Remove DbComputer.enabled</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">remove_fields</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Computer&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="migration_replace_text_field_with_json_field"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migration_replace_text_field_with_json_field">[docs]</a><span class="k">def</span> <span class="nf">migration_replace_text_field_with_json_field</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply migration 0033 - REV. 1.0.33</span>
<span class="sd">    Store dict-values as JSON serializable dicts instead of strings</span>
<span class="sd">    NB! Specific for Django backend</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">json</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Computer&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;transport_params&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">value</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">content</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Log&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">content</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="add_extras"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.add_extras">[docs]</a><span class="k">def</span> <span class="nf">add_extras</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update data.json with the new Extras</span>
<span class="sd">    Since Extras were not available previously and usually only include hashes,</span>
<span class="sd">    the Node ids will be added, but included as empty dicts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">node_extras</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">node_extras_conversion</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{}):</span>
        <span class="n">node_extras</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">node_extras_conversion</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;node_extras&#39;</span><span class="p">:</span> <span class="n">node_extras</span><span class="p">,</span> <span class="s1">&#39;node_extras_conversion&#39;</span><span class="p">:</span> <span class="n">node_extras_conversion</span><span class="p">})</span></div>


<div class="viewcode-block" id="migrate_v3_to_v4"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.migration.html#aiida.tools.importexport.migration.v03_to_v04.migrate_v3_to_v4">[docs]</a><span class="k">def</span> <span class="nf">migrate_v3_to_v4</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Migration of export files from v0.3 to v0.4</span>

<span class="sd">    Note concerning migration 0032 - REV. 1.0.32:</span>
<span class="sd">    Remove legacy workflow tables: DbWorkflow, DbWorkflowData, DbWorkflowStep</span>
<span class="sd">    These were (according to Antimo Marrazzo) never exported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_version</span> <span class="o">=</span> <span class="s1">&#39;0.3&#39;</span>
    <span class="n">new_version</span> <span class="o">=</span> <span class="s1">&#39;0.4&#39;</span>

    <span class="n">verify_metadata_version</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">old_version</span><span class="p">)</span>
    <span class="n">update_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">new_version</span><span class="p">)</span>

    <span class="c1"># The trajectory data migration requires the folder containing all the repository files of the archive</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Apply migrations in correct sequential order</span>
    <span class="n">migration_base_data_plugin_type_string</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_process_type</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">migration_code_sub_class_of_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_add_node_uuid_unique_constraint</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_migrate_builtin_calculations</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_provenance_redesign</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_dbgroup_name_to_label_type_to_type_string</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">migration_dbgroup_type_string_change_content</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_calc_job_option_attribute_keys</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_move_data_within_node_module</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_trajectory_symbols_to_attribute</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
    <span class="n">migration_remove_node_prefix</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_rename_parameter_data_to_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">migration_dbnode_type_to_dbnode_node_type</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">migration_remove_dbcomputer_enabled</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">migration_replace_text_field_with_json_field</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Add Node Extras</span>
    <span class="n">add_extras</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Update metadata.json with the new Log and Comment entities</span>
    <span class="n">new_entities</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Log&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;convert_type&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;loggername&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;levelname&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;dbnode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;related_name&#39;</span><span class="p">:</span> <span class="s1">&#39;dblogs&#39;</span><span class="p">,</span>
                <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="s1">&#39;Node&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;Comment&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;ctime&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;convert_type&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;convert_type&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;dbnode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;related_name&#39;</span><span class="p">:</span> <span class="s1">&#39;dbcomments&#39;</span><span class="p">,</span>
                <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="s1">&#39;Node&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;related_name&#39;</span><span class="p">:</span> <span class="s1">&#39;dbcomments&#39;</span><span class="p">,</span>
                <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_entities</span><span class="p">)</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;unique_identifiers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Log&#39;</span><span class="p">:</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;Comment&#39;</span><span class="p">:</span> <span class="s1">&#39;uuid&#39;</span><span class="p">})</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>