

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pgsu &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>pgsu</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pgsu</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Connect to an existing PostgreSQL cluster as the `postgres` superuser and execute SQL commands.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">subprocess32</span> <span class="k">as</span> <span class="nn">subprocess</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">IntEnum</span>
<span class="kn">import</span> <span class="nn">click</span>

<span class="n">DEFAULT_DSN</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;host&#39;</span><span class="p">:</span>
    <span class="kc">None</span><span class="p">,</span>  <span class="c1"># &#39;localhost&#39; causes psql to connect via method &#39;host&#39; instead of &#39;local&#39;</span>
    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;template1&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># By default, try &quot;sudo&quot; only on Ubuntu</span>
<span class="n">DEFAULT_TRY_SUDO</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">(</span>
<span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span> <span class="ow">and</span> <span class="s1">&#39;Ubuntu&#39;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
<span class="n">DEFAULT_UNIX_USER</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pgsu&#39;</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>


<div class="viewcode-block" id="PostgresConnectionMode"><a class="viewcode-back" href="../apidoc/aiida.manage.external.html#aiida.manage.external.postgres.PostgresConnectionMode">[docs]</a><span class="k">class</span> <span class="nc">PostgresConnectionMode</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describe mode of connecting to postgres.&quot;&quot;&quot;</span>

    <span class="n">DISCONNECTED</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PSYCOPG</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">PSQL</span> <span class="o">=</span> <span class="mi">2</span></div>


<span class="k">class</span> <span class="nc">PGSU</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to an existing PostgreSQL cluster as the `postgres` superuser and execute SQL commands.</span>

<span class="sd">    Tries to use psycopg2 with a fallback to psql subcommands (using ``sudo su`` to run as postgres user).</span>

<span class="sd">    Simple Example::</span>

<span class="sd">        pgsu = PGSU()</span>
<span class="sd">        pgsu.execute(&quot;CREATE USER testuser PASSWORD &#39;testpw&#39;&quot;)</span>

<span class="sd">    Complex Example::</span>

<span class="sd">        pgsu = PGSU(interactive=True, dsn={&#39;port&#39;: 5433})</span>
<span class="sd">        pgsu.execute(&quot;CREATE USER testuser PASSWORD &#39;testpw&#39;&quot;)</span>

<span class="sd">    Note: In PostgreSQL</span>
<span class="sd">     * you cannot drop databases you are currently connected to</span>
<span class="sd">     * &#39;template0&#39; is the unmodifiable template database (which you *cannot* connect to)</span>
<span class="sd">     * &#39;template1&#39; is the modifiable template database (which you *can* connect to)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">dsn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">determine_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store postgres connection info.</span>

<span class="sd">        :param interactive: use True for verdi commands</span>
<span class="sd">        :param quiet: use False to show warnings/exceptions</span>
<span class="sd">        :param dsn: psycopg dictionary containing keys like &#39;host&#39;, &#39;user&#39;, &#39;port&#39;, &#39;database&#39;.</span>
<span class="sd">            It is sufficient to provide only those values that deviate from the defaults.</span>
<span class="sd">        :param determine_setup: Whether to determine setup upon instantiation.</span>
<span class="sd">            You may set this to False and use the &#39;determine_setup()&#39; method instead.</span>
<span class="sd">        :param unix_user: UNIX user to try to &quot;become&quot;, if connection via psycopg2 fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="n">interactive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_mode</span> <span class="o">=</span> <span class="n">PostgresConnectionMode</span><span class="o">.</span><span class="n">DISCONNECTED</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_fail_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_max_tries</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span> <span class="o">=</span> <span class="n">DEFAULT_DSN</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dsn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>

        <span class="c1"># Used on Ubuntu only!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_sudo</span> <span class="o">=</span> <span class="n">DEFAULT_TRY_SUDO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unix_user</span> <span class="o">=</span> <span class="n">DEFAULT_UNIX_USER</span>

        <span class="k">if</span> <span class="n">determine_setup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">determine_setup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute postgres command using determined connection mode.</span>

<span class="sd">        :param command: A psql command line as a str</span>
<span class="sd">        :param kwargs: will be forwarded to _execute_... function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use self.dsn as default kwargs, update with provided dsn</span>
        <span class="n">dsn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dsn</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_mode</span> <span class="o">==</span> <span class="n">PostgresConnectionMode</span><span class="o">.</span><span class="n">PSYCOPG</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_execute_psyco</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dsn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_mode</span> <span class="o">==</span> <span class="n">PostgresConnectionMode</span><span class="o">.</span><span class="n">PSQL</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_execute_su_psql</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dsn</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span>
            <span class="s1">&#39;Could not connect to PostgreSQL server using dsn=</span><span class="si">{}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">dsn</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39;Consider providing connection parameters via PGSU(dsn={...}).&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">determine_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine how to connect as the postgres superuser.</span>

<span class="sd">        Depending on how postgres is set up, psycopg2 can be used to create dbs and db users,</span>
<span class="sd">        otherwise a subprocess has to be used that executes psql as an os user with appropriate permissions.</span>

<span class="sd">        Note: We aim to connect as a superuser (typically &#39;postgres&#39;) with privileges to manipulate (create/drop)</span>
<span class="sd">          databases and database users.</span>

<span class="sd">        :returns success: True, if connection could be established.</span>
<span class="sd">        :rtype success: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dsn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Try to connect as a postgres superuser via psycopg2 (equivalent to using psql).</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Trying to connect via &quot;psycopg2&quot;...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pg_user</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="n">dsn</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_user</span>
            <span class="c1"># First try the host specified (works if &#39;host&#39; has setting &#39;trust&#39; in pg_hba.conf).</span>
            <span class="c1"># Then try local connection (works if &#39;local&#39; has setting &#39;trust&#39; in pg_hba.conf).</span>
            <span class="c1"># Then try &#39;host&#39; localhost via TCP/IP.</span>
            <span class="k">for</span> <span class="n">pg_host</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">]):</span>
                <span class="n">dsn</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_host</span>

                <span class="k">if</span> <span class="n">_try_connect_psycopg</span><span class="p">(</span><span class="o">**</span><span class="n">dsn</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span> <span class="o">=</span> <span class="n">dsn</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection_mode</span> <span class="o">=</span> <span class="n">PostgresConnectionMode</span><span class="o">.</span><span class="n">PSYCOPG</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Ubuntu uses setting &#39;peer&#39; for &#39;local&#39;, i.e. we need to be UNIX user &#39;postgres&#39; in order to connect as</span>
        <span class="c1"># database user &#39;postgres&#39;.</span>
        <span class="c1"># Check if &#39;sudo&#39; is available and try to become &#39;postgres&#39;.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_sudo</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Trying to connect by becoming the &quot;</span><span class="si">%s</span><span class="s1">&quot; unix user...&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">unix_user</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_sudo_exists</span><span class="p">():</span>
                <span class="n">dsn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">dsn</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unix_user</span>

                <span class="k">if</span> <span class="n">_try_su_psql</span><span class="p">(</span><span class="n">interactive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">,</span> <span class="n">dsn</span><span class="o">=</span><span class="n">dsn</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span> <span class="o">=</span> <span class="n">dsn</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection_mode</span> <span class="o">=</span> <span class="n">PostgresConnectionMode</span><span class="o">.</span><span class="n">PSQL</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Could not find `sudo` to become the the &quot;</span><span class="si">%s</span><span class="s1">&quot; unix user.&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unix_user</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_fail_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_setup_detected</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_no_setup_detected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a warning message and calls the failed setup callback</span>

<span class="sd">        :returns: False, if no successful try.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to autodetect postgres setup.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_fail_counter</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_max_tries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span> <span class="o">=</span> <span class="n">prompt_for_dsn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_setup</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">PostgresConnectionMode</span><span class="o">.</span><span class="n">PSYCOPG</span><span class="p">,</span>
                                        <span class="n">PostgresConnectionMode</span><span class="o">.</span><span class="n">PSQL</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prompt_for_dsn</span><span class="p">(</span><span class="n">dsn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prompt interactively for postgres database connection details.</span>

<span class="sd">    :return: dictionary with the keys: host, port, database, user, password</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Please provide PostgreSQL connection info:&#39;</span><span class="p">)</span>

    <span class="c1"># Note: Using &#39;&#39; as the prompt default is necessary to allow users to leave the field empty.</span>
    <span class="c1">#       Using `None` in the dictionary is necessary in order for psycopg2 to interpret the value as not provided.</span>
    <span class="n">dsn_new</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dsn_new</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
        <span class="s1">&#39;postgres host&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="n">dsn_new</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
        <span class="s1">&#39;postgres port&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="n">dsn_new</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
        <span class="s1">&#39;postgres super user&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="n">dsn_new</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
        <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="n">dsn_new</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
        <span class="s1">&#39;postgres password of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dsn_new</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]),</span>
        <span class="c1">#hide_input=True,   # this breaks the input mocking in the tests. could make this configurable instead</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">dsn_new</span>


<span class="k">def</span> <span class="nf">_try_connect_psycopg</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    try to start a psycopg2 connection.</span>

<span class="sd">    :return: True if successful, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">connect</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Unable to connect via psycopg&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">success</span>


<span class="k">def</span> <span class="nf">_execute_psyco</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dsn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    executes a postgres commandline through psycopg2</span>

<span class="sd">    :param command: A psql command line as a str</span>
<span class="sd">    :param dsn: will be forwarded to psycopg2.connect</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">psycopg2</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>

    <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">dsn</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="c1"># see http://initd.org/psycopg/docs/usage.html#with-statement</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">_sudo_exists</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the sudo command can be found</span>

<span class="sd">    :return: True if successful, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;sudo&#39;</span><span class="p">,</span> <span class="s1">&#39;-V&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Failed to run &quot;sudo&quot; in a subprocess&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_try_su_psql</span><span class="p">(</span><span class="n">interactive</span><span class="p">,</span> <span class="n">dsn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to run psql in a subprocess as a different UNIX user.</span>

<span class="sd">    :return: True if successful, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_execute_su_psql</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\q&#39;</span><span class="p">,</span>
                         <span class="n">interactive</span><span class="o">=</span><span class="n">interactive</span><span class="p">,</span>
                         <span class="n">dsn</span><span class="o">=</span><span class="n">dsn</span><span class="p">,</span>
                         <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Failed to run &quot;psql&quot; in a subprocess as user </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                     <span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">))</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_execute_su_psql</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dsn</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes an SQL command via ``psql`` as another system user in a subprocess.</span>

<span class="sd">    Tries to &quot;become&quot; the user specified in ``dsn`` (i.e. interpreted as UNIX system user)</span>
<span class="sd">    and run psql in a subprocess.</span>

<span class="sd">    :param command: A psql command line as a str</span>
<span class="sd">    :param dsn: connection details to forward to psql, signature as in psycopg2.connect</span>
<span class="sd">    :param interactive: If False, `sudo` won&#39;t ask for a password and fail if one is required.</span>
<span class="sd">    :param stderr: Allows redirection of stderr for subprocess call</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">psql_option_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">database</span><span class="p">:</span>
        <span class="n">psql_option_str</span> <span class="o">+=</span> <span class="s1">&#39;-d </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

    <span class="c1"># to do: Forward password to psql; ignore host only when the password is None.  # pylint: disable=fixme</span>
    <span class="c1"># Note: There is currently no known postgresql setup that needs this, though</span>
    <span class="c1"># password = dsn.get(&#39;password&#39;)</span>

    <span class="n">host</span> <span class="o">=</span> <span class="n">dsn</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">host</span> <span class="o">!=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">:</span>
        <span class="n">psql_option_str</span> <span class="o">+=</span> <span class="s1">&#39; -h </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Found host &#39;localhost&#39; but dropping &#39;-h localhost&#39; option for psql &quot;</span>
            <span class="s1">&#39;since this may cause psql to switch to password-based authentication.&#39;</span>
        <span class="p">)</span>

    <span class="n">port</span> <span class="o">=</span> <span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
        <span class="n">psql_option_str</span> <span class="o">+=</span> <span class="s1">&#39; -p </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

    <span class="c1"># Note: This is *both* the UNIX user to become *and* the database user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">dsn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>

    <span class="c1"># Build command line</span>
    <span class="n">sudo_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sudo&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
        <span class="n">sudo_cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-n&#39;</span><span class="p">]</span>
    <span class="n">su_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;su&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span>

    <span class="n">psql_cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;psql </span><span class="si">{opt}</span><span class="s1"> -tc </span><span class="si">{cmd}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">escape_for_bash</span><span class="p">(</span><span class="n">command</span><span class="p">),</span>
                                      <span class="n">opt</span><span class="o">=</span><span class="n">psql_option_str</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">sudo_su_psql</span> <span class="o">=</span> <span class="n">sudo_cmd</span> <span class="o">+</span> <span class="n">su_cmd</span> <span class="o">+</span> <span class="n">psql_cmd</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Trying to become &#39;</span><span class="si">%s</span><span class="s2">&#39; user. You may be asked for your &#39;sudo&#39; password.&quot;</span><span class="p">,</span>
        <span class="n">user</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">sudo_su_psql</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">escape_for_bash</span><span class="p">(</span><span class="n">str_to_escape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes any string and escapes it in a way that</span>
<span class="sd">    bash will interpret it as a single string.</span>

<span class="sd">    Explanation:</span>

<span class="sd">    At the end, in the return statement, the string is put within single</span>
<span class="sd">    quotes. Therefore, the only thing that I have to escape in bash is the</span>
<span class="sd">    single quote character. To do this, I substitute every single</span>
<span class="sd">    quote &#39; with &#39;&quot;&#39;&quot;&#39; which means:</span>

<span class="sd">    First single quote: exit from the enclosing single quotes</span>

<span class="sd">    Second, third and fourth character: &quot;&#39;&quot; is a single quote character,</span>
<span class="sd">    escaped by double quotes</span>

<span class="sd">    Last single quote: reopen the single quote to continue the string</span>

<span class="sd">    Finally, note that for python I have to enclose the string &#39;&quot;&#39;&quot;&#39;</span>
<span class="sd">    within triple quotes to make it work, getting finally: the complicated</span>
<span class="sd">    string found below.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">escaped_quotes</span> <span class="o">=</span> <span class="n">str_to_escape</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escaped_quotes</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>