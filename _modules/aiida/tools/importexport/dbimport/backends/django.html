

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.importexport.dbimport.backends.django &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
        <script src="../../../../../../_static/language_data.js"></script>
        <script src="../../../../../../_static/togglebutton.js"></script>
        <script src="../../../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../../dbimport.html">aiida.tools.importexport.dbimport</a> &raquo;</li>
        
      <li>aiida.tools.importexport.dbimport.backends.django</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.importexport.dbimport.backends.django</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="c1"># pylint: disable=protected-access,fixme,inconsistent-return-statements,too-many-arguments,too-many-locals,too-many-statements,too-many-branches</span>
<span class="sd">&quot;&quot;&quot; Django-specific import of AiiDA entities &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">distutils.version</span> <span class="kn">import</span> <span class="n">StrictVersion</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">from</span> <span class="nn">aiida.common.folders</span> <span class="kn">import</span> <span class="n">SandboxFolder</span><span class="p">,</span> <span class="n">RepositoryFolder</span>
<span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="kn">import</span> <span class="n">LinkType</span><span class="p">,</span> <span class="n">validate_link_label</span>
<span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="kn">import</span> <span class="n">grouper</span><span class="p">,</span> <span class="n">get_object_from_string</span>
<span class="kn">from</span> <span class="nn">aiida.orm.utils.repository</span> <span class="kn">import</span> <span class="n">Repository</span>
<span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">QueryBuilder</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Group</span><span class="p">,</span> <span class="n">ImportGroup</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.archive</span> <span class="kn">import</span> <span class="n">extract_tree</span><span class="p">,</span> <span class="n">extract_tar</span><span class="p">,</span> <span class="n">extract_zip</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.config</span> <span class="kn">import</span> <span class="n">DUPL_SUFFIX</span><span class="p">,</span> <span class="n">EXPORT_VERSION</span><span class="p">,</span> <span class="n">NODES_EXPORT_SUBFOLDER</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NODE_ENTITY_NAME</span><span class="p">,</span> <span class="n">GROUP_ENTITY_NAME</span><span class="p">,</span> <span class="n">COMPUTER_ENTITY_NAME</span><span class="p">,</span> <span class="n">USER_ENTITY_NAME</span><span class="p">,</span> <span class="n">LOG_ENTITY_NAME</span><span class="p">,</span> <span class="n">COMMENT_ENTITY_NAME</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.config</span> <span class="kn">import</span> <span class="n">entity_names_to_signatures</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.utils</span> <span class="kn">import</span> <span class="n">export_shard_uuid</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.dbimport.backends.utils</span> <span class="kn">import</span> <span class="n">deserialize_field</span><span class="p">,</span> <span class="n">merge_comment</span><span class="p">,</span> <span class="n">merge_extras</span>
<span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="kn">import</span> <span class="n">get_config_option</span>


<div class="viewcode-block" id="import_data_dj"><a class="viewcode-back" href="../../../../../../apidoc/aiida.tools.importexport.dbimport.backends.django.html#aiida.tools.importexport.dbimport.backends.django.import_data_dj">[docs]</a><span class="k">def</span> <span class="nf">import_data_dj</span><span class="p">(</span>
    <span class="n">in_path</span><span class="p">,</span>
    <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_unknown_nodes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">extras_mode_existing</span><span class="o">=</span><span class="s1">&#39;kcl&#39;</span><span class="p">,</span>
    <span class="n">extras_mode_new</span><span class="o">=</span><span class="s1">&#39;import&#39;</span><span class="p">,</span>
    <span class="n">comment_mode</span><span class="o">=</span><span class="s1">&#39;newest&#39;</span><span class="p">,</span>
    <span class="n">silent</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import exported AiiDA archive to the AiiDA database and repository.</span>

<span class="sd">    Specific for the Django backend.</span>
<span class="sd">    If ``in_path`` is a folder, calls extract_tree; otherwise, tries to detect the compression format</span>
<span class="sd">    (zip, tar.gz, tar.bz2, ...) and calls the correct function.</span>

<span class="sd">    :param in_path: the path to a file or folder that can be imported in AiiDA.</span>
<span class="sd">    :type in_path: str</span>

<span class="sd">    :param group: Group wherein all imported Nodes will be placed.</span>
<span class="sd">    :type group: :py:class:`~aiida.orm.groups.Group`</span>

<span class="sd">    :param extras_mode_existing: 3 letter code that will identify what to do with the extras import.</span>
<span class="sd">        The first letter acts on extras that are present in the original node and not present in the imported node.</span>
<span class="sd">        Can be either:</span>
<span class="sd">        &#39;k&#39; (keep it) or</span>
<span class="sd">        &#39;n&#39; (do not keep it).</span>
<span class="sd">        The second letter acts on the imported extras that are not present in the original node.</span>
<span class="sd">        Can be either:</span>
<span class="sd">        &#39;c&#39; (create it) or</span>
<span class="sd">        &#39;n&#39; (do not create it).</span>
<span class="sd">        The third letter defines what to do in case of a name collision.</span>
<span class="sd">        Can be either:</span>
<span class="sd">        &#39;l&#39; (leave the old value),</span>
<span class="sd">        &#39;u&#39; (update with a new value),</span>
<span class="sd">        &#39;d&#39; (delete the extra), or</span>
<span class="sd">        &#39;a&#39; (ask what to do if the content is different).</span>
<span class="sd">    :type extras_mode_existing: str</span>

<span class="sd">    :param extras_mode_new: &#39;import&#39; to import extras of new nodes or &#39;none&#39; to ignore them.</span>
<span class="sd">    :type extras_mode_new: str</span>

<span class="sd">    :param comment_mode: Comment import modes (when same UUIDs are found).</span>
<span class="sd">        Can be either:</span>
<span class="sd">        &#39;newest&#39; (will keep the Comment with the most recent modification time (mtime)) or</span>
<span class="sd">        &#39;overwrite&#39; (will overwrite existing Comments with the ones from the import file).</span>
<span class="sd">    :type comment_mode: str</span>

<span class="sd">    :param silent: suppress prints.</span>
<span class="sd">    :type silent: bool</span>

<span class="sd">    :return: New and existing Nodes and Links.</span>
<span class="sd">    :rtype: dict</span>

<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.ImportValidationError`: if parameters or the contents of</span>
<span class="sd">        `metadata.json` or `data.json` can not be validated.</span>
<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.CorruptArchive`: if the provided archive at ``in_path`` is</span>
<span class="sd">        corrupted.</span>
<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.IncompatibleArchiveVersionError`: if the provided archive&#39;s</span>
<span class="sd">        export version is not equal to the export version of AiiDA at the moment of import.</span>
<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.ArchiveImportError`: if there are any internal errors when</span>
<span class="sd">        importing.</span>
<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.ImportUniquenessError`: if a new unique entity can not be</span>
<span class="sd">        created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>
    <span class="kn">from</span> <span class="nn">aiida.backends.djsite.db</span> <span class="kn">import</span> <span class="n">models</span>

    <span class="c1"># This is the export version expected by this function</span>
    <span class="n">expected_export_version</span> <span class="o">=</span> <span class="n">StrictVersion</span><span class="p">(</span><span class="n">EXPORT_VERSION</span><span class="p">)</span>

    <span class="c1"># The returned dictionary with new and existing nodes and links</span>
    <span class="n">ret_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Initial check(s)</span>
    <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span><span class="s1">&#39;group must be a Group entity&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">group</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

    <span class="c1">################</span>
    <span class="c1"># EXTRACT DATA #</span>
    <span class="c1">################</span>
    <span class="c1"># The sandbox has to remain open until the end</span>
    <span class="k">with</span> <span class="n">SandboxFolder</span><span class="p">()</span> <span class="k">as</span> <span class="n">folder</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
            <span class="n">extract_tree</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
                <span class="n">extract_tar</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">nodes_export_subfolder</span><span class="o">=</span><span class="n">NODES_EXPORT_SUBFOLDER</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">extract_zip</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">nodes_export_subfolder</span><span class="o">=</span><span class="n">NODES_EXPORT_SUBFOLDER</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The following problem occured while processing the provided file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                    <span class="s1">&#39;Unable to detect the input file format, it is neither a &#39;</span>
                    <span class="s1">&#39;(possibly compressed) tar file, nor a zip file.&#39;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="o">.</span><span class="n">get_content_list</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CorruptArchive</span><span class="p">(</span><span class="s1">&#39;The provided file/folder (</span><span class="si">{}</span><span class="s1">) is empty&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_path</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fhandle</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s1">&#39;data.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fhandle</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CorruptArchive</span><span class="p">(</span>
                <span class="s1">&#39;Unable to find the file </span><span class="si">{}</span><span class="s1"> in the import file or folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1">######################</span>
        <span class="c1"># PRELIMINARY CHECKS #</span>
        <span class="c1">######################</span>
        <span class="n">export_version</span> <span class="o">=</span> <span class="n">StrictVersion</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;export_version&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">export_version</span> <span class="o">!=</span> <span class="n">expected_export_version</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Export file version is </span><span class="si">{}</span><span class="s1">, can import only version </span><span class="si">{}</span><span class="s1">&#39;</span>\
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;export_version&#39;</span><span class="p">],</span> <span class="n">expected_export_version</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">export_version</span> <span class="o">&lt;</span> <span class="n">expected_export_version</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Use &#39;verdi export migrate&#39; to update this export file.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Update your AiiDA version in order to import this file.&#39;</span>

            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">IncompatibleArchiveVersionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1">##########################################################################</span>
        <span class="c1"># CREATE UUID REVERSE TABLES AND CHECK IF I HAVE ALL NODES FOR THE LINKS #</span>
        <span class="c1">##########################################################################</span>
        <span class="n">linked_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">((</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;links_uuid&#39;</span><span class="p">]))</span>
        <span class="n">group_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;groups_uuid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">NODE_ENTITY_NAME</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]:</span>
            <span class="n">import_nodes_uuid</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">][</span><span class="n">NODE_ENTITY_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">import_nodes_uuid</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># the combined set of linked_nodes and group_nodes was obtained from looking at all the links</span>
        <span class="c1"># the set of import_nodes_uuid was received from the stuff actually referred to in export_data</span>
        <span class="n">unknown_nodes</span> <span class="o">=</span> <span class="n">linked_nodes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">group_nodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">import_nodes_uuid</span>

        <span class="k">if</span> <span class="n">unknown_nodes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_unknown_nodes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DanglingLinkError</span><span class="p">(</span>
                <span class="s1">&#39;The import file refers to </span><span class="si">{}</span><span class="s1"> nodes with unknown UUID, therefore it cannot be imported. Either first &#39;</span>
                <span class="s1">&#39;import the unknown nodes, or export also the parents when exporting. The unknown UUIDs are:</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unknown_nodes</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;* </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">unknown_nodes</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1">###################################</span>
        <span class="c1"># DOUBLE-CHECK MODEL DEPENDENCIES #</span>
        <span class="c1">###################################</span>
        <span class="c1"># The entity import order. It is defined by the database model relationships.</span>

        <span class="n">model_order</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">USER_ENTITY_NAME</span><span class="p">,</span> <span class="n">COMPUTER_ENTITY_NAME</span><span class="p">,</span> <span class="n">NODE_ENTITY_NAME</span><span class="p">,</span> <span class="n">GROUP_ENTITY_NAME</span><span class="p">,</span> <span class="n">LOG_ENTITY_NAME</span><span class="p">,</span>
            <span class="n">COMMENT_ENTITY_NAME</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">import_field_name</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">import_field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_order</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;You are trying to import an unknown model &#39;</span><span class="si">{}</span><span class="s2">&#39;!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">import_field_name</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_order</span><span class="p">):</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;requires&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># (No ForeignKey)</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dependency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_order</span><span class="p">[:</span><span class="n">idx</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveImportError</span><span class="p">(</span>
                        <span class="s1">&#39;Model </span><span class="si">{}</span><span class="s1"> requires </span><span class="si">{}</span><span class="s1"> but would be loaded first; stopping...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">dependency</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1">###################################################</span>
        <span class="c1"># CREATE IMPORT DATA DIRECT UNIQUE_FIELD MAPPINGS #</span>
        <span class="c1">###################################################</span>
        <span class="n">import_unique_ids_mappings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">import_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;unique_identifiers&#39;</span><span class="p">]:</span>
                <span class="c1"># I have to reconvert the pk to integer</span>
                <span class="n">import_unique_ids_mappings</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span><span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;unique_identifiers&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">import_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>

        <span class="c1">###############</span>
        <span class="c1"># IMPORT DATA #</span>
        <span class="c1">###############</span>
        <span class="c1"># DO ALL WITH A TRANSACTION</span>

        <span class="c1"># batch size for bulk create operations</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">get_config_option</span><span class="p">(</span><span class="s1">&#39;db.batch_size&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
            <span class="n">foreign_ids_reverse_mappings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">new_entries</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">existing_entries</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># I first generate the list of data</span>
            <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_order</span><span class="p">:</span>
                <span class="n">cls_signature</span> <span class="o">=</span> <span class="n">entity_names_to_signatures</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">get_object_from_string</span><span class="p">(</span><span class="n">cls_signature</span><span class="p">)</span>
                <span class="n">fields_info</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">unique_identifier</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;unique_identifiers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="n">new_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">existing_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># Not necessarily all models are exported</span>
                <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]:</span>

                    <span class="c1"># skip nodes that are already present in the DB</span>
                    <span class="k">if</span> <span class="n">unique_identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">import_unique_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">unique_identifier</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

                        <span class="n">relevant_db_entries_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                            <span class="o">**</span><span class="p">{</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">__in&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unique_identifier</span><span class="p">):</span> <span class="n">import_unique_ids</span><span class="p">}</span>
                        <span class="p">)</span>
                        <span class="c1"># Note: uuids need to be converted to strings</span>
                        <span class="n">relevant_db_entries</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">unique_identifier</span><span class="p">)):</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">relevant_db_entries_result</span>
                        <span class="p">}</span>

                        <span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">relevant_db_entries</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">unique_identifier</span><span class="p">]</span> <span class="ow">in</span> <span class="n">relevant_db_entries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="c1"># Already in DB</span>
                                <span class="n">existing_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># To be added</span>
                                <span class="n">new_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Show Comment mode if not silent</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Comment mode: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment_mode</span><span class="p">))</span>

            <span class="c1"># I import data from the given model</span>
            <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_order</span><span class="p">:</span>
                <span class="n">cls_signature</span> <span class="o">=</span> <span class="n">entity_names_to_signatures</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">get_object_from_string</span><span class="p">(</span><span class="n">cls_signature</span><span class="p">)</span>
                <span class="n">fields_info</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">unique_identifier</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;unique_identifiers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># EXISTING ENTRIES</span>
                <span class="k">for</span> <span class="n">import_entry_pk</span><span class="p">,</span> <span class="n">entry_data</span> <span class="ow">in</span> <span class="n">existing_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">unique_id</span> <span class="o">=</span> <span class="n">entry_data</span><span class="p">[</span><span class="n">unique_identifier</span><span class="p">]</span>
                    <span class="n">existing_entry_id</span> <span class="o">=</span> <span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">unique_id</span><span class="p">]</span>
                    <span class="n">import_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">deserialize_field</span><span class="p">(</span>
                            <span class="n">k</span><span class="p">,</span>
                            <span class="n">v</span><span class="p">,</span>
                            <span class="n">fields_info</span><span class="o">=</span><span class="n">fields_info</span><span class="p">,</span>
                            <span class="n">import_unique_ids_mappings</span><span class="o">=</span><span class="n">import_unique_ids_mappings</span><span class="p">,</span>
                            <span class="n">foreign_ids_reverse_mappings</span><span class="o">=</span><span class="n">foreign_ids_reverse_mappings</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">entry_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="c1"># TODO COMPARE, AND COMPARE ATTRIBUTES</span>

                    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">models</span><span class="o">.</span><span class="n">DbComment</span><span class="p">:</span>
                        <span class="n">new_entry_uuid</span> <span class="o">=</span> <span class="n">merge_comment</span><span class="p">(</span><span class="n">import_data</span><span class="p">,</span> <span class="n">comment_mode</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_entry_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">entry_data</span><span class="p">[</span><span class="n">unique_identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_entry_uuid</span>
                            <span class="n">new_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">import_entry_pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry_data</span>

                    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret_dict</span><span class="p">:</span>
                        <span class="n">ret_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;new&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;existing&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="n">ret_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="s1">&#39;existing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">import_entry_pk</span><span class="p">,</span> <span class="n">existing_entry_id</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;existing </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">-&gt;</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">import_entry_pk</span><span class="p">,</span> <span class="n">existing_entry_id</span><span class="p">))</span>
                        <span class="c1"># print(&quot;  `-&gt; WARNING: NO DUPLICITY CHECK DONE!&quot;)</span>
                        <span class="c1"># CHECK ALSO FILES!</span>

                <span class="c1"># Store all objects for this model in a list, and store them all in once at the end.</span>
                <span class="n">objects_to_create</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># This is needed later to associate the import entry with the new pk</span>
                <span class="n">import_new_entry_pks</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">imported_comp_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="c1"># NEW ENTRIES</span>
                <span class="k">for</span> <span class="n">import_entry_pk</span><span class="p">,</span> <span class="n">entry_data</span> <span class="ow">in</span> <span class="n">new_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">unique_id</span> <span class="o">=</span> <span class="n">entry_data</span><span class="p">[</span><span class="n">unique_identifier</span><span class="p">]</span>
                    <span class="n">import_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">deserialize_field</span><span class="p">(</span>
                            <span class="n">k</span><span class="p">,</span>
                            <span class="n">v</span><span class="p">,</span>
                            <span class="n">fields_info</span><span class="o">=</span><span class="n">fields_info</span><span class="p">,</span>
                            <span class="n">import_unique_ids_mappings</span><span class="o">=</span><span class="n">import_unique_ids_mappings</span><span class="p">,</span>
                            <span class="n">foreign_ids_reverse_mappings</span><span class="o">=</span><span class="n">foreign_ids_reverse_mappings</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">entry_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">models</span><span class="o">.</span><span class="n">DbGroup</span><span class="p">:</span>
                        <span class="c1"># Check if there is already a group with the same name</span>
                        <span class="n">dupl_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">orig_label</span> <span class="o">=</span> <span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                        <span class="k">while</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]):</span>
                            <span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_label</span> <span class="o">+</span> <span class="n">DUPL_SUFFIX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dupl_counter</span><span class="p">)</span>
                            <span class="n">dupl_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">dupl_counter</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportUniquenessError</span><span class="p">(</span>
                                    <span class="s1">&#39;A group of that label ( </span><span class="si">{}</span><span class="s1"> ) already exists and I could not create a new one&#39;</span>
                                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig_label</span><span class="p">)</span>
                                <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">models</span><span class="o">.</span><span class="n">DbComputer</span><span class="p">:</span>
                        <span class="c1"># Check if there is already a computer with the same name in the database</span>
                        <span class="n">dupl</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">imported_comp_names</span>
                        <span class="p">)</span>
                        <span class="n">orig_name</span> <span class="o">=</span> <span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="n">dupl_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">while</span> <span class="n">dupl</span><span class="p">:</span>
                            <span class="c1"># Rename the new computer</span>
                            <span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">orig_name</span> <span class="o">+</span> <span class="n">DUPL_SUFFIX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dupl_counter</span><span class="p">))</span>
                            <span class="n">dupl</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="ow">or</span>
                                <span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">imported_comp_names</span>
                            <span class="p">)</span>
                            <span class="n">dupl_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">dupl_counter</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportUniquenessError</span><span class="p">(</span>
                                    <span class="s1">&#39;A computer of that name ( </span><span class="si">{}</span><span class="s1"> ) already exists and I could not create a new one&#39;</span>
                                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig_name</span><span class="p">)</span>
                                <span class="p">)</span>

                        <span class="n">imported_comp_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">import_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

                    <span class="n">objects_to_create</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">import_data</span><span class="p">))</span>
                    <span class="n">import_new_entry_pks</span><span class="p">[</span><span class="n">unique_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">import_entry_pk</span>

                <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="n">NODE_ENTITY_NAME</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING NEW NODE REPOSITORY FILES...&#39;</span><span class="p">)</span>

                    <span class="c1"># NEW NODES</span>
                    <span class="k">for</span> <span class="n">object_</span> <span class="ow">in</span> <span class="n">objects_to_create</span><span class="p">:</span>
                        <span class="n">import_entry_uuid</span> <span class="o">=</span> <span class="n">object_</span><span class="o">.</span><span class="n">uuid</span>
                        <span class="n">import_entry_pk</span> <span class="o">=</span> <span class="n">import_new_entry_pks</span><span class="p">[</span><span class="n">import_entry_uuid</span><span class="p">]</span>

                        <span class="c1"># Before storing entries in the DB, I store the files (if these are nodes).</span>
                        <span class="c1"># Note: only for new entries!</span>
                        <span class="n">subfolder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">get_subfolder</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NODES_EXPORT_SUBFOLDER</span><span class="p">,</span> <span class="n">export_shard_uuid</span><span class="p">(</span><span class="n">import_entry_uuid</span><span class="p">))</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">subfolder</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CorruptArchive</span><span class="p">(</span>
                                <span class="s1">&#39;Unable to find the repository folder for Node with UUID=</span><span class="si">{}</span><span class="s1"> in the exported &#39;</span>
                                <span class="s1">&#39;file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">import_entry_uuid</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="n">destdir</span> <span class="o">=</span> <span class="n">RepositoryFolder</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">Repository</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">import_entry_uuid</span><span class="p">)</span>
                        <span class="c1"># Replace the folder, possibly destroying existing previous folders, and move the files</span>
                        <span class="c1"># (faster if we are on the same filesystem, and in any case the source is a SandboxFolder)</span>
                        <span class="n">destdir</span><span class="o">.</span><span class="n">replace_with_folder</span><span class="p">(</span><span class="n">subfolder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">move</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="c1"># For DbNodes, we also have to store its attributes</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING NEW NODE ATTRIBUTES...&#39;</span><span class="p">)</span>

                        <span class="c1"># Get attributes from import file</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">object_</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_attributes&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">import_entry_pk</span><span class="p">)]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CorruptArchive</span><span class="p">(</span>
                                <span class="s1">&#39;Unable to find attribute info for Node with UUID=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">import_entry_uuid</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="c1"># For DbNodes, we also have to store its extras</span>
                        <span class="k">if</span> <span class="n">extras_mode_new</span> <span class="o">==</span> <span class="s1">&#39;import&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING NEW NODE EXTRAS...&#39;</span><span class="p">)</span>

                            <span class="c1"># Get extras from import file</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">extras</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_extras&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">import_entry_pk</span><span class="p">)]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CorruptArchive</span><span class="p">(</span>
                                    <span class="s1">&#39;Unable to find extra info for Node with UUID=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">import_entry_uuid</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="c1"># TODO: remove when aiida extras will be moved somewhere else</span>
                            <span class="c1"># from here</span>
                            <span class="n">extras</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extras</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_aiida_&#39;</span><span class="p">)}</span>
                            <span class="k">if</span> <span class="n">object_</span><span class="o">.</span><span class="n">node_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;code.Code.&#39;</span><span class="p">):</span>
                                <span class="n">extras</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extras</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hidden&#39;</span><span class="p">}</span>
                            <span class="c1"># till here</span>
                            <span class="n">object_</span><span class="o">.</span><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span>
                        <span class="k">elif</span> <span class="n">extras_mode_new</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SKIPPING NEW NODE EXTRAS...&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                                <span class="s2">&quot;Unknown extras_mode_new value: </span><span class="si">{}</span><span class="s2">, should be either &#39;import&#39; or &#39;none&#39;&quot;</span>
                                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extras_mode_new</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="c1"># EXISTING NODES (Extras)</span>
                    <span class="c1"># For the existing nodes that are also in the imported list we also update their extras if necessary</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;UPDATING EXISTING NODE EXTRAS (mode: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extras_mode_existing</span><span class="p">))</span>

                    <span class="n">import_existing_entry_pks</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">entry_data</span><span class="p">[</span><span class="n">unique_identifier</span><span class="p">]:</span> <span class="n">import_entry_pk</span>
                        <span class="k">for</span> <span class="n">import_entry_pk</span><span class="p">,</span> <span class="n">entry_data</span> <span class="ow">in</span> <span class="n">existing_entries</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">DbNode</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">uuid__in</span><span class="o">=</span><span class="n">import_existing_entry_pks</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>  <span class="c1"># pylint: disable=no-member</span>
                        <span class="n">import_entry_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
                        <span class="n">import_entry_pk</span> <span class="o">=</span> <span class="n">import_existing_entry_pks</span><span class="p">[</span><span class="n">import_entry_uuid</span><span class="p">]</span>

                        <span class="c1"># Get extras from import file</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">extras</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;node_extras&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">import_entry_pk</span><span class="p">)]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CorruptArchive</span><span class="p">(</span>
                                <span class="s1">&#39;Unable to find extra info for ode with UUID=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">import_entry_uuid</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="c1"># TODO: remove when aiida extras will be moved somewhere else</span>
                        <span class="c1"># from here</span>
                        <span class="n">extras</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extras</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_aiida_&#39;</span><span class="p">)}</span>
                        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;code.Code.&#39;</span><span class="p">):</span>
                            <span class="n">extras</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extras</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hidden&#39;</span><span class="p">}</span>
                        <span class="c1"># till here</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">extras</span> <span class="o">=</span> <span class="n">merge_extras</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">extras</span><span class="p">,</span> <span class="n">extras</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="p">)</span>

                        <span class="c1"># Already saving existing node here to update its extras</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># If there is an mtime in the field, disable the automatic update</span>
                <span class="c1"># to keep the mtime that we have set here</span>
                <span class="k">if</span> <span class="s1">&#39;mtime&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">local_fields</span><span class="p">]:</span>
                    <span class="k">with</span> <span class="n">models</span><span class="o">.</span><span class="n">suppress_auto_now</span><span class="p">([(</span><span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">])]):</span>
                        <span class="c1"># Store them all in once; however, the PK are not set in this way...</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">objects_to_create</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">objects_to_create</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

                <span class="c1"># Get back the just-saved entries</span>
                <span class="n">just_saved_queryset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">__in&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unique_identifier</span><span class="p">):</span> <span class="n">import_new_entry_pks</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="n">unique_identifier</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">)</span>
                <span class="c1"># note: convert uuids from type UUID to strings</span>
                <span class="n">just_saved</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">just_saved_queryset</span><span class="p">}</span>

                <span class="c1"># Now I have the PKs, print the info</span>
                <span class="c1"># Moreover, add newly created Nodes to foreign_ids_reverse_mappings</span>
                <span class="k">for</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">new_pk</span> <span class="ow">in</span> <span class="n">just_saved</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">import_entry_pk</span> <span class="o">=</span> <span class="n">import_new_entry_pks</span><span class="p">[</span><span class="n">unique_id</span><span class="p">]</span>
                    <span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">unique_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_pk</span>
                    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret_dict</span><span class="p">:</span>
                        <span class="n">ret_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;new&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;existing&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="n">ret_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="s1">&#39;new&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">import_entry_pk</span><span class="p">,</span> <span class="n">new_pk</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NEW </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">-&gt;</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">import_entry_pk</span><span class="p">,</span> <span class="n">new_pk</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING NODE LINKS...&#39;</span><span class="p">)</span>
            <span class="n">import_links</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;links_uuid&#39;</span><span class="p">]</span>
            <span class="n">links_to_store</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Needed, since QueryBuilder does not yet work for recently saved Nodes</span>
            <span class="n">existing_links_raw</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DbLink</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span>
            <span class="n">existing_links</span> <span class="o">=</span> <span class="p">{(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">existing_links_raw</span><span class="p">}</span>
            <span class="n">existing_outgoing_unique</span> <span class="o">=</span> <span class="p">{(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">existing_links_raw</span><span class="p">}</span>
            <span class="n">existing_outgoing_unique_pair</span> <span class="o">=</span> <span class="p">{(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">existing_links_raw</span><span class="p">}</span>
            <span class="n">existing_incoming_unique</span> <span class="o">=</span> <span class="p">{(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">existing_links_raw</span><span class="p">}</span>
            <span class="n">existing_incoming_unique_pair</span> <span class="o">=</span> <span class="p">{(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">existing_links_raw</span><span class="p">}</span>

            <span class="n">calculation_node_types</span> <span class="o">=</span> <span class="s1">&#39;process.calculation.&#39;</span>
            <span class="n">workflow_node_types</span> <span class="o">=</span> <span class="s1">&#39;process.workflow.&#39;</span>
            <span class="n">data_node_types</span> <span class="o">=</span> <span class="s1">&#39;data.&#39;</span>

            <span class="n">link_mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="p">:</span> <span class="p">(</span><span class="n">workflow_node_types</span><span class="p">,</span> <span class="n">calculation_node_types</span><span class="p">,</span> <span class="s1">&#39;unique_triple&#39;</span><span class="p">,</span> <span class="s1">&#39;unique&#39;</span><span class="p">),</span>
                <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">:</span> <span class="p">(</span><span class="n">workflow_node_types</span><span class="p">,</span> <span class="n">workflow_node_types</span><span class="p">,</span> <span class="s1">&#39;unique_triple&#39;</span><span class="p">,</span> <span class="s1">&#39;unique&#39;</span><span class="p">),</span>
                <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span> <span class="p">(</span><span class="n">calculation_node_types</span><span class="p">,</span> <span class="n">data_node_types</span><span class="p">,</span> <span class="s1">&#39;unique_pair&#39;</span><span class="p">,</span> <span class="s1">&#39;unique&#39;</span><span class="p">),</span>
                <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">:</span> <span class="p">(</span><span class="n">data_node_types</span><span class="p">,</span> <span class="n">calculation_node_types</span><span class="p">,</span> <span class="s1">&#39;unique_triple&#39;</span><span class="p">,</span> <span class="s1">&#39;unique_pair&#39;</span><span class="p">),</span>
                <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">:</span> <span class="p">(</span><span class="n">data_node_types</span><span class="p">,</span> <span class="n">workflow_node_types</span><span class="p">,</span> <span class="s1">&#39;unique_triple&#39;</span><span class="p">,</span> <span class="s1">&#39;unique_pair&#39;</span><span class="p">),</span>
                <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">:</span> <span class="p">(</span><span class="n">workflow_node_types</span><span class="p">,</span> <span class="n">data_node_types</span><span class="p">,</span> <span class="s1">&#39;unique_pair&#39;</span><span class="p">,</span> <span class="s1">&#39;unique_triple&#39;</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">import_links</span><span class="p">:</span>
                <span class="c1"># Check for dangling Links within the, supposed, self-consistent archive</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">in_id</span> <span class="o">=</span> <span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">][</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]]</span>
                    <span class="n">out_id</span> <span class="o">=</span> <span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">][</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ignore_unknown_nodes</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                        <span class="s1">&#39;Trying to create a link with one or both unknown nodes, stopping (in_uuid=</span><span class="si">{}</span><span class="s1">, out_uuid=</span><span class="si">{}</span><span class="s1">, &#39;</span>
                        <span class="s1">&#39;label=</span><span class="si">{}</span><span class="s1">, type=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
                    <span class="p">)</span>

                <span class="c1"># Check if link already exists, skip if it does</span>
                <span class="c1"># This is equivalent to an existing triple link (i.e. unique_triple from below)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">in_id</span><span class="p">,</span> <span class="n">out_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">existing_links</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Since backend specific Links (DbLink) are not validated upon creation, we will now validate them.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">validate_link_label</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span><span class="s1">&#39;Error during Link label validation: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">why</span><span class="p">))</span>

                <span class="n">source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DbNode</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">in_id</span><span class="p">)</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DbNode</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">out_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span><span class="s1">&#39;Cannot add a link to oneself&#39;</span><span class="p">)</span>

                <span class="n">link_type</span> <span class="o">=</span> <span class="n">LinkType</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
                <span class="n">type_source</span><span class="p">,</span> <span class="n">type_target</span><span class="p">,</span> <span class="n">outdegree</span><span class="p">,</span> <span class="n">indegree</span> <span class="o">=</span> <span class="n">link_mapping</span><span class="p">[</span><span class="n">link_type</span><span class="p">]</span>

                <span class="c1"># Check if source Node is a valid type</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">node_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">type_source</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot add a </span><span class="si">{}</span><span class="s1"> link from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">node_type</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Check if target Node is a valid type</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">node_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">type_target</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot add a </span><span class="si">{}</span><span class="s1"> link from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">node_type</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># If the outdegree is `unique` there cannot already be any other outgoing link of that type,</span>
                <span class="c1"># i.e., the source Node may not have a LinkType of current LinkType, going out, existing already.</span>
                <span class="k">if</span> <span class="n">outdegree</span> <span class="o">==</span> <span class="s1">&#39;unique&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">in_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">existing_outgoing_unique</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                        <span class="s1">&#39;Node&lt;</span><span class="si">{}</span><span class="s1">&gt; already has an outgoing </span><span class="si">{}</span><span class="s1"> link&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">link_type</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># If the outdegree is `unique_pair`,</span>
                <span class="c1"># then the link labels for outgoing links of this type should be unique,</span>
                <span class="c1"># i.e., the source Node may not have a LinkType of current LinkType, going out,</span>
                <span class="c1"># that also has the current Link label, existing already.</span>
                <span class="k">elif</span> <span class="n">outdegree</span> <span class="o">==</span> <span class="s1">&#39;unique_pair&#39;</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">in_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">existing_outgoing_unique_pair</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                        <span class="s1">&#39;Node&lt;</span><span class="si">{}</span><span class="s1">&gt; already has an outgoing </span><span class="si">{}</span><span class="s1"> link with label &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">source</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># If the indegree is `unique` there cannot already be any other incoming links of that type,</span>
                <span class="c1"># i.e., the target Node may not have a LinkType of current LinkType, coming in, existing already.</span>
                <span class="k">if</span> <span class="n">indegree</span> <span class="o">==</span> <span class="s1">&#39;unique&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">out_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">existing_incoming_unique</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                        <span class="s1">&#39;Node&lt;</span><span class="si">{}</span><span class="s1">&gt; already has an incoming </span><span class="si">{}</span><span class="s1"> link&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">link_type</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># If the indegree is `unique_pair`,</span>
                <span class="c1"># then the link labels for incoming links of this type should be unique,</span>
                <span class="c1"># i.e., the target Node may not have a LinkType of current LinkType, coming in</span>
                <span class="c1"># that also has the current Link label, existing already.</span>
                <span class="k">elif</span> <span class="n">indegree</span> <span class="o">==</span> <span class="s1">&#39;unique_pair&#39;</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">out_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">existing_incoming_unique_pair</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                        <span class="s1">&#39;Node&lt;</span><span class="si">{}</span><span class="s1">&gt; already has an incoming </span><span class="si">{}</span><span class="s1"> link with label &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># New link</span>
                <span class="n">links_to_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">DbLink</span><span class="p">(</span><span class="n">input_id</span><span class="o">=</span><span class="n">in_id</span><span class="p">,</span> <span class="n">output_id</span><span class="o">=</span><span class="n">out_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;Link&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret_dict</span><span class="p">:</span>
                    <span class="n">ret_dict</span><span class="p">[</span><span class="s1">&#39;Link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;new&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="n">ret_dict</span><span class="p">[</span><span class="s1">&#39;Link&#39;</span><span class="p">][</span><span class="s1">&#39;new&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">in_id</span><span class="p">,</span> <span class="n">out_id</span><span class="p">))</span>

                <span class="c1"># Add new Link to sets of existing Links &#39;input PK&#39;, &#39;output PK&#39;, &#39;label&#39;, &#39;type&#39;</span>
                <span class="n">existing_links</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">in_id</span><span class="p">,</span> <span class="n">out_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
                <span class="n">existing_outgoing_unique</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">in_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
                <span class="n">existing_outgoing_unique_pair</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">in_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
                <span class="n">existing_incoming_unique</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">out_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
                <span class="n">existing_incoming_unique_pair</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">out_id</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>

            <span class="c1"># Store new links</span>
            <span class="k">if</span> <span class="n">links_to_store</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   (</span><span class="si">{}</span><span class="s1"> new links...)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links_to_store</span><span class="p">)))</span>

                <span class="n">models</span><span class="o">.</span><span class="n">DbLink</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">links_to_store</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   (0 new links...)&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING GROUP ELEMENTS...&#39;</span><span class="p">)</span>
            <span class="n">import_groups</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;groups_uuid&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">groupuuid</span><span class="p">,</span> <span class="n">groupnodes</span> <span class="ow">in</span> <span class="n">import_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># TODO: cache these to avoid too many queries</span>
                <span class="n">group_</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">groupuuid</span><span class="p">)</span>
                <span class="n">nodes_to_store</span> <span class="o">=</span> <span class="p">[</span><span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">][</span><span class="n">node_uuid</span><span class="p">]</span> <span class="k">for</span> <span class="n">node_uuid</span> <span class="ow">in</span> <span class="n">groupnodes</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">nodes_to_store</span><span class="p">:</span>
                    <span class="n">group_</span><span class="o">.</span><span class="n">dbnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">nodes_to_store</span><span class="p">)</span>

        <span class="c1">######################################################</span>
        <span class="c1"># Put everything in a specific group</span>
        <span class="c1">######################################################</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">existing_entries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NODE_ENTITY_NAME</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">existing_pk</span> <span class="o">=</span> <span class="p">[</span><span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">existing</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new_entries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NODE_ENTITY_NAME</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">new_pk</span> <span class="o">=</span> <span class="p">[</span><span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="n">pks_for_group</span> <span class="o">=</span> <span class="n">existing_pk</span> <span class="o">+</span> <span class="n">new_pk</span>

        <span class="c1"># So that we do not create empty groups</span>
        <span class="k">if</span> <span class="n">pks_for_group</span><span class="p">:</span>
            <span class="c1"># If user specified a group, import all things into it</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
                <span class="c1"># Get an unique name for the import group, based on the current (local) time</span>
                <span class="n">basename</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">group_label</span> <span class="o">=</span> <span class="n">basename</span>

                <span class="k">while</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">group_label</span><span class="p">}):</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">group_label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportUniquenessError</span><span class="p">(</span>
                            <span class="s2">&quot;Overflow of import groups (more than 100 import groups exists with basename &#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">ImportGroup</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">group_label</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

            <span class="c1"># Add all the nodes to the new group</span>
            <span class="c1"># TODO: decide if we want to return the group label</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">pks_for_group</span><span class="p">}})</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">group</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IMPORTED NODES ARE GROUPED IN THE IMPORT GROUP LABELED &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NO NODES TO IMPORT, SO NO GROUP CREATED, IF IT DID NOT ALREADY EXIST&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DONE.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret_dict</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>