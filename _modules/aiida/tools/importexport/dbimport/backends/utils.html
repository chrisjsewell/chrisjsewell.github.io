

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.importexport.dbimport.backends.utils &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
        <script src="../../../../../../_static/language_data.js"></script>
        <script src="../../../../../../_static/togglebutton.js"></script>
        <script src="../../../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../../dbimport.html">aiida.tools.importexport.dbimport</a> &raquo;</li>
        
      <li>aiida.tools.importexport.dbimport.backends.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.importexport.dbimport.backends.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot; Utility functions for import of AiiDA entities &quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=inconsistent-return-statements,too-many-branches</span>
<span class="kn">import</span> <span class="nn">click</span>

<span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">QueryBuilder</span><span class="p">,</span> <span class="n">Comment</span>
<span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="kn">import</span> <span class="n">get_new_uuid</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common</span> <span class="kn">import</span> <span class="n">exceptions</span>


<div class="viewcode-block" id="merge_comment"><a class="viewcode-back" href="../../../../../../apidoc/aiida.tools.importexport.dbimport.backends.html#aiida.tools.importexport.dbimport.backends.utils.merge_comment">[docs]</a><span class="k">def</span> <span class="nf">merge_comment</span><span class="p">(</span><span class="n">incoming_comment</span><span class="p">,</span> <span class="n">comment_mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Merge comment according comment_mode</span>
<span class="sd">    :return: New UUID if new Comment should be created, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get incoming Comment&#39;s UUID, &#39;mtime&#39;, and &#39;comment&#39;</span>
    <span class="n">incoming_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">incoming_comment</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
    <span class="n">incoming_mtime</span> <span class="o">=</span> <span class="n">incoming_comment</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]</span>
    <span class="n">incoming_content</span> <span class="o">=</span> <span class="n">incoming_comment</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>

    <span class="c1"># Compare modification time &#39;mtime&#39;</span>
    <span class="k">if</span> <span class="n">comment_mode</span> <span class="o">==</span> <span class="s1">&#39;newest&#39;</span><span class="p">:</span>
        <span class="c1"># Get existing Comment&#39;s &#39;mtime&#39; and &#39;content&#39;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">incoming_uuid</span><span class="p">},</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span><span class="s1">&#39;Multiple Comments with the same UUID: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">incoming_uuid</span><span class="p">))</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">existing_mtime</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">existing_content</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Existing Comment is &quot;newer&quot; than imported Comment: KEEP existing</span>
        <span class="k">if</span> <span class="n">existing_mtime</span> <span class="o">&gt;</span> <span class="n">incoming_mtime</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Existing Comment is &quot;older&quot; than imported Comment: OVERWRITE existing</span>
        <span class="k">if</span> <span class="n">existing_mtime</span> <span class="o">&lt;</span> <span class="n">incoming_mtime</span><span class="p">:</span>
            <span class="n">cmt</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">incoming_uuid</span><span class="p">)</span>
            <span class="n">cmt</span><span class="o">.</span><span class="n">set_content</span><span class="p">(</span><span class="n">incoming_content</span><span class="p">)</span>
            <span class="n">cmt</span><span class="o">.</span><span class="n">set_mtime</span><span class="p">(</span><span class="n">incoming_mtime</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Existing Comment has the same modification time as the imported Comment</span>
        <span class="c1"># Check content. If the same, ignore Comment. If different, add as new Comment.</span>
        <span class="k">if</span> <span class="n">existing_mtime</span> <span class="o">==</span> <span class="n">incoming_mtime</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">existing_content</span> <span class="o">==</span> <span class="n">incoming_content</span><span class="p">:</span>
                <span class="c1"># Ignore</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># ELSE: Add it as a new comment</span>
            <span class="k">return</span> <span class="n">get_new_uuid</span><span class="p">()</span>

    <span class="c1"># Overwrite existing Comment</span>
    <span class="k">elif</span> <span class="n">comment_mode</span> <span class="o">==</span> <span class="s1">&#39;overwrite&#39;</span><span class="p">:</span>
        <span class="n">cmt</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">incoming_uuid</span><span class="p">)</span>
        <span class="n">cmt</span><span class="o">.</span><span class="n">set_content</span><span class="p">(</span><span class="n">incoming_content</span><span class="p">)</span>
        <span class="n">cmt</span><span class="o">.</span><span class="n">set_mtime</span><span class="p">(</span><span class="n">incoming_mtime</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Invalid comment_mode</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
            <span class="s1">&#39;Unknown comment_mode value: </span><span class="si">{}</span><span class="s1">. Should be &#39;</span>
            <span class="s2">&quot;either &#39;newest&#39; or &#39;overwrite&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment_mode</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="merge_extras"><a class="viewcode-back" href="../../../../../../apidoc/aiida.tools.importexport.dbimport.backends.html#aiida.tools.importexport.dbimport.backends.utils.merge_extras">[docs]</a><span class="k">def</span> <span class="nf">merge_extras</span><span class="p">(</span><span class="n">old_extras</span><span class="p">,</span> <span class="n">new_extras</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param old_extras: a dictionary containing the old extras of an already existing node</span>
<span class="sd">    :param new_extras: a dictionary containing the new extras of an imported node</span>
<span class="sd">    :param extras_mode_existing: 3 letter code that will identify what to do with the extras import.</span>
<span class="sd">        The first letter acts on extras that are present in the original node and not present</span>
<span class="sd">        in the imported node. Can be either k (keep it) or n (do not keep it).</span>
<span class="sd">        The second letter acts on the imported extras that are not present in the original node.</span>
<span class="sd">        Can be either c (create it) or n (do not create it). The third letter says what to do</span>
<span class="sd">        in case of a name collision. Can be l (leave the old value), u (update with a new value),</span>
<span class="sd">        d (delete the extra), a (ask what to do if the content is different).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
            <span class="s2">&quot;Parameter &#39;mode&#39; should be of string type, you provided &#39;</span><span class="si">{}</span><span class="s2">&#39; type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
            <span class="s2">&quot;Parameter &#39;mode&#39; should be a 3-letter string, you provided: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">old_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_extras</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">new_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_extras</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">collided_keys</span> <span class="o">=</span> <span class="n">old_keys</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">new_keys</span><span class="p">)</span>
    <span class="n">old_keys_only</span> <span class="o">=</span> <span class="n">old_keys</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">collided_keys</span><span class="p">)</span>
    <span class="n">new_keys_only</span> <span class="o">=</span> <span class="n">new_keys</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">collided_keys</span><span class="p">)</span>

    <span class="n">final_extras</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Fast implementations for the common operations:</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ncu&#39;</span><span class="p">:</span>  <span class="c1"># &#39;mirror&#39; operation: remove old extras, put only the new ones</span>
        <span class="k">return</span> <span class="n">new_extras</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;knl&#39;</span><span class="p">:</span>  <span class="c1"># &#39;none&#39;: keep old extras, do not add imported ones</span>
        <span class="k">return</span> <span class="n">old_extras</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;kcu&#39;</span><span class="p">:</span>  <span class="c1"># &#39;update_existing&#39; operation: if an extra already exists,</span>
        <span class="c1"># overwrite its new value with a new one</span>
        <span class="n">final_extras</span> <span class="o">=</span> <span class="n">new_extras</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">old_keys_only</span><span class="p">:</span>
            <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;kcl&#39;</span><span class="p">:</span>  <span class="c1"># &#39;keep_existing&#39;: if an extra already exists, keep its original value</span>
        <span class="n">final_extras</span> <span class="o">=</span> <span class="n">old_extras</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_keys_only</span><span class="p">:</span>
            <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;kca&#39;</span><span class="p">:</span>  <span class="c1"># &#39;ask&#39;: if an extra already exists ask a user whether to update its value</span>
        <span class="n">final_extras</span> <span class="o">=</span> <span class="n">old_extras</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_keys_only</span><span class="p">:</span>
            <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">collided_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span>
                    <span class="s1">&#39;The extra </span><span class="si">{}</span><span class="s1"> collided, would you&#39;</span>
                    <span class="s1">&#39; like to overwrite its value?</span><span class="se">\n</span><span class="s1">Old value: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">New value: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">old_extras</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># Slow, but more general implementation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">old_keys_only</span><span class="p">:</span>
                <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Unknown first letter of the update extras mode: &#39;</span><span class="si">{}</span><span class="s2">&#39;. Should be either &#39;k&#39; or &#39;n&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_keys_only</span><span class="p">:</span>
                <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Unknown second letter of the update extras mode: &#39;</span><span class="si">{}</span><span class="s2">&#39;. Should be either &#39;c&#39; or &#39;n&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">collided_keys</span><span class="p">:</span>
                <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">collided_keys</span><span class="p">:</span>
                <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">collided_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">old_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span>
                        <span class="s1">&#39;The extra </span><span class="si">{}</span><span class="s1"> collided, would you&#39;</span>
                        <span class="s1">&#39; like to overwrite its value?</span><span class="se">\n</span><span class="s1">Old value: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">New value: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">key</span><span class="p">,</span> <span class="n">old_extras</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Unknown third letter of the update extras mode: &#39;</span><span class="si">{}</span><span class="s2">&#39;. Should be one of &#39;u&#39;/&#39;l&#39;/&#39;a&#39;/&#39;d&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">final_extras</span></div>


<div class="viewcode-block" id="deserialize_attributes"><a class="viewcode-back" href="../../../../../../apidoc/aiida.tools.importexport.dbimport.backends.html#aiida.tools.importexport.dbimport.backends.utils.deserialize_attributes">[docs]</a><span class="k">def</span> <span class="nf">deserialize_attributes</span><span class="p">(</span><span class="n">attributes_data</span><span class="p">,</span> <span class="n">conversion_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deserialize attributes&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">pytz</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">ret_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attributes_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">conversion_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ret_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialize_attributes</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">conversion_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialize_attributes</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">ret_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">conversion_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">conversion</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">attributes_data</span><span class="p">,</span> <span class="n">conversion_data</span><span class="p">):</span>
                <span class="n">ret_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deserialize_attributes</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">conversion</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attributes_data</span><span class="p">:</span>
                <span class="n">ret_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deserialize_attributes</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">conversion_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret_data</span> <span class="o">=</span> <span class="n">attributes_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conversion_data</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span>
                <span class="n">ret_data</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">attributes_data</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveImportError</span><span class="p">(</span><span class="s2">&quot;Unknown convert_type &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conversion_data</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ret_data</span></div>


<div class="viewcode-block" id="deserialize_field"><a class="viewcode-back" href="../../../../../../apidoc/aiida.tools.importexport.dbimport.backends.html#aiida.tools.importexport.dbimport.backends.utils.deserialize_field">[docs]</a><span class="k">def</span> <span class="nf">deserialize_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fields_info</span><span class="p">,</span> <span class="n">import_unique_ids_mappings</span><span class="p">,</span> <span class="n">foreign_ids_reverse_mappings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deserialize field using deserialize attributes&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">field_info</span> <span class="o">=</span> <span class="n">fields_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveImportError</span><span class="p">(</span><span class="s2">&quot;Unknown field &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportValidationError</span><span class="p">(</span><span class="s1">&#39;ID or PK explicitly passed!&#39;</span><span class="p">)</span>

    <span class="n">requires</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requires&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">requires</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Actual data, no foreign key</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;convert_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">deserialize_attributes</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">converter</span><span class="p">))</span>

    <span class="c1"># Foreign field</span>
    <span class="c1"># Correctly manage nullable fields</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unique_id</span> <span class="o">=</span> <span class="n">import_unique_ids_mappings</span><span class="p">[</span><span class="n">requires</span><span class="p">][</span><span class="n">value</span><span class="p">]</span>
        <span class="c1"># map to the PK/ID associated to the given entry, in the arrival DB,</span>
        <span class="c1"># rather than in the export DB</span>

        <span class="c1"># I store it in the FIELDNAME_id variable, that directly stores the</span>
        <span class="c1"># PK in the remote table, rather than requiring to create Model</span>
        <span class="c1"># instances for the foreign relations</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_id&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">foreign_ids_reverse_mappings</span><span class="p">[</span><span class="n">requires</span><span class="p">][</span><span class="n">unique_id</span><span class="p">])</span>

    <span class="c1"># else</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_id&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>