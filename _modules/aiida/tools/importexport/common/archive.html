

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.importexport.common.archive &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
        <script src="../../../../../_static/togglebutton.js"></script>
        <script src="../../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.tools.importexport.common.archive</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.importexport.common.archive</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Utility functions and classes to interact with AiiDA export archives.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">from</span> <span class="nn">wrapt</span> <span class="kn">import</span> <span class="n">decorator</span>

<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ContentNotExistent</span><span class="p">,</span> <span class="n">InvalidOperation</span>
<span class="kn">from</span> <span class="nn">aiida.common.folders</span> <span class="kn">import</span> <span class="n">SandboxFolder</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.config</span> <span class="kn">import</span> <span class="n">NODES_EXPORT_SUBFOLDER</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.exceptions</span> <span class="kn">import</span> <span class="n">CorruptArchive</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Archive&#39;</span><span class="p">,</span> <span class="s1">&#39;extract_zip&#39;</span><span class="p">,</span> <span class="s1">&#39;extract_tar&#39;</span><span class="p">,</span> <span class="s1">&#39;extract_tree&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Archive"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive">[docs]</a><span class="k">class</span> <span class="nc">Archive</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Utility class to operate on exported archive files or directories.</span>

<span class="sd">    The main usage should be to construct the class with the filepath of the export archive as an argument.</span>
<span class="sd">    The contents will be lazily unpacked into a sand box folder which is constructed upon entering the instance</span>
<span class="sd">    within a context and which will be automatically cleaned upon leaving that context. Example::</span>

<span class="sd">        with Archive(&#39;/some/path/archive.aiida&#39;) as archive:</span>
<span class="sd">            archive.version</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">FILENAME_DATA</span> <span class="o">=</span> <span class="s1">&#39;data.json&#39;</span>
    <span class="n">FILENAME_METADATA</span> <span class="o">=</span> <span class="s1">&#39;metadata.json&#39;</span>

<div class="viewcode-block" id="Archive.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_folder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unpacked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_data</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Archive.__enter__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive.__enter__">[docs]</a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a SandboxFolder into which the archive can be lazily unpacked.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Archive.__exit__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive.__exit__">[docs]</a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean the sandbox folder if it was instatiated.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span></div>

<div class="viewcode-block" id="Archive.ensure_within_context"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive.ensure_within_context">[docs]</a>    <span class="nd">@decorator</span>
    <span class="k">def</span> <span class="nf">ensure_within_context</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=no-self-argument</span>
        <span class="sd">&quot;&quot;&quot;Decorator to ensure that the instance is called within a context manager.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">folder</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidOperation</span><span class="p">(</span><span class="s1">&#39;the Archive class should be used within a context&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># pylint: disable=not-callable</span></div>

<div class="viewcode-block" id="Archive.ensure_unpacked"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive.ensure_unpacked">[docs]</a>    <span class="nd">@decorator</span>
    <span class="k">def</span> <span class="nf">ensure_unpacked</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=no-self-argument</span>
        <span class="sd">&quot;&quot;&quot;Decorator to ensure that the archive is unpacked before entering the decorated function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">unpacked</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">unpack</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># pylint: disable=not-callable</span></div>

<div class="viewcode-block" id="Archive.unpack"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive.unpack">[docs]</a>    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unpack the archive and store the contents in a sandbox.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">extract_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">extract_tar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nodes_export_subfolder</span><span class="o">=</span><span class="n">NODES_EXPORT_SUBFOLDER</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">extract_zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nodes_export_subfolder</span><span class="o">=</span><span class="n">NODES_EXPORT_SUBFOLDER</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CorruptArchive</span><span class="p">(</span><span class="s1">&#39;unrecognized archive format&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">get_content_list</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ContentNotExistent</span><span class="p">(</span><span class="s1">&#39;the provided archive </span><span class="si">{}</span><span class="s1"> is empty&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unpacked</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the filepath of the archive</span>

<span class="sd">        :return: the archive filepath</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the sandbox folder</span>

<span class="sd">        :return: sandbox folder :class:`aiida.common.folders.SandboxFolder`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folder</span>

    <span class="nd">@property</span>
    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the loaded content of the data file</span>

<span class="sd">        :return: dictionary with contents of data file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_json_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_DATA</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="nd">@property</span>
    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the loaded content of the meta data file</span>

<span class="sd">        :return: dictionary with contents of meta data file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_json_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_METADATA</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_data</span>

    <span class="nd">@property</span>
    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">unpacked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether the archive has been unpacked into the sandbox folder.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpacked</span>

<div class="viewcode-block" id="Archive.get_info"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive.get_info">[docs]</a>    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary with basic information about the archive.</span>

<span class="sd">        :return: a dictionary with basic details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;version aiida&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_aiida</span><span class="p">,</span>
            <span class="s1">&#39;version format&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_format</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion_info</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;conversion info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conversion_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">info</span></div>

<div class="viewcode-block" id="Archive.get_data_statistics"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive.get_data_statistics">[docs]</a>    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">get_data_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary with statistics about data content, i.e. how many entries of each entity type it contains.</span>

<span class="sd">        :return: a dictionary with basic details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">export_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;export_data&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">links_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;links_uuid&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">computers</span> <span class="o">=</span> <span class="n">export_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Computer&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">export_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">export_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">export_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">statistics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;computers&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">computers</span><span class="p">),</span>
            <span class="s1">&#39;groups&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span>
            <span class="s1">&#39;links&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">links_data</span><span class="p">),</span>
            <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">),</span>
            <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">statistics</span></div>

    <span class="nd">@property</span>
    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">version_aiida</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the version of AiiDA the archive was created with.</span>

<span class="sd">        :return: version number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;aiida_version&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">version_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the version of the archive format.</span>

<span class="sd">        :return: version number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;export_version&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="nd">@ensure_within_context</span>
    <span class="k">def</span> <span class="nf">conversion_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return information about migration events that were applied to this archive.</span>

<span class="sd">        :return: list of conversion notifications</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;conversion_info&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Archive._read_json_file"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.Archive._read_json_file">[docs]</a>    <span class="nd">@ensure_within_context</span>
    <span class="nd">@ensure_unpacked</span>
    <span class="k">def</span> <span class="nf">_read_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the contents of a JSON file from the unpacked archive contents.</span>

<span class="sd">        :param filename: the filename relative to the sandbox folder</span>
<span class="sd">        :return: a dictionary with the loaded JSON content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fhandle</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="extract_zip"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.extract_zip">[docs]</a><span class="k">def</span> <span class="nf">extract_zip</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">nodes_export_subfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the nodes to be imported from a zip file.</span>

<span class="sd">    :param infile: file path</span>
<span class="sd">    :type infile: str</span>

<span class="sd">    :param folder: a temporary folder used to extract the file tree</span>
<span class="sd">    :type folder: :py:class:`~aiida.common.folders.SandboxFolder`</span>

<span class="sd">    :param nodes_export_subfolder: name of the subfolder for AiiDA nodes</span>
<span class="sd">    :type nodes_export_subfolder: str</span>

<span class="sd">    :param silent: suppress debug print</span>
<span class="sd">    :type silent: bool</span>

<span class="sd">    :raises TypeError: if parameter types are not respected</span>
<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.CorruptArchive`: if the archive misses files or files have</span>
<span class="sd">        incorrect formats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=fixme</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;READING DATA AND METADATA...&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nodes_export_subfolder</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodes_export_subfolder</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;nodes_export_subfolder must be a string&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodes_export_subfolder</span> <span class="o">=</span> <span class="n">NODES_EXPORT_SUBFOLDER</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">handle</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">CorruptArchive</span><span class="p">(</span><span class="s1">&#39;no files detected&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CorruptArchive</span><span class="p">(</span><span class="s1">&#39;required file `metadata.json` is not included&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="s1">&#39;data.json&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CorruptArchive</span><span class="p">(</span><span class="s1">&#39;required file `data.json` is not included&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EXTRACTING NODE DATA...&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">membername</span> <span class="ow">in</span> <span class="n">handle</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                <span class="c1"># Check that we are only exporting nodes within the subfolder!</span>
                <span class="c1"># TODO: better check such that there are no .. in the</span>
                <span class="c1"># path; use probably the folder limit checks</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">membername</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">nodes_export_subfolder</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="n">membername</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipfile</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The input file format for import is not valid (not a zip file)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_tar"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.extract_tar">[docs]</a><span class="k">def</span> <span class="nf">extract_tar</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">nodes_export_subfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the nodes to be imported from a (possibly zipped) tar file.</span>

<span class="sd">    :param infile: file path</span>
<span class="sd">    :type infile: str</span>

<span class="sd">    :param folder: a temporary fodler used to extract the file tree</span>
<span class="sd">    :type folder: :py:class:`~aiida.common.folders.SandboxFolder`</span>

<span class="sd">    :param nodes_export_subfolder: name of the subfolder for AiiDA nodes</span>
<span class="sd">    :type nodes_export_subfolder: str</span>

<span class="sd">    :param silent: suppress debug print</span>
<span class="sd">    :type silent: bool</span>

<span class="sd">    :raises TypeError: if parameter types are not respected</span>
<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.CorruptArchive`: if the archive misses files or files have</span>
<span class="sd">        incorrect formats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=fixme</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;READING DATA AND METADATA...&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nodes_export_subfolder</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodes_export_subfolder</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;nodes_export_subfolder must be a string&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodes_export_subfolder</span> <span class="o">=</span> <span class="n">NODES_EXPORT_SUBFOLDER</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r:*&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">PAX_FORMAT</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="n">handle</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CorruptArchive</span><span class="p">(</span><span class="s1">&#39;required file `metadata.json` is not included&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="n">handle</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="s1">&#39;data.json&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CorruptArchive</span><span class="p">(</span><span class="s1">&#39;required file `data.json` is not included&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EXTRACTING NODE DATA...&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">handle</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">isdev</span><span class="p">():</span>
                    <span class="c1"># safety: skip if character device, block device or FIFO</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING, device found inside the import file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">issym</span><span class="p">()</span> <span class="ow">or</span> <span class="n">member</span><span class="o">.</span><span class="n">islnk</span><span class="p">():</span>
                    <span class="c1"># safety: in export, I set dereference=True therefore</span>
                    <span class="c1"># there should be no symbolic or hard links.</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING, link found inside the import file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Check that we are only exporting nodes within the subfolder!</span>
                <span class="c1"># TODO: better check such that there are no .. in the</span>
                <span class="c1"># path; use probably the folder limit checks</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">nodes_export_subfolder</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="n">member</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">ReadError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The input file format for import is not valid (1)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_tree"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.importexport.common.html#aiida.tools.importexport.extract_tree">[docs]</a><span class="k">def</span> <span class="nf">extract_tree</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare to import nodes from plain file system tree by copying in the given sandbox folder.</span>

<span class="sd">    .. note:: the contents of the unpacked archive directory are copied into the sandbox folder, because the files will</span>
<span class="sd">        anyway haven to be copied to the repository at some point. By copying the contents of the source directory now</span>
<span class="sd">        and continuing operation only on the sandbox folder, we do not risk to modify the source files accidentally.</span>
<span class="sd">        During import then, the node files from the sandbox can be moved to the repository, so they won&#39;t have to be</span>
<span class="sd">        copied again in any case.</span>

<span class="sd">    :param infile: absolute filepath point to the unpacked archive directory</span>
<span class="sd">    :type infile: str</span>

<span class="sd">    :param folder: a temporary folder to which the archive contents are copied</span>
<span class="sd">    :type folder: :py:class:`~aiida.common.folders.SandboxFolder`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folder</span><span class="o">.</span><span class="n">replace_with_folder</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">move</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>