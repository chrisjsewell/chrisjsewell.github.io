

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.importexport.dbexport &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/togglebutton.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.tools.importexport.dbexport</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.importexport.dbexport</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="c1"># pylint: disable=fixme,too-many-branches,too-many-locals,too-many-statements,too-many-arguments</span>
<span class="sd">&quot;&quot;&quot;Provides export functionalities.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="kn">import</span> <span class="n">get_version</span><span class="p">,</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="nn">aiida.common.folders</span> <span class="kn">import</span> <span class="n">RepositoryFolder</span>
<span class="kn">from</span> <span class="nn">aiida.orm.utils.repository</span> <span class="kn">import</span> <span class="n">Repository</span>

<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.config</span> <span class="kn">import</span> <span class="n">EXPORT_VERSION</span><span class="p">,</span> <span class="n">NODES_EXPORT_SUBFOLDER</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NODE_ENTITY_NAME</span><span class="p">,</span> <span class="n">GROUP_ENTITY_NAME</span><span class="p">,</span> <span class="n">COMPUTER_ENTITY_NAME</span><span class="p">,</span> <span class="n">LOG_ENTITY_NAME</span><span class="p">,</span> <span class="n">COMMENT_ENTITY_NAME</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_all_fields_info</span><span class="p">,</span> <span class="n">file_fields_to_model_fields</span><span class="p">,</span> <span class="n">entity_names_to_entities</span><span class="p">,</span> <span class="n">model_fields_to_file_fields</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.common.utils</span> <span class="kn">import</span> <span class="n">export_shard_uuid</span>
<span class="kn">from</span> <span class="nn">aiida.tools.importexport.dbexport.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">check_licenses</span><span class="p">,</span> <span class="n">fill_in_query</span><span class="p">,</span> <span class="n">serialize_dict</span><span class="p">,</span> <span class="n">check_process_nodes_sealed</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.zip</span> <span class="kn">import</span> <span class="n">ZipFolder</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;export&#39;</span><span class="p">,</span> <span class="s1">&#39;export_zip&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="export_zip"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.importexport.dbexport.html#aiida.tools.importexport.export_zip">[docs]</a><span class="k">def</span> <span class="nf">export_zip</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;testzip&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_compression</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Export in a zipped folder</span>

<span class="sd">    :param what: a list of entity instances; they can belong to different models/entities.</span>
<span class="sd">    :type what: list</span>

<span class="sd">    :param outfile: the filename (possibly including the absolute path) of the file on which to export.</span>
<span class="sd">    :type outfile: str</span>

<span class="sd">    :param overwrite: if True, overwrite the output file without asking, if it exists. If False, raise an</span>
<span class="sd">        :py:class:`~aiida.tools.importexport.common.exceptions.ArchiveExportError` if the output file already exists.</span>
<span class="sd">    :type overwrite: bool</span>

<span class="sd">    :param silent: suppress prints.</span>
<span class="sd">    :type silent: bool</span>

<span class="sd">    :param use_compression: Whether or not to compress the zip file.</span>
<span class="sd">    :type use_compression: bool</span>

<span class="sd">    :param allowed_licenses: List or function. If a list, then checks whether all licenses of Data nodes are in the</span>
<span class="sd">        list. If a function, then calls function for licenses of Data nodes expecting True if license is allowed, False</span>
<span class="sd">        otherwise.</span>
<span class="sd">    :type allowed_licenses: list</span>

<span class="sd">    :param forbidden_licenses: List or function. If a list, then checks whether all licenses of Data nodes are in the</span>
<span class="sd">        list. If a function, then calls function for licenses of Data nodes expecting True if license is allowed, False</span>
<span class="sd">        otherwise.</span>
<span class="sd">    :type forbidden_licenses: list</span>

<span class="sd">    :param include_comments: In-/exclude export of comments for given node(s) in ``what``.</span>
<span class="sd">        Default: True, *include* comments in export (as well as relevant users).</span>
<span class="sd">    :type include_comments: bool</span>

<span class="sd">    :param include_logs: In-/exclude export of logs for given node(s) in ``what``.</span>
<span class="sd">        Default: True, *include* logs in export.</span>
<span class="sd">    :type include_logs: bool</span>

<span class="sd">    :param kwargs: graph traversal rules. See :const:`aiida.common.links.GraphTraversalRules` what rule names</span>
<span class="sd">        are toggleable and what the defaults are.</span>

<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.ArchiveExportError`: if there are any internal errors when</span>
<span class="sd">        exporting.</span>
<span class="sd">    :raises `~aiida.common.exceptions.LicensingException`: if any node is licensed under forbidden license.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveExportError</span><span class="p">(</span><span class="s2">&quot;the output file &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile</span><span class="p">))</span>

    <span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">ZipFolder</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">use_compression</span><span class="o">=</span><span class="n">use_compression</span><span class="p">)</span> <span class="k">as</span> <span class="n">folder</span><span class="p">:</span>
        <span class="n">export_tree</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File written in </span><span class="si">{:10.3g}</span><span class="s1"> s.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_start</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">export_tree</span><span class="p">(</span>
    <span class="n">what</span><span class="p">,</span>
    <span class="n">folder</span><span class="p">,</span>
    <span class="n">allowed_licenses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">forbidden_licenses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">include_comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">include_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Export the entries passed in the &#39;what&#39; list to a file tree.</span>

<span class="sd">    :param what: a list of entity instances; they can belong to different models/entities.</span>
<span class="sd">    :type what: list</span>

<span class="sd">    :param folder: a temporary folder to build the archive before compression.</span>
<span class="sd">    :type folder: :py:class:`~aiida.common.folders.Folder`</span>

<span class="sd">    :param allowed_licenses: List or function. If a list, then checks whether all licenses of Data nodes are in the</span>
<span class="sd">        list. If a function, then calls function for licenses of Data nodes expecting True if license is allowed, False</span>
<span class="sd">        otherwise.</span>
<span class="sd">    :type allowed_licenses: list</span>

<span class="sd">    :param forbidden_licenses: List or function. If a list, then checks whether all licenses of Data nodes are in the</span>
<span class="sd">        list. If a function, then calls function for licenses of Data nodes expecting True if license is allowed, False</span>
<span class="sd">        otherwise.</span>
<span class="sd">    :type forbidden_licenses: list</span>

<span class="sd">    :param silent: suppress prints.</span>
<span class="sd">    :type silent: bool</span>

<span class="sd">    :param include_comments: In-/exclude export of comments for given node(s) in ``what``.</span>
<span class="sd">        Default: True, *include* comments in export (as well as relevant users).</span>
<span class="sd">    :type include_comments: bool</span>

<span class="sd">    :param include_logs: In-/exclude export of logs for given node(s) in ``what``.</span>
<span class="sd">        Default: True, *include* logs in export.</span>
<span class="sd">    :type include_logs: bool</span>

<span class="sd">    :param kwargs: graph traversal rules. See :const:`aiida.common.links.GraphTraversalRules` what rule names</span>
<span class="sd">        are toggleable and what the defaults are.</span>

<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.ArchiveExportError`: if there are any internal errors when</span>
<span class="sd">        exporting.</span>
<span class="sd">    :raises `~aiida.common.exceptions.LicensingException`: if any node is licensed under forbidden license.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
    <span class="kn">from</span> <span class="nn">aiida.tools.graph.graph_traversers</span> <span class="kn">import</span> <span class="n">get_nodes_export</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STARTING EXPORT...&#39;</span><span class="p">)</span>

    <span class="n">all_fields_info</span><span class="p">,</span> <span class="n">unique_identifiers</span> <span class="o">=</span> <span class="n">get_all_fields_info</span><span class="p">()</span>

    <span class="n">entities_starting_set</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="c1"># The set that contains the nodes ids of the nodes that should be exported</span>
    <span class="n">given_data_entry_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">given_calculation_entry_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">given_group_entry_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">given_computer_entry_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">given_groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">given_log_entry_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">given_comment_entry_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># I store a list of the actual dbnodes</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
        <span class="c1"># This returns the class name (as in imports). E.g. for a model node:</span>
        <span class="c1"># aiida.backends.djsite.db.models.DbNode</span>
        <span class="c1"># entry_class_string = get_class_string(entry)</span>
        <span class="c1"># Now a load the backend-independent name into entry_entity_name, e.g. Node!</span>
        <span class="c1"># entry_entity_name = schema_to_entity_names(entry_class_string)</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
            <span class="n">entities_starting_set</span><span class="p">[</span><span class="n">GROUP_ENTITY_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">given_group_entry_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">given_groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
            <span class="n">entities_starting_set</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">):</span>
                <span class="n">given_data_entry_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">):</span>
                <span class="n">given_calculation_entry_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">):</span>
            <span class="n">entities_starting_set</span><span class="p">[</span><span class="n">COMPUTER_ENTITY_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">given_computer_entry_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveExportError</span><span class="p">(</span>
                <span class="s1">&#39;I was given </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">), which is not a Node, Computer, or Group instance&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
            <span class="p">)</span>

    <span class="c1"># Add all the nodes contained within the specified groups</span>
    <span class="k">if</span> <span class="n">given_group_entry_ids</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RETRIEVING NODES FROM GROUPS...&#39;</span><span class="p">)</span>

        <span class="c1"># Use single query instead of given_group.nodes iterator for performance.</span>
        <span class="n">qh_groups</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">given_group_entry_ids</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;groups&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">queryhelp</span>

        <span class="c1"># Delete this import once the dbexport.zip module has been renamed</span>
        <span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">zip</span>  <span class="c1"># pylint: disable=redefined-builtin</span>

        <span class="n">data_results</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">(</span><span class="o">**</span><span class="n">qh_groups</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">with_group</span><span class="o">=</span><span class="s1">&#39;groups&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data_results</span><span class="p">:</span>
            <span class="n">pks</span><span class="p">,</span> <span class="n">uuids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data_results</span><span class="p">))</span>
            <span class="n">entities_starting_set</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">uuids</span><span class="p">)</span>
            <span class="n">given_data_entry_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pks</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">data_results</span><span class="p">,</span> <span class="n">pks</span><span class="p">,</span> <span class="n">uuids</span>

        <span class="n">calc_results</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">(</span><span class="o">**</span><span class="n">qh_groups</span>
                                       <span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">with_group</span><span class="o">=</span><span class="s1">&#39;groups&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">calc_results</span><span class="p">:</span>
            <span class="n">pks</span><span class="p">,</span> <span class="n">uuids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">calc_results</span><span class="p">))</span>
            <span class="n">entities_starting_set</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">uuids</span><span class="p">)</span>
            <span class="n">given_calculation_entry_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pks</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">calc_results</span><span class="p">,</span> <span class="n">pks</span><span class="p">,</span> <span class="n">uuids</span>

    <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">entity_set</span> <span class="ow">in</span> <span class="n">entities_starting_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">entities_starting_set</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entity_set</span><span class="p">)</span>

    <span class="c1"># We will iteratively explore the AiiDA graph to find further nodes that</span>
    <span class="c1"># should also be exported.</span>
    <span class="c1"># At the same time, we will create the links_uuid list of dicts to be exported</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RETRIEVING LINKED NODES AND STORING LINKS...&#39;</span><span class="p">)</span>

    <span class="n">initial_nodes_ids</span> <span class="o">=</span> <span class="n">given_calculation_entry_ids</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">given_data_entry_ids</span><span class="p">)</span>
    <span class="n">traverse_output</span> <span class="o">=</span> <span class="n">get_nodes_export</span><span class="p">(</span><span class="n">starting_pks</span><span class="o">=</span><span class="n">initial_nodes_ids</span><span class="p">,</span> <span class="n">get_links</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">to_be_exported</span> <span class="o">=</span> <span class="n">traverse_output</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
    <span class="n">graph_traversal_rules</span> <span class="o">=</span> <span class="n">traverse_output</span><span class="p">[</span><span class="s1">&#39;rules&#39;</span><span class="p">]</span>

    <span class="c1"># I create a utility dictionary for mapping pk to uuid.</span>
    <span class="k">if</span> <span class="n">traverse_output</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]:</span>
        <span class="n">qbuilder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">),</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">traverse_output</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
            <span class="p">}},</span>
        <span class="p">)</span>
        <span class="n">pk_2_uuid_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">qbuilder</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pk_2_uuid_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># The set of tuples now has to be transformed to a list of dicts</span>
    <span class="n">links_uuid</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">pk_2_uuid_dict</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">source_id</span><span class="p">],</span>
        <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">pk_2_uuid_dict</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">target_id</span><span class="p">],</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">link</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">link</span><span class="o">.</span><span class="n">link_type</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">traverse_output</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]]</span>

    <span class="c1">## Universal &quot;entities&quot; attributed to all types of nodes</span>
    <span class="c1"># Logs</span>
    <span class="k">if</span> <span class="n">include_logs</span> <span class="ow">and</span> <span class="n">to_be_exported</span><span class="p">:</span>
        <span class="c1"># Get related log(s) - universal for all nodes</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dbnode_id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">to_be_exported</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">given_log_entry_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># Comments</span>
    <span class="k">if</span> <span class="n">include_comments</span> <span class="ow">and</span> <span class="n">to_be_exported</span><span class="p">:</span>
        <span class="c1"># Get related log(s) - universal for all nodes</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dbnode_id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">to_be_exported</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">given_comment_entry_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># Here we get all the columns that we plan to project per entity that we</span>
    <span class="c1"># would like to extract</span>
    <span class="n">given_entities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">given_group_entry_ids</span><span class="p">:</span>
        <span class="n">given_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GROUP_ENTITY_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_be_exported</span><span class="p">:</span>
        <span class="n">given_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NODE_ENTITY_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">given_computer_entry_ids</span><span class="p">:</span>
        <span class="n">given_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">COMPUTER_ENTITY_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">given_log_entry_ids</span><span class="p">:</span>
        <span class="n">given_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LOG_ENTITY_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">given_comment_entry_ids</span><span class="p">:</span>
        <span class="n">given_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">COMMENT_ENTITY_NAME</span><span class="p">)</span>

    <span class="n">entries_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">given_entity</span> <span class="ow">in</span> <span class="n">given_entities</span><span class="p">:</span>
        <span class="n">project_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="c1"># The following gets a list of fields that we need,</span>
        <span class="c1"># e.g. user, mtime, uuid, computer</span>
        <span class="n">entity_prop</span> <span class="o">=</span> <span class="n">all_fields_info</span><span class="p">[</span><span class="n">given_entity</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># Here we do the necessary renaming of properties</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">entity_prop</span><span class="p">:</span>
            <span class="c1"># nprop contains the list of projections</span>
            <span class="n">nprop</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">file_fields_to_model_fields</span><span class="p">[</span><span class="n">given_entity</span><span class="p">][</span><span class="n">prop</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">file_fields_to_model_fields</span><span class="p">[</span><span class="n">given_entity</span><span class="p">]</span> <span class="k">else</span> <span class="n">prop</span>
            <span class="p">)</span>
            <span class="n">project_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nprop</span><span class="p">)</span>

        <span class="c1"># Getting the ids that correspond to the right entity</span>
        <span class="k">if</span> <span class="n">given_entity</span> <span class="o">==</span> <span class="n">GROUP_ENTITY_NAME</span><span class="p">:</span>
            <span class="n">entry_ids_to_add</span> <span class="o">=</span> <span class="n">given_group_entry_ids</span>
        <span class="k">elif</span> <span class="n">given_entity</span> <span class="o">==</span> <span class="n">NODE_ENTITY_NAME</span><span class="p">:</span>
            <span class="n">entry_ids_to_add</span> <span class="o">=</span> <span class="n">to_be_exported</span>
        <span class="k">elif</span> <span class="n">given_entity</span> <span class="o">==</span> <span class="n">COMPUTER_ENTITY_NAME</span><span class="p">:</span>
            <span class="n">entry_ids_to_add</span> <span class="o">=</span> <span class="n">given_computer_entry_ids</span>
        <span class="k">elif</span> <span class="n">given_entity</span> <span class="o">==</span> <span class="n">LOG_ENTITY_NAME</span><span class="p">:</span>
            <span class="n">entry_ids_to_add</span> <span class="o">=</span> <span class="n">given_log_entry_ids</span>
        <span class="k">elif</span> <span class="n">given_entity</span> <span class="o">==</span> <span class="n">COMMENT_ENTITY_NAME</span><span class="p">:</span>
            <span class="n">entry_ids_to_add</span> <span class="o">=</span> <span class="n">given_comment_entry_ids</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">entity_names_to_entities</span><span class="p">[</span><span class="n">given_entity</span><span class="p">],</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">entry_ids_to_add</span>
            <span class="p">}},</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project_cols</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">given_entity</span><span class="p">,</span>
            <span class="n">outerjoin</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">entries_to_add</span><span class="p">[</span><span class="n">given_entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">builder</span>

    <span class="c1"># TODO (Spyros) To see better! Especially for functional licenses</span>
    <span class="c1"># Check the licenses of exported data.</span>
    <span class="k">if</span> <span class="n">allowed_licenses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">forbidden_licenses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;attributes.source.license&#39;</span><span class="p">],</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">to_be_exported</span><span class="p">}})</span>
        <span class="c1"># Skip those nodes where the license is not set (this is the standard behavior with Django)</span>
        <span class="n">node_licenses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">check_licenses</span><span class="p">(</span><span class="n">node_licenses</span><span class="p">,</span> <span class="n">allowed_licenses</span><span class="p">,</span> <span class="n">forbidden_licenses</span><span class="p">)</span>

    <span class="c1">############################################################</span>
    <span class="c1">##### Start automatic recursive export data generation #####</span>
    <span class="c1">############################################################</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING DATABASE ENTRIES...&#39;</span><span class="p">)</span>

    <span class="n">export_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">entity_separator</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>
    <span class="k">for</span> <span class="n">entity_name</span><span class="p">,</span> <span class="n">partial_query</span> <span class="ow">in</span> <span class="n">entries_to_add</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">foreign_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_fields_info</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="c1"># all_fields_info[model_name].items()</span>
            <span class="k">if</span> <span class="s1">&#39;requires&#39;</span> <span class="ow">in</span> <span class="n">v</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">foreign_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ref_model_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;requires&#39;</span><span class="p">]</span>
            <span class="n">fill_in_query</span><span class="p">(</span><span class="n">partial_query</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">,</span> <span class="n">ref_model_name</span><span class="p">,</span> <span class="p">[</span><span class="n">entity_name</span><span class="p">],</span> <span class="n">entity_separator</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">temp_d</span> <span class="ow">in</span> <span class="n">partial_query</span><span class="o">.</span><span class="n">iterdict</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">temp_d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Get current entity</span>
                <span class="n">current_entity</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">entity_separator</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># This is a empty result of an outer join.</span>
                <span class="c1"># It should not be taken into account.</span>
                <span class="k">if</span> <span class="n">temp_d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">temp_d2</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">temp_d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
                    <span class="n">serialize_dict</span><span class="p">(</span>
                        <span class="n">temp_d</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">remove_fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">rename_fields</span><span class="o">=</span><span class="n">model_fields_to_file_fields</span><span class="p">[</span><span class="n">current_entity</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">export_data</span><span class="p">[</span><span class="n">current_entity</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp_d2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">export_data</span><span class="p">[</span><span class="n">current_entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_d2</span>

    <span class="c1">#######################################</span>
    <span class="c1"># Manually manage attributes and extras</span>
    <span class="c1">#######################################</span>
    <span class="c1"># I use .get because there may be no nodes to export</span>
    <span class="n">all_nodes_pk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">NODE_ENTITY_NAME</span> <span class="ow">in</span> <span class="n">export_data</span><span class="p">:</span>
        <span class="n">all_nodes_pk</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">export_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NODE_ENTITY_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">model_data</span> <span class="ow">in</span> <span class="n">export_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No nodes to store, exiting...&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Exporting a total of </span><span class="si">{}</span><span class="s1"> db entries, of which </span><span class="si">{}</span><span class="s1"> nodes.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">model_data</span> <span class="ow">in</span> <span class="n">export_data</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nodes_pk</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># ATTRIBUTES and EXTRAS</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING NODE ATTRIBUTES AND EXTRAS...&#39;</span><span class="p">)</span>
    <span class="n">node_attributes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">node_extras</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># A second QueryBuilder query to get the attributes and extras. See if this can be optimized</span>
    <span class="k">if</span> <span class="n">all_nodes_pk</span><span class="p">:</span>
        <span class="n">all_nodes_query</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">all_nodes_query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">all_nodes_pk</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span><span class="p">,</span> <span class="s1">&#39;extras&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">res_pk</span><span class="p">,</span> <span class="n">res_attributes</span><span class="p">,</span> <span class="n">res_extras</span> <span class="ow">in</span> <span class="n">all_nodes_query</span><span class="o">.</span><span class="n">iterall</span><span class="p">():</span>
            <span class="n">node_attributes</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">res_pk</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res_attributes</span>
            <span class="n">node_extras</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">res_pk</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res_extras</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING GROUP ELEMENTS...&#39;</span><span class="p">)</span>
    <span class="n">groups_uuid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># If a group is in the exported date, we export the group/node correlation</span>
    <span class="k">if</span> <span class="n">GROUP_ENTITY_NAME</span> <span class="ow">in</span> <span class="n">export_data</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">curr_group</span> <span class="ow">in</span> <span class="n">export_data</span><span class="p">[</span><span class="n">GROUP_ENTITY_NAME</span><span class="p">]:</span>
            <span class="n">group_uuid_qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">group_uuid_qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">entity_names_to_entities</span><span class="p">[</span><span class="n">GROUP_ENTITY_NAME</span><span class="p">],</span>
                <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">curr_group</span>
                <span class="p">}},</span>
                <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span>
                <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
            <span class="p">)</span>
            <span class="n">group_uuid_qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_names_to_entities</span><span class="p">[</span><span class="n">NODE_ENTITY_NAME</span><span class="p">],</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">with_group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">group_uuid_qb</span><span class="o">.</span><span class="n">iterall</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">groups_uuid</span><span class="p">:</span>
                    <span class="n">groups_uuid</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">groups_uuid</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

    <span class="c1">#######################################</span>
    <span class="c1"># Final check for unsealed ProcessNodes</span>
    <span class="c1">#######################################</span>
    <span class="n">process_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node_pk</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">export_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NODE_ENTITY_NAME</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;node_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;process.&#39;</span><span class="p">):</span>
            <span class="n">process_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_pk</span><span class="p">)</span>

    <span class="n">check_process_nodes_sealed</span><span class="p">(</span><span class="n">process_nodes</span><span class="p">)</span>

    <span class="c1">######################################</span>
    <span class="c1"># Now I store</span>
    <span class="c1">######################################</span>
    <span class="c1"># subfolder inside the export package</span>
    <span class="n">nodesubfolder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">get_subfolder</span><span class="p">(</span><span class="n">NODES_EXPORT_SUBFOLDER</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reset_limit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING DATA...&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;node_attributes&#39;</span><span class="p">:</span> <span class="n">node_attributes</span><span class="p">,</span>
        <span class="s1">&#39;node_extras&#39;</span><span class="p">:</span> <span class="n">node_extras</span><span class="p">,</span>
        <span class="s1">&#39;export_data&#39;</span><span class="p">:</span> <span class="n">export_data</span><span class="p">,</span>
        <span class="s1">&#39;links_uuid&#39;</span><span class="p">:</span> <span class="n">links_uuid</span><span class="p">,</span>
        <span class="s1">&#39;groups_uuid&#39;</span><span class="p">:</span> <span class="n">groups_uuid</span>
    <span class="p">}</span>

    <span class="c1"># N.B. We&#39;re really calling zipfolder.open (if exporting a zipfile)</span>
    <span class="k">with</span> <span class="n">folder</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data.json&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
        <span class="c1"># fhandle.write(json.dumps(data, cls=UUIDEncoder))</span>
        <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="c1"># Add proper signature to unique identifiers &amp; all_fields_info</span>
    <span class="c1"># Ignore if a key doesn&#39;t exist in any of the two dictionaries</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;aiida_version&#39;</span><span class="p">:</span> <span class="n">get_version</span><span class="p">(),</span>
        <span class="s1">&#39;export_version&#39;</span><span class="p">:</span> <span class="n">EXPORT_VERSION</span><span class="p">,</span>
        <span class="s1">&#39;all_fields_info&#39;</span><span class="p">:</span> <span class="n">all_fields_info</span><span class="p">,</span>
        <span class="s1">&#39;unique_identifiers&#39;</span><span class="p">:</span> <span class="n">unique_identifiers</span><span class="p">,</span>
        <span class="s1">&#39;export_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;graph_traversal_rules&#39;</span><span class="p">:</span> <span class="n">graph_traversal_rules</span><span class="p">,</span>
            <span class="s1">&#39;entities_starting_set&#39;</span><span class="p">:</span> <span class="n">entities_starting_set</span><span class="p">,</span>
            <span class="s1">&#39;include_comments&#39;</span><span class="p">:</span> <span class="n">include_comments</span><span class="p">,</span>
            <span class="s1">&#39;include_logs&#39;</span><span class="p">:</span> <span class="n">include_logs</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">with</span> <span class="n">folder</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
        <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">silent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STORING REPOSITORY FILES...&#39;</span><span class="p">)</span>

    <span class="c1"># If there are no nodes, there are no repository files to store</span>
    <span class="k">if</span> <span class="n">all_nodes_pk</span><span class="p">:</span>
        <span class="c1"># Large speed increase by not getting the node itself and looping in memory in python, but just getting the uuid</span>
        <span class="n">uuid_query</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">uuid_query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">all_nodes_pk</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">uuid_query</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sharded_uuid</span> <span class="o">=</span> <span class="n">export_shard_uuid</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

            <span class="c1"># Important to set create=False, otherwise creates twice a subfolder. Maybe this is a bug of insert_path?</span>
            <span class="n">thisnodefolder</span> <span class="o">=</span> <span class="n">nodesubfolder</span><span class="o">.</span><span class="n">get_subfolder</span><span class="p">(</span><span class="n">sharded_uuid</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reset_limit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Make sure the node&#39;s repository folder was not deleted</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">RepositoryFolder</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">Repository</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuid</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveExportError</span><span class="p">(</span>
                    <span class="s1">&#39;Unable to find the repository folder for Node with UUID=</span><span class="si">{}</span><span class="s1"> in the local repository&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># In this way, I copy the content of the folder, and not the folder itself</span>
            <span class="n">thisnodefolder</span><span class="o">.</span><span class="n">insert_path</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">dest_name</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="export"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.importexport.dbexport.html#aiida.tools.importexport.export">[docs]</a><span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;export_data.aiida.tar.gz&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Export the entries passed in the &#39;what&#39; list to a file tree.</span>

<span class="sd">    :param what: a list of entity instances; they can belong to different models/entities.</span>
<span class="sd">    :type what: list</span>

<span class="sd">    :param outfile: the filename (possibly including the absolute path) of the file on which to export.</span>
<span class="sd">    :type outfile: str</span>

<span class="sd">    :param overwrite: if True, overwrite the output file without asking, if it exists. If False, raise an</span>
<span class="sd">        :py:class:`~aiida.tools.importexport.common.exceptions.ArchiveExportError` if the output file already exists.</span>
<span class="sd">    :type overwrite: bool</span>

<span class="sd">    :param silent: suppress prints.</span>
<span class="sd">    :type silent: bool</span>

<span class="sd">    :param allowed_licenses: List or function. If a list, then checks whether all licenses of Data nodes are in the</span>
<span class="sd">        list. If a function, then calls function for licenses of Data nodes expecting True if license is allowed, False</span>
<span class="sd">        otherwise.</span>
<span class="sd">    :type allowed_licenses: list</span>

<span class="sd">    :param forbidden_licenses: List or function. If a list, then checks whether all licenses of Data nodes are in the</span>
<span class="sd">        list. If a function, then calls function for licenses of Data nodes expecting True if license is allowed, False</span>
<span class="sd">        otherwise.</span>
<span class="sd">    :type forbidden_licenses: list</span>

<span class="sd">    :param include_comments: In-/exclude export of comments for given node(s) in ``what``.</span>
<span class="sd">        Default: True, *include* comments in export (as well as relevant users).</span>
<span class="sd">    :type include_comments: bool</span>

<span class="sd">    :param include_logs: In-/exclude export of logs for given node(s) in ``what``.</span>
<span class="sd">        Default: True, *include* logs in export.</span>
<span class="sd">    :type include_logs: bool</span>

<span class="sd">    :param kwargs: graph traversal rules. See :const:`aiida.common.links.GraphTraversalRules` what rule names</span>
<span class="sd">        are toggleable and what the defaults are.</span>

<span class="sd">    :raises `~aiida.tools.importexport.common.exceptions.ArchiveExportError`: if there are any internal errors when</span>
<span class="sd">        exporting.</span>
<span class="sd">    :raises `~aiida.common.exceptions.LicensingException`: if any node is licensed under forbidden license.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.folders</span> <span class="kn">import</span> <span class="n">SandboxFolder</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveExportError</span><span class="p">(</span><span class="s2">&quot;The output file &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile</span><span class="p">))</span>

    <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
    <span class="n">time_export_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">export_tree</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">time_export_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;COMPRESSING...&#39;</span><span class="p">)</span>

    <span class="n">time_compress_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w:gz&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">PAX_FORMAT</span><span class="p">,</span> <span class="n">dereference</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">time_compress_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="n">filecr_time</span> <span class="o">=</span> <span class="n">time_export_end</span> <span class="o">-</span> <span class="n">time_export_start</span>
        <span class="n">filecomp_time</span> <span class="o">=</span> <span class="n">time_compress_end</span> <span class="o">-</span> <span class="n">time_compress_start</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Exported in </span><span class="si">{:6.2g}</span><span class="s1">s, compressed in </span><span class="si">{:6.2g}</span><span class="s1">s, total: </span><span class="si">{:6.2g}</span><span class="s1">s.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filecr_time</span><span class="p">,</span> <span class="n">filecomp_time</span><span class="p">,</span> <span class="n">filecr_time</span> <span class="o">+</span> <span class="n">filecomp_time</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DONE.&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>