

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.cmdline.commands.cmd_process &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/togglebutton.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.cmdline.commands.cmd_process</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.cmdline.commands.cmd_process</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="c1"># pylint: disable=too-many-arguments</span>
<span class="sd">&quot;&quot;&quot;`verdi process` command.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">click</span>

<span class="kn">from</span> <span class="nn">kiwipy</span> <span class="kn">import</span> <span class="n">communications</span>

<span class="kn">from</span> <span class="nn">aiida.cmdline.commands.cmd_verdi</span> <span class="kn">import</span> <span class="n">verdi</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.params</span> <span class="kn">import</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">options</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="kn">import</span> <span class="n">decorators</span><span class="p">,</span> <span class="n">echo</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils.query.calculation</span> <span class="kn">import</span> <span class="n">CalculationQueryBuilder</span>
<span class="kn">from</span> <span class="nn">aiida.common.log</span> <span class="kn">import</span> <span class="n">LOG_LEVELS</span>
<span class="kn">from</span> <span class="nn">aiida.manage.manager</span> <span class="kn">import</span> <span class="n">get_manager</span>


<span class="nd">@verdi</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;process&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">verdi_process</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Inspect and manage processes.&quot;&quot;&quot;</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">(</span><span class="n">CalculationQueryBuilder</span><span class="o">.</span><span class="n">valid_projections</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="n">CalculationQueryBuilder</span><span class="o">.</span><span class="n">default_projections</span>
<span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">ORDER_BY</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">ORDER_DIRECTION</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">GROUP</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only include entries that are a member of this group.&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">ALL</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show all entries, regardless of their process state.&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">PROCESS_STATE</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">PROCESS_LABEL</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">EXIT_STATUS</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">FAILED</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">PAST_DAYS</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">RAW</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_list</span><span class="p">(</span>
    <span class="n">all_entries</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">process_state</span><span class="p">,</span> <span class="n">process_label</span><span class="p">,</span> <span class="n">exit_status</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">past_days</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">order_by</span><span class="p">,</span>
    <span class="n">order_dir</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show a list of running or terminated processes.</span>

<span class="sd">    By default, only those that are still running are shown, but there are options</span>
<span class="sd">    to show also the finished ones.&quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-locals</span>
    <span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.common</span> <span class="kn">import</span> <span class="n">print_last_process_state_change</span><span class="p">,</span> <span class="n">check_worker_load</span>

    <span class="n">relationships</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
        <span class="n">relationships</span><span class="p">[</span><span class="s1">&#39;with_node&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>

    <span class="n">builder</span> <span class="o">=</span> <span class="n">CalculationQueryBuilder</span><span class="p">()</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_filters</span><span class="p">(</span><span class="n">all_entries</span><span class="p">,</span> <span class="n">process_state</span><span class="p">,</span> <span class="n">process_label</span><span class="p">,</span> <span class="n">exit_status</span><span class="p">,</span> <span class="n">failed</span><span class="p">)</span>
    <span class="n">query_set</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_query_set</span><span class="p">(</span>
        <span class="n">relationships</span><span class="o">=</span><span class="n">relationships</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="p">{</span><span class="n">order_by</span><span class="p">:</span> <span class="n">order_dir</span><span class="p">},</span> <span class="n">past_days</span><span class="o">=</span><span class="n">past_days</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
    <span class="p">)</span>
    <span class="n">projected</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_projected</span><span class="p">(</span><span class="n">query_set</span><span class="p">,</span> <span class="n">projections</span><span class="o">=</span><span class="n">project</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="n">projected</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">tabulated</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">projected</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulated</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tabulated</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">projected</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulated</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Total results: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">projected</span><span class="p">)))</span>
        <span class="n">print_last_process_state_change</span><span class="p">()</span>
        <span class="c1"># Second query to get active process count</span>
        <span class="c1"># Currently this is slow but will be fixed wiith issue #2770</span>
        <span class="c1"># We place it at the end so that the user can Ctrl+C after getting the process table.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">CalculationQueryBuilder</span><span class="p">()</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_filters</span><span class="p">(</span><span class="n">process_state</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;waiting&#39;</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">))</span>
        <span class="n">query_set</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_query_set</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">projected</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_projected</span><span class="p">(</span><span class="n">query_set</span><span class="p">,</span> <span class="n">projections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">worker_slot_use</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">projected</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">check_worker_load</span><span class="p">(</span><span class="n">worker_slot_use</span><span class="p">)</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">PROCESSES</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_show</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show details for one or multiple processes.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.common</span> <span class="kn">import</span> <span class="n">get_node_info</span>

    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">get_node_info</span><span class="p">(</span><span class="n">process</span><span class="p">))</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;call-root&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">PROCESSES</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_call_root</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show root process of the call stack for the given processes.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="n">caller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;No callers found for Process&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">next_caller</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">caller</span>

            <span class="k">if</span> <span class="n">next_caller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">caller</span> <span class="o">=</span> <span class="n">next_caller</span>

        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;report&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">PROCESSES</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--indent-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the number of spaces to indent each level by.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-l&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--levelname&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">(</span><span class="n">LOG_LEVELS</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;REPORT&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filter the results by name of the log level.&#39;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--max-depth&#39;</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Limit the number of levels to be printed.&#39;</span>
<span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_report</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">levelname</span><span class="p">,</span> <span class="n">indent_size</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the log report for one or multiple processes.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.common</span> <span class="kn">import</span> <span class="n">get_calcjob_report</span><span class="p">,</span> <span class="n">get_workchain_report</span><span class="p">,</span> <span class="n">get_process_function_report</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">WorkChainNode</span><span class="p">,</span> <span class="n">CalcFunctionNode</span><span class="p">,</span> <span class="n">WorkFunctionNode</span>

    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">CalcJobNode</span><span class="p">):</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">get_calcjob_report</span><span class="p">(</span><span class="n">process</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">WorkChainNode</span><span class="p">):</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">get_workchain_report</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">levelname</span><span class="p">,</span> <span class="n">indent_size</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="p">(</span><span class="n">CalcFunctionNode</span><span class="p">,</span> <span class="n">WorkFunctionNode</span><span class="p">)):</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">get_process_function_report</span><span class="p">(</span><span class="n">process</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Nothing to show for node type </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="p">))</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">PROCESSES</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_status</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the status of one or multiple processes.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.ascii_vis</span> <span class="kn">import</span> <span class="n">format_call_graph</span>

    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">format_call_graph</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;kill&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">PROCESSES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">WAIT</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">only_if_daemon_running</span><span class="p">(</span><span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">,</span> <span class="s1">&#39;daemon is not running, so process may not be reachable&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_kill</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">wait</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Kill running processes.&quot;&quot;&quot;</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_process_controller</span><span class="p">()</span>

    <span class="n">futures</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_terminated</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;Process&lt;</span><span class="si">{}</span><span class="s1">&gt; is already terminated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">kill_process</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Killed through `verdi process kill`&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">communications</span><span class="o">.</span><span class="n">UnroutableError</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;Process&lt;</span><span class="si">{}</span><span class="s1">&gt; is unreachable&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>

    <span class="n">process_actions</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="s1">&#39;killing&#39;</span><span class="p">,</span> <span class="s1">&#39;killed&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;pause&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">PROCESSES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">ALL</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Pause all active processes if no specific processes are specified.&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">WAIT</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">only_if_daemon_running</span><span class="p">(</span><span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">,</span> <span class="s1">&#39;daemon is not running, so process may not be reachable&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_pause</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">all_entries</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">wait</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pause running processes.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">ProcessNode</span><span class="p">,</span> <span class="n">QueryBuilder</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_process_controller</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">processes</span> <span class="ow">and</span> <span class="n">all_entries</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadOptionUsage</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;cannot specify individual processes and the `--all` flag at the same time.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">processes</span> <span class="ow">and</span> <span class="n">all_entries</span><span class="p">:</span>
        <span class="n">active_states</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">active_process_states</span><span class="p">()</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProcessNode</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.process_state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">active_states</span><span class="p">}})</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">futures</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_terminated</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;Process&lt;</span><span class="si">{}</span><span class="s1">&gt; is already terminated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">pause_process</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Paused through `verdi process pause`&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">communications</span><span class="o">.</span><span class="n">UnroutableError</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;Process&lt;</span><span class="si">{}</span><span class="s1">&gt; is unreachable&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>

    <span class="n">process_actions</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="s1">&#39;pause&#39;</span><span class="p">,</span> <span class="s1">&#39;pausing&#39;</span><span class="p">,</span> <span class="s1">&#39;paused&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;play&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">PROCESSES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">ALL</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Play all paused processes if no specific processes are specified.&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">WAIT</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">only_if_daemon_running</span><span class="p">(</span><span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">,</span> <span class="s1">&#39;daemon is not running, so process may not be reachable&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_play</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">all_entries</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">wait</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Play (unpause) paused processes.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">ProcessNode</span><span class="p">,</span> <span class="n">QueryBuilder</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_process_controller</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">processes</span> <span class="ow">and</span> <span class="n">all_entries</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadOptionUsage</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;cannot specify individual processes and the `--all` flag at the same time.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">processes</span> <span class="ow">and</span> <span class="n">all_entries</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProcessNode</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.paused&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">futures</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_terminated</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;Process&lt;</span><span class="si">{}</span><span class="s1">&gt; is already terminated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">play_process</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">communications</span><span class="o">.</span><span class="n">UnroutableError</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;Process&lt;</span><span class="si">{}</span><span class="s1">&gt; is unreachable&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>

    <span class="n">process_actions</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="s1">&#39;play&#39;</span><span class="p">,</span> <span class="s1">&#39;playing&#39;</span><span class="p">,</span> <span class="s1">&#39;played&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>


<span class="nd">@verdi_process</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;watch&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">PROCESSES</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">only_if_daemon_running</span><span class="p">(</span><span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">,</span> <span class="s1">&#39;daemon is not running, so process may not be reachable&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_watch</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Watch the state transitions for a process.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
    <span class="kn">from</span> <span class="nn">kiwipy</span> <span class="kn">import</span> <span class="n">BroadcastFilter</span>

    <span class="k">def</span> <span class="nf">_print</span><span class="p">(</span><span class="n">communicator</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">correlation_id</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="sd">&quot;&quot;&quot;Format the incoming broadcast data into a message and echo it to stdout.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;No message specified&#39;</span>

        <span class="k">if</span> <span class="n">correlation_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correlation_id</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span>

        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Process&lt;</span><span class="si">{}</span><span class="s1">&gt; [</span><span class="si">{}</span><span class="s1">|</span><span class="si">{}</span><span class="s1">]: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">correlation_id</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>

    <span class="n">communicator</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_communicator</span><span class="p">()</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;watching for broadcasted messages, press CTRL+C to stop...&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_terminated</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;Process&lt;</span><span class="si">{}</span><span class="s1">&gt; is already terminated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="n">communicator</span><span class="o">.</span><span class="n">add_broadcast_subscriber</span><span class="p">(</span><span class="n">BroadcastFilter</span><span class="p">(</span><span class="n">_print</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Block this thread indefinitely until interrupt</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># add a new line after the interrupt character</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;received interrupt, exiting...&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">communicator</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Reraise to trigger clicks builtin abort sequence</span>
        <span class="k">raise</span>


<div class="viewcode-block" id="process_actions"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_process.process_actions">[docs]</a><span class="k">def</span> <span class="nf">process_actions</span><span class="p">(</span><span class="n">futures_map</span><span class="p">,</span> <span class="n">infinitive</span><span class="p">,</span> <span class="n">present</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the requested actions sent to a set of Processes given a map of the futures and the</span>
<span class="sd">    corresponding processes.  This function will echo the correct information strings based on</span>
<span class="sd">    the outcomes of the futures and the given verb conjugations.  You can optionally wait for</span>
<span class="sd">    any pending actions to be completed before the functions returns and use a timeout to put</span>
<span class="sd">    a maximum wait time on the actions.</span>

<span class="sd">    :param futures_map: the map of action futures and the corresponding processes</span>
<span class="sd">    :type futures_map: dict</span>
<span class="sd">    :param infinitive: the infinitive form of the action verb</span>
<span class="sd">    :type infinitive: str</span>
<span class="sd">    :param present: the present tense form</span>
<span class="sd">    :type present: str</span>
<span class="sd">    :param past: the past tense form</span>
<span class="sd">    :type past: str</span>
<span class="sd">    :param wait: if True, waits for pending actions to be competed, otherwise just returns</span>
<span class="sd">    :type wait: bool</span>
<span class="sd">    :param timeout: the timeout (in seconds) to wait for actions to be completed</span>
<span class="sd">    :type timeout: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="kn">import</span> <span class="nn">kiwipy</span>
    <span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>

    <span class="kn">from</span> <span class="nn">aiida.manage.external.rmq</span> <span class="kn">import</span> <span class="n">CommunicationTimeout</span>

    <span class="n">scheduled</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures_map</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">):</span>
            <span class="c1"># Get the corresponding process</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">futures_map</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">CommunicationTimeout</span><span class="p">:</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;call to </span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt; timed out&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infinitive</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;failed to </span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infinitive</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;problem </span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">present</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">kiwipy</span><span class="o">.</span><span class="n">Future</span><span class="p">):</span>
                    <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;scheduled </span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infinitive</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
                    <span class="n">scheduled</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span>
                        <span class="s1">&#39;got unexpected response when </span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">present</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">wait</span> <span class="ow">and</span> <span class="n">scheduled</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;waiting for process(es) </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">scheduled</span><span class="o">.</span><span class="n">values</span><span class="p">()])))</span>

            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">scheduled</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">):</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">scheduled</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                    <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;failed to </span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infinitive</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;problem </span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">present</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span>
                            <span class="s1">&#39;got unexpected response when </span><span class="si">{}</span><span class="s1"> Process&lt;</span><span class="si">{}</span><span class="s1">&gt;: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">present</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                        <span class="p">)</span>

    <span class="k">except</span> <span class="n">futures</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;timed out trying to </span><span class="si">{}</span><span class="s1"> processes </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infinitive</span><span class="p">,</span> <span class="n">futures_map</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>