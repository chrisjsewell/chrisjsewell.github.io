

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.cmdline.commands.cmd_daemon &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/togglebutton.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.cmdline.commands.cmd_daemon</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.cmdline.commands.cmd_daemon</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;`verdi daemon` commands.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">from</span> <span class="nn">click_spinner</span> <span class="kn">import</span> <span class="n">spinner</span>

<span class="kn">from</span> <span class="nn">aiida.cmdline.commands.cmd_verdi</span> <span class="kn">import</span> <span class="n">verdi</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="kn">import</span> <span class="n">decorators</span><span class="p">,</span> <span class="n">echo</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils.common</span> <span class="kn">import</span> <span class="n">get_env_with_venv_bin</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils.daemon</span> <span class="kn">import</span> <span class="n">get_daemon_status</span><span class="p">,</span> \
    <span class="n">print_client_response_status</span><span class="p">,</span> <span class="n">delete_stale_pid_file</span><span class="p">,</span> <span class="n">_START_CIRCUS_COMMAND</span>
<span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="kn">import</span> <span class="n">get_config</span>


<div class="viewcode-block" id="validate_daemon_workers"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_daemon.validate_daemon_workers">[docs]</a><span class="k">def</span> <span class="nf">validate_daemon_workers</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument,invalid-name</span>
    <span class="sd">&quot;&quot;&quot;Validate the value for the number of daemon workers to start with default set by config.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;daemon.default_workers&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not an integer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a positive non-zero integer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">value</span></div>


<span class="nd">@verdi</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;daemon&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">verdi_daemon</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Inspect and manage the daemon.&quot;&quot;&quot;</span>


<span class="nd">@verdi_daemon</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--foreground&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run in foreground.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">validate_daemon_workers</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">check_circus_zmq_version</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">foreground</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Start the daemon with NUMBER workers.</span>

<span class="sd">    If the NUMBER of desired workers is not specified, the default is used, which is determined by the configuration</span>
<span class="sd">    option `daemon.default_workers`, which if not explicitly changed defaults to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="kn">import</span> <span class="n">get_daemon_client</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">()</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Starting the daemon... &#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">foreground</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;verdi&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;daemon&#39;</span><span class="p">,</span> <span class="n">_START_CIRCUS_COMMAND</span><span class="p">,</span> <span class="s1">&#39;--foreground&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;verdi&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;daemon&#39;</span><span class="p">,</span> <span class="n">_START_CIRCUS_COMMAND</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">currenv</span> <span class="o">=</span> <span class="n">get_env_with_venv_bin</span><span class="p">()</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">currenv</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>  <span class="c1"># pylint: disable=unexpected-keyword-arg</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;FAILED&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="c1"># We add a small timeout to give the pid-file a chance to be created</span>
    <span class="k">with</span> <span class="n">spinner</span><span class="p">():</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="n">print_client_response_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>


<span class="nd">@verdi_daemon</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">,</span> <span class="s1">&#39;all_profiles&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show status of all daemons.&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">all_profiles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the status of the current daemon or all daemons.</span>

<span class="sd">    Returns exit code 0 if all requested daemons are running, else exit code 3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="kn">import</span> <span class="n">get_daemon_client</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">all_profiles</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">profile</span> <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">profiles</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="o">.</span><span class="n">is_test_profile</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">current_profile</span><span class="p">]</span>

    <span class="n">daemons_running</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">profiles</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">delete_stale_pid_file</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Profile: &#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">get_daemon_status</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">daemons_running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">is_daemon_running</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">daemons_running</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="nd">@verdi_daemon</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">only_if_daemon_running</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">incr</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add NUMBER [default=1] workers to the running daemon.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="kn">import</span> <span class="n">get_daemon_client</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">increase_workers</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="n">print_client_response_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>


<span class="nd">@verdi_daemon</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">only_if_daemon_running</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">decr</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove NUMBER [default=1] workers from the running daemon.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="kn">import</span> <span class="n">get_daemon_client</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">decrease_workers</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="n">print_client_response_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>


<span class="nd">@verdi_daemon</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">logshow</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Show the log of the daemon, press CTRL+C to quit.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="kn">import</span> <span class="n">get_daemon_client</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">currenv</span> <span class="o">=</span> <span class="n">get_env_with_venv_bin</span><span class="p">()</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;tail&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">daemon_log_file</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">currenv</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>


<span class="nd">@verdi_daemon</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--no-wait&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not wait for confirmation.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">,</span> <span class="s1">&#39;all_profiles&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Stop all daemons.&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">no_wait</span><span class="p">,</span> <span class="n">all_profiles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stop the daemon.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="kn">import</span> <span class="n">get_daemon_client</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">all_profiles</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">profile</span> <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">profiles</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="o">.</span><span class="n">is_test_profile</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">current_profile</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">profiles</span><span class="p">:</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Profile: &#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">is_daemon_running</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Daemon was not running&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">delete_stale_pid_file</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

        <span class="n">wait</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">no_wait</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Waiting for the daemon to shut down... &#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Shutting the daemon down&#39;</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">stop_daemon</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">client</span><span class="o">.</span><span class="n">DAEMON_ERROR_NOT_RUNNING</span><span class="p">:</span>
                <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;The daemon was not running.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_client_response_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>


<span class="nd">@verdi_daemon</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--reset&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Completely reset the daemon.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--no-wait&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not wait for confirmation.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">pass_context</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">only_if_daemon_running</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="n">no_wait</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Restart the daemon.</span>

<span class="sd">    By default will only reset the workers of the running daemon. After the restart the same amount of workers will be</span>
<span class="sd">    running. If the `--reset` flag is passed, however, the full daemon will be stopped and restarted with the default</span>
<span class="sd">    number of workers that is started when calling `verdi daemon start` manually.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="kn">import</span> <span class="n">get_daemon_client</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">()</span>

    <span class="n">wait</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">no_wait</span>

    <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
        <span class="c1"># These two lines can be simplified to `ctx.invoke(start)` once issue #950 in `click` is resolved.</span>
        <span class="c1"># Due to that bug, the `callback` of the `number` argument the `start` command is not being called, which is</span>
        <span class="c1"># responsible for settting the default value, which causes `None` to be passed and that triggers an exception.</span>
        <span class="c1"># As a temporary workaround, we fetch the default here manually and pass that in explicitly.</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;daemon.default_workers&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Restarting the daemon... &#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Restarting the daemon&#39;</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">restart_daemon</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">print_client_response_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>


<span class="nd">@verdi_daemon</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--foreground&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run in foreground.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">validate_daemon_workers</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">check_circus_zmq_version</span>
<span class="k">def</span> <span class="nf">start_circus</span><span class="p">(</span><span class="n">foreground</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This will actually launch the circus daemon, either daemonized in the background or in the foreground.</span>

<span class="sd">    If run in the foreground all logs are redirected to stdout.</span>

<span class="sd">    .. note:: this should not be called directly from the commandline!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">circus</span> <span class="kn">import</span> <span class="n">get_arbiter</span>
    <span class="kn">from</span> <span class="nn">circus</span> <span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">circus_logger</span>
    <span class="kn">from</span> <span class="nn">circus.circusd</span> <span class="kn">import</span> <span class="n">daemonize</span>
    <span class="kn">from</span> <span class="nn">circus.pidfile</span> <span class="kn">import</span> <span class="n">Pidfile</span>
    <span class="kn">from</span> <span class="nn">circus.util</span> <span class="kn">import</span> <span class="n">check_future_exception_and_log</span><span class="p">,</span> <span class="n">configure_logger</span>

    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="kn">import</span> <span class="n">get_daemon_client</span>

    <span class="k">if</span> <span class="n">foreground</span> <span class="ow">and</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">ClickException</span><span class="p">(</span><span class="s1">&#39;can only run a single worker when running in the foreground&#39;</span><span class="p">)</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">()</span>

    <span class="n">loglevel</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">loglevel</span>
    <span class="n">logoutput</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">foreground</span><span class="p">:</span>
        <span class="n">logoutput</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">circus_log_file</span>

    <span class="n">arbiter_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;controller&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">get_controller_endpoint</span><span class="p">(),</span>
        <span class="s1">&#39;pubsub_endpoint&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">get_pubsub_endpoint</span><span class="p">(),</span>
        <span class="s1">&#39;stats_endpoint&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">get_stats_endpoint</span><span class="p">(),</span>
        <span class="s1">&#39;logoutput&#39;</span><span class="p">:</span> <span class="n">logoutput</span><span class="p">,</span>
        <span class="s1">&#39;loglevel&#39;</span><span class="p">:</span> <span class="n">loglevel</span><span class="p">,</span>
        <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;statsd&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;pidfile&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">circus_pid_file</span><span class="p">,</span>
        <span class="s1">&#39;watchers&#39;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">cmd_string</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">daemon_name</span><span class="p">,</span>
            <span class="s1">&#39;numprocesses&#39;</span><span class="p">:</span> <span class="n">number</span><span class="p">,</span>
            <span class="s1">&#39;virtualenv&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">virtualenv</span><span class="p">,</span>
            <span class="s1">&#39;copy_env&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;stdout_stream&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;FileStream&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">daemon_log_file</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;stderr_stream&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;FileStream&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">daemon_log_file</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;env&#39;</span><span class="p">:</span> <span class="n">get_env_with_venv_bin</span><span class="p">(),</span>
        <span class="p">}]</span>
    <span class="p">}</span>  <span class="c1"># yapf: disable</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">foreground</span><span class="p">:</span>
        <span class="n">daemonize</span><span class="p">()</span>

    <span class="n">arbiter</span> <span class="o">=</span> <span class="n">get_arbiter</span><span class="p">(</span><span class="o">**</span><span class="n">arbiter_config</span><span class="p">)</span>
    <span class="n">pidfile</span> <span class="o">=</span> <span class="n">Pidfile</span><span class="p">(</span><span class="n">arbiter</span><span class="o">.</span><span class="n">pidfile</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pidfile</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="c1"># Configure the logger</span>
    <span class="n">loggerconfig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">loggerconfig</span> <span class="o">=</span> <span class="n">loggerconfig</span> <span class="ow">or</span> <span class="n">arbiter</span><span class="o">.</span><span class="n">loggerconfig</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="n">configure_logger</span><span class="p">(</span><span class="n">circus_logger</span><span class="p">,</span> <span class="n">loglevel</span><span class="p">,</span> <span class="n">logoutput</span><span class="p">,</span> <span class="n">loggerconfig</span><span class="p">)</span>

    <span class="c1"># Main loop</span>
    <span class="n">should_restart</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">while</span> <span class="n">should_restart</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">arbiter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">should_restart</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">check_future_exception_and_log</span><span class="p">(</span><span class="n">future</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">should_restart</span> <span class="o">=</span> <span class="n">arbiter</span><span class="o">.</span><span class="n">_restarting</span>  <span class="c1"># pylint: disable=protected-access</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="c1"># Emergency stop</span>
            <span class="n">arbiter</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">arbiter</span><span class="o">.</span><span class="n">_emergency_stop</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="k">raise</span> <span class="n">exception</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">arbiter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">pidfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pidfile</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>