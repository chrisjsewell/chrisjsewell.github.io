

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.cmdline.commands.cmd_node &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/togglebutton.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.cmdline.commands.cmd_node</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.cmdline.commands.cmd_node</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;`verdi node` command.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">tabulate</span>

<span class="kn">from</span> <span class="nn">aiida.cmdline.commands.cmd_verdi</span> <span class="kn">import</span> <span class="n">verdi</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.params</span> <span class="kn">import</span> <span class="n">options</span><span class="p">,</span> <span class="n">arguments</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.params.types.plugin</span> <span class="kn">import</span> <span class="n">PluginParamType</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="kn">import</span> <span class="n">decorators</span><span class="p">,</span> <span class="n">echo</span><span class="p">,</span> <span class="n">multi_line_input</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils.decorators</span> <span class="kn">import</span> <span class="n">with_dbenv</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="kn">import</span> <span class="n">GraphTraversalRules</span>


<span class="nd">@verdi</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">verdi_node</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Inspect, create and manage nodes.&quot;&quot;&quot;</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;repo&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">verdi_node_repo</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Inspect the content of a node repository folder.&quot;&quot;&quot;</span>


<span class="nd">@verdi_node_repo</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODE</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;relative_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">repo_cat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Output the content of a file in the node repository folder.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_object_content</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;failed to get the content of file `</span><span class="si">{}</span><span class="s1">`: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">relative_path</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="nd">@verdi_node_repo</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODE</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;relative_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--color&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">flag_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use different color for folders and files.&#39;</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">repo_ls</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List files in the node repository folder.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.repository</span> <span class="kn">import</span> <span class="n">list_repository_contents</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">list_repository_contents</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;the path `</span><span class="si">{}</span><span class="s1">` does not exist for the given node&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">relative_path</span><span class="p">))</span>


<span class="nd">@verdi_node_repo</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;dump&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODE</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span>
    <span class="s1">&#39;output_directory&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(),</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">repo_dump</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy the repository files of a node to an output directory.</span>

<span class="sd">    The output directory should not exist. If it does, the command</span>
<span class="sd">    will abort.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.utils.repository</span> <span class="kn">import</span> <span class="n">FileType</span>

    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;Invalid value for &quot;OUTPUT_DIRECTORY&quot;: Path &quot;</span><span class="si">{}</span><span class="s1">&quot; exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_directory</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_copy_tree</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively copy the content at the ``key`` path in the given node to</span>
<span class="sd">        the ``output_dir``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">list_objects</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">):</span>
            <span class="c1"># Not using os.path.join here, because this is the &quot;path&quot;</span>
            <span class="c1"># in the AiiDA node, not an actual OS - level path.</span>
            <span class="n">file_key</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="k">else</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FileType</span><span class="o">.</span><span class="n">DIRECTORY</span><span class="p">:</span>
                <span class="n">new_out_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">new_out_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="n">new_out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
                <span class="n">_copy_tree</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">new_out_dir</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">file</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FileType</span><span class="o">.</span><span class="n">FILE</span>
                <span class="n">out_file_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">out_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">node</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_key</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">out_file_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>

    <span class="n">_copy_tree</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_directory</span><span class="p">)</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">LABEL</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set LABEL as the new label for all NODES&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">RAW</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Display only the labels, no extra information&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">FORCE</span><span class="p">()</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">node_label</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">force</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;View or set the label of one or more nodes.&quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">label</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">label</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Label&#39;</span><span class="p">]))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="s1">&#39;Are you sure you want to set the label for </span><span class="si">{}</span><span class="s1"> nodes?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
            <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

        <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s2">&quot;Set label &#39;</span><span class="si">{}</span><span class="s2">&#39; for </span><span class="si">{}</span><span class="s2"> nodes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)))</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set DESCRIPTION as the new description for all NODES&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">RAW</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Display only descriptions, no extra information&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">FORCE</span><span class="p">()</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">node_description</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">raw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;View or set the description of one or more nodes.&quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">description</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">description</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Description&#39;</span><span class="p">]))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="s1">&#39;Are you sure you want to set the description for  </span><span class="si">{}</span><span class="s1"> nodes?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
            <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>

        <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;Set description for </span><span class="si">{}</span><span class="s1"> nodes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)))</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--print-groups&#39;</span><span class="p">,</span> <span class="s1">&#39;print_groups&#39;</span><span class="p">,</span> <span class="n">flag_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show groups containing the nodes.&#39;</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">node_show</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">print_groups</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show generic information on one or more nodes.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.common</span> <span class="kn">import</span> <span class="n">get_node_info</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="c1"># pylint: disable=fixme</span>
        <span class="c1"># TODO: Add a check here on the node type, otherwise it might try to access</span>
        <span class="c1"># attributes such as code which are not necessarily there</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">get_node_info</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">print_groups</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">aiida.orm.querybuilder</span> <span class="kn">import</span> <span class="n">QueryBuilder</span>
            <span class="kn">from</span> <span class="nn">aiida.orm.groups</span> <span class="kn">import</span> <span class="n">Group</span>
            <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">Node</span>  <span class="c1"># pylint: disable=redefined-outer-name</span>

            <span class="c1"># pylint: disable=invalid-name</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">}})</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Group</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type_string&#39;</span><span class="p">])</span>

            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;#### GROUPS:&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Node </span><span class="si">{}</span><span class="s1"> does not belong to any group&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Node </span><span class="si">{}</span><span class="s1"> belongs to the following groups:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">iterdict</span><span class="p">()</span>
                <span class="n">table</span> <span class="o">=</span> <span class="p">[(</span><span class="n">gr</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">gr</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">gr</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">][</span><span class="s1">&#39;type_string&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
                <span class="n">table</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PK&#39;</span><span class="p">,</span> <span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="s1">&#39;Group type&#39;</span><span class="p">]))</span>


<div class="viewcode-block" id="echo_node_dict"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_node.echo_node_dict">[docs]</a><span class="k">def</span> <span class="nf">echo_node_dict</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">use_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the attributes or extras of one or more nodes.&quot;&quot;&quot;</span>
    <span class="n">all_nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span>
            <span class="n">id_name</span> <span class="o">=</span> <span class="s1">&#39;PK&#39;</span>
            <span class="n">id_value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">pk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_name</span> <span class="o">=</span> <span class="s1">&#39;UUID&#39;</span>
            <span class="n">id_value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>

        <span class="k">if</span> <span class="n">use_attrs</span><span class="p">:</span>
            <span class="n">node_dict</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span>
            <span class="n">dict_name</span> <span class="o">=</span> <span class="s1">&#39;attributes&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_dict</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">extras</span>
            <span class="n">dict_name</span> <span class="o">=</span> <span class="s1">&#39;extras&#39;</span>

        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">all_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">id_name</span><span class="p">:</span> <span class="n">id_value</span><span class="p">,</span> <span class="n">dict_name</span><span class="p">:</span> <span class="n">node_dict</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_name</span><span class="p">,</span> <span class="n">id_value</span><span class="p">),</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_dictionary</span><span class="p">(</span><span class="n">node_dict</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_dictionary</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span></div>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;attributes&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">DICT_KEYS</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">DICT_FORMAT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">IDENTIFIER</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">RAW</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print the results as a single dictionary.&#39;</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">attributes</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">raw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the attributes of one or more nodes.&quot;&quot;&quot;</span>
    <span class="n">echo_node_dict</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;extras&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">DICT_KEYS</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">DICT_FORMAT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">IDENTIFIER</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">RAW</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print the results as a single dictionary.&#39;</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">extras</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">raw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the extras of one or more nodes.&quot;&quot;&quot;</span>
    <span class="n">echo_node_dict</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">use_attrs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--depth&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show children of nodes up to given depth&#39;</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">deprecated_command</span><span class="p">(</span><span class="s1">&#39;This command will be removed in `aiida-core==2.0.0`.&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tree</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show a tree of nodes starting from a given node.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="kn">import</span> <span class="n">LinkType</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.ascii_vis</span> <span class="kn">import</span> <span class="n">NodeTreePrinter</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">NodeTreePrinter</span><span class="o">.</span><span class="n">print_node_tree</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">__members__</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">DRY_RUN</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">FORCE</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">graph_traversal_rules</span><span class="p">(</span><span class="n">GraphTraversalRules</span><span class="o">.</span><span class="n">DELETE</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">node_delete</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete nodes from the provenance graph.</span>

<span class="sd">    This will not only delete the nodes explicitly provided via the command line, but will also include</span>
<span class="sd">    the nodes necessary to keep a consistent graph, according to the rules outlined in the documentation.</span>
<span class="sd">    You can modify some of those rules using options of this command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.manage.database.delete.nodes</span> <span class="kn">import</span> <span class="n">delete_nodes</span>

    <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">node_pks_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>

    <span class="n">delete_nodes</span><span class="p">(</span><span class="n">node_pks_to_delete</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;rehash&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-e&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--entry-point&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">PluginParamType</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;aiida.calculations&#39;</span><span class="p">,</span> <span class="s1">&#39;aiida.data&#39;</span><span class="p">,</span> <span class="s1">&#39;aiida.workflows&#39;</span><span class="p">),</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only include nodes that are class or sub class of the class identified by this entry point.&#39;</span>
<span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">FORCE</span><span class="p">()</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">rehash</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">,</span> <span class="n">force</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recompute the hash for nodes in the database.</span>

<span class="sd">    The set of nodes that will be rehashed can be filtered by their identifier and/or based on their class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">Data</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">,</span> <span class="n">QueryBuilder</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;This command will recompute and overwrite the hashes of all nodes.&#39;</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;Note that this can take a lot of time for big databases.&#39;</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">confirm_message</span> <span class="o">=</span> <span class="s1">&#39;Do you want to continue?&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">confirm_message</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">click</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;Migration aborted, the data has not been affected.&#39;</span><span class="p">)</span>

    <span class="c1"># If no explicit entry point is defined, rehash all nodes, which are either Data nodes or ProcessNodes</span>
    <span class="k">if</span> <span class="n">entry_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entry_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">to_hash</span> <span class="o">=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">)]</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_hash</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_point</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">)</span>
        <span class="n">to_hash</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">to_hash</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;no matching nodes found&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">click</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="n">to_hash</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rehashing Nodes:&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">iter_hash</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="ow">in</span> <span class="n">iter_hash</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">rehash</span><span class="p">()</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> nodes re-hashed.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">))</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;graph&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">verdi_graph</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create visual representations of the provenance graph.&quot;&quot;&quot;</span>


<span class="nd">@verdi_graph</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;generate&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODE</span><span class="p">(</span><span class="s1">&#39;root_node&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-l&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--link-types&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;The link types to include: &#39;</span>
        <span class="s2">&quot;&#39;data&#39; includes only &#39;input_calc&#39; and &#39;create&#39; links (data provenance only), &quot;</span>
        <span class="s2">&quot;&#39;logic&#39; includes only &#39;input_work&#39; and &#39;return&#39; links (logical provenance only).&quot;</span>
    <span class="p">),</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;logic&#39;</span><span class="p">])</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--identifier&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the type of identifier to use within the node text&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--ancestor-depth&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The maximum depth when recursing upwards, if not set it will recurse to the end.&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">IntRange</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--descendant-depth&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The maximum depth when recursing through the descendants. If not set it will recurse to the end.&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">IntRange</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--process-out&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show outgoing links for all processes.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--process-in&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show incoming links for all processes.&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print verbose information of the graph traversal.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-e&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--engine&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The graphviz engine, e.g. &#39;dot&#39;, &#39;circo&#39;, ... &quot;</span>
    <span class="s1">&#39;(see http://www.graphviz.org/doc/info/output.html)&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--output-format&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output format used for rendering (&#39;pdf&#39;, &#39;png&#39;, etc.).&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--show&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Open the rendered result with the default application.&#39;</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">graph_generate</span><span class="p">(</span>
    <span class="n">root_node</span><span class="p">,</span> <span class="n">link_types</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">ancestor_depth</span><span class="p">,</span> <span class="n">descendant_depth</span><span class="p">,</span> <span class="n">process_out</span><span class="p">,</span> <span class="n">process_in</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span>
    <span class="n">output_format</span><span class="p">,</span> <span class="n">show</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a graph from a ROOT_NODE (specified by pk or uuid).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="kn">from</span> <span class="nn">aiida.tools.visualization</span> <span class="kn">import</span> <span class="n">Graph</span>
    <span class="n">print_func</span> <span class="o">=</span> <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">link_types</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="p">(),</span> <span class="s1">&#39;logic&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;input_work&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">),</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;input_calc&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">)}[</span><span class="n">link_types</span><span class="p">]</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;Initiating graphviz engine: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">engine</span><span class="p">))</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">node_id_type</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;Recursing ancestors, max depth=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ancestor_depth</span><span class="p">))</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">recurse_ancestors</span><span class="p">(</span>
        <span class="n">root_node</span><span class="p">,</span>
        <span class="n">depth</span><span class="o">=</span><span class="n">ancestor_depth</span><span class="p">,</span>
        <span class="n">link_types</span><span class="o">=</span><span class="n">link_types</span><span class="p">,</span>
        <span class="n">annotate_links</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span>
        <span class="n">include_process_outputs</span><span class="o">=</span><span class="n">process_out</span><span class="p">,</span>
        <span class="n">print_func</span><span class="o">=</span><span class="n">print_func</span>
    <span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;Recursing descendants, max depth=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">descendant_depth</span><span class="p">))</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">recurse_descendants</span><span class="p">(</span>
        <span class="n">root_node</span><span class="p">,</span>
        <span class="n">depth</span><span class="o">=</span><span class="n">descendant_depth</span><span class="p">,</span>
        <span class="n">link_types</span><span class="o">=</span><span class="n">link_types</span><span class="p">,</span>
        <span class="n">annotate_links</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span>
        <span class="n">include_process_inputs</span><span class="o">=</span><span class="n">process_in</span><span class="p">,</span>
        <span class="n">print_func</span><span class="o">=</span><span class="n">print_func</span>
    <span class="p">)</span>
    <span class="n">output_file_name</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">graphviz</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root_node</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">engine</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;Output file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file_name</span><span class="p">))</span>


<span class="nd">@verdi_node</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">verdi_comment</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Inspect, create and manage node comments.&quot;&quot;&quot;</span>


<span class="nd">@verdi_comment</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">NODES</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">comment_add</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a comment to one or more nodes.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">multi_line_input</span><span class="o">.</span><span class="n">edit_comment</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;comment added to </span><span class="si">{}</span><span class="s1"> nodes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)))</span>


<span class="nd">@verdi_comment</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;comment_id&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;COMMENT_ID&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">comment_update</span><span class="p">(</span><span class="n">comment_id</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update a comment of a node.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.comments</span> <span class="kn">import</span> <span class="n">Comment</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">comment_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotExistent</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">MultipleObjectsError</span><span class="p">):</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;comment&lt;</span><span class="si">{}</span><span class="s1">&gt; not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment_id</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">multi_line_input</span><span class="o">.</span><span class="n">edit_comment</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="n">comment</span><span class="o">.</span><span class="n">set_content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;comment&lt;</span><span class="si">{}</span><span class="s1">&gt; updated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment_id</span><span class="p">))</span>


<span class="nd">@verdi_comment</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">USER</span><span class="p">()</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">comment_show</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the comments of one or multiple nodes.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;* Comments for Node&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

        <span class="n">all_comments</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_comments</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="p">[</span><span class="n">comment</span> <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">all_comments</span> <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">comments</span><span class="p">:</span>
                <span class="n">valid_users</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">all_comments</span><span class="p">))</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;no comments found for user </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;valid users found for Node&lt;</span><span class="si">{}</span><span class="s1">&gt;: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">valid_users</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">all_comments</span>

        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">comment_msg</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;Comment&lt;</span><span class="si">{}</span><span class="s1">&gt; for Node&lt;</span><span class="si">{}</span><span class="s1">&gt; by </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
                <span class="s1">&#39;Created on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">ctime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)),</span>
                <span class="s1">&#39;Last modified on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)),</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comment_msg</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;no comments found&#39;</span><span class="p">)</span>


<span class="nd">@verdi_comment</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">FORCE</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;COMMENT_ID&#39;</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">comment_remove</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove a comment of a node.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.comments</span> <span class="kn">import</span> <span class="n">Comment</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="s1">&#39;Are you sure you want to remove comment&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment</span><span class="p">),</span> <span class="n">abort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotExistent</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;failed to remove comment&lt;</span><span class="si">{}</span><span class="s1">&gt;: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;removed comment&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment</span><span class="p">))</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>