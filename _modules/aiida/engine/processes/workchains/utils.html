

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.engine.processes.workchains.utils &mdash; AiiDA 1.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
        <script src="../../../../../_static/togglebutton.js"></script>
        <script src="../../../../../_static/contentui.js"></script>
        <script >var togglebuttonSelector = '.toggle';</script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/about.html">What is AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../howto/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plugins/placeholder.html">Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../development/placeholder.html">Placeholder</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.engine.processes.workchains.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.engine.processes.workchains.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Utilities for `WorkChain` implementations.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getfullargspec</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span>  <span class="c1"># pylint: disable=no-name-in-module</span>
<span class="kn">from</span> <span class="nn">wrapt</span> <span class="kn">import</span> <span class="n">decorator</span>

<span class="kn">from</span> <span class="nn">..exit_code</span> <span class="kn">import</span> <span class="n">ExitCode</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ProcessHandlerReport&#39;</span><span class="p">,</span> <span class="s1">&#39;process_handler&#39;</span><span class="p">)</span>

<span class="n">ProcessHandlerReport</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ProcessHandlerReport&#39;</span><span class="p">,</span> <span class="s1">&#39;do_break exit_code&#39;</span><span class="p">)</span>
<span class="n">ProcessHandlerReport</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ExitCode</span><span class="p">())</span>
<span class="sd">&quot;&quot;&quot;A namedtuple to define a process handler report for a :class:`aiida.engine.BaseRestartWorkChain`.</span>

<span class="sd">This namedtuple should be returned by a process handler of a work chain instance if the condition of the handler was</span>
<span class="sd">met by the completed process. If no further handling should be performed after this method the `do_break` field should</span>
<span class="sd">be set to `True`. If the handler encountered a fatal error and the work chain needs to be terminated, an `ExitCode` with</span>
<span class="sd">non-zero exit status can be set. This exit code is what will be set on the work chain itself. This works because the</span>
<span class="sd">value of the `exit_code` field returned by the handler, will in turn be returned by the `inspect_process` step and</span>
<span class="sd">returning a non-zero exit code from any work chain step will instruct the engine to abort the work chain.</span>

<span class="sd">:param do_break: boolean, set to `True` if no further process handlers should be called, default is `False`</span>
<span class="sd">:param exit_code: an instance of the :class:`~aiida.engine.processes.exit_code.ExitCode` tuple. If not explicitly set,</span>
<span class="sd">    the default `ExitCode` will be instantiated which has status `0` meaning that the work chain step will be considered</span>
<span class="sd">    successful and the work chain will continue to the next step.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="process_handler"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.workchains.html#aiida.engine.process_handler">[docs]</a><span class="k">def</span> <span class="nf">process_handler</span><span class="p">(</span><span class="n">wrapped</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">exit_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to register a :class:`~aiida.engine.BaseRestartWorkChain` instance method as a process handler.</span>

<span class="sd">    The decorator will validate the `priority` and `exit_codes` optional keyword arguments and then add itself as an</span>
<span class="sd">    attribute to the `wrapped` instance method. This is used in the `inspect_process` to return all instance methods of</span>
<span class="sd">    the class that have been decorated by this function and therefore are considered to be process handlers.</span>

<span class="sd">    Requirements on the function signature of process handling functions. The function to which the decorator is applied</span>
<span class="sd">    needs to take two arguments:</span>

<span class="sd">        * `self`: This is the instance of the work chain itself</span>
<span class="sd">        * `node`: This is the process node that finished and is to be investigated</span>

<span class="sd">    The function body typically consists of a conditional that will check for a particular problem that might have</span>
<span class="sd">    occurred for the sub process. If a particular problem is handled, the process handler should return an instance of</span>
<span class="sd">    the :class:`aiida.engine.ProcessHandlerReport` tuple. If no other process handlers should be considered, the set</span>
<span class="sd">    `do_break` attribute should be set to `True`. If the work chain is to be aborted entirely, the `exit_code` of the</span>
<span class="sd">    report can be set to an `ExitCode` instance with a non-zero status.</span>

<span class="sd">    :param cls: the work chain class to register the process handler with</span>
<span class="sd">    :param priority: optional integer that defines the order in which registered handlers will be called during the</span>
<span class="sd">        handling of a finished process. Higher priorities will be handled first. Default value is `0`. Multiple handlers</span>
<span class="sd">        with the same priority is allowed, but the order of those is not well defined.</span>
<span class="sd">    :param exit_codes: single or list of `ExitCode` instances. If defined, the handler will return `None` if the exit</span>
<span class="sd">        code set on the `node` does not appear in the `exit_codes`. This is useful to have a handler called only when</span>
<span class="sd">        the process failed with a specific exit code.</span>
<span class="sd">    :param enabled: boolean, by default True, which will cause the handler to be called during `inspect_process`. When</span>
<span class="sd">        set to `False`, the handler will be skipped. This static value can be overridden on a per work chain instance</span>
<span class="sd">        basis through the input `handler_overrides`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wrapped</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">process_handler</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span> <span class="n">exit_codes</span><span class="o">=</span><span class="n">exit_codes</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">enabled</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;first argument can only be an instance method, use keywords for decorator arguments.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;the `priority` keyword should be an integer.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exit_codes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exit_codes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">exit_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">exit_codes</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">exit_codes</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exit_code</span><span class="p">,</span> <span class="n">ExitCode</span><span class="p">)</span> <span class="k">for</span> <span class="n">exit_code</span> <span class="ow">in</span> <span class="n">exit_codes</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`exit_codes` keyword should be an instance of `ExitCode` or list thereof.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">enabled</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;the `enabled` keyword should be a boolean.&#39;</span><span class="p">)</span>

    <span class="n">handler_args</span> <span class="o">=</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">handler_args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;process handler `</span><span class="si">{}</span><span class="s1">` has invalid signature: should be (self, node)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wrapped</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="n">wrapped</span><span class="o">.</span><span class="n">decorator</span> <span class="o">=</span> <span class="n">process_handler</span>
    <span class="n">wrapped</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>
    <span class="n">wrapped</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span>

    <span class="nd">@decorator</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># When the handler will be called by the `BaseRestartWorkChain` it will pass the node as the only argument</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">exit_codes</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">exit_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">exit_code</span><span class="o">.</span><span class="n">status</span> <span class="k">for</span> <span class="n">exit_code</span> <span class="ow">in</span> <span class="n">exit_codes</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Append the name and return value of the current process handler to the `considered_handlers` extra.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">considered_handlers</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_considered_handlers_extra</span><span class="p">,</span> <span class="p">[])</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="n">current_process</span> <span class="o">=</span> <span class="n">considered_handlers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># The extra was never initialized, so we skip this functionality</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Append the name of the handler to the last list in `considered_handlers` and save it</span>
            <span class="n">serialized</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">serialized</span><span class="p">,</span> <span class="n">ProcessHandlerReport</span><span class="p">):</span>
                <span class="n">serialized</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;do_break&#39;</span><span class="p">:</span> <span class="n">serialized</span><span class="o">.</span><span class="n">do_break</span><span class="p">,</span> <span class="s1">&#39;exit_status&#39;</span><span class="p">:</span> <span class="n">serialized</span><span class="o">.</span><span class="n">exit_code</span><span class="o">.</span><span class="n">status</span><span class="p">}</span>
            <span class="n">current_process</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">wrapped</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">serialized</span><span class="p">))</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_considered_handlers_extra</span><span class="p">,</span> <span class="n">considered_handlers</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>